<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gest√£o Firebase</title>
    <style>
       @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');

body {
    font-family: 'Roboto', Arial, sans-serif;
    margin: 0;
    padding: 0;
    background-color: #f8f9fa; 
    color: #343a40; 
    line-height: 1.7;
    font-size: 17px; 
}
.container {
    width: 85%; 
    margin: 30px auto; 
    padding: 30px; 
    background: #fff;
    box-shadow: 0 5px 15px rgba(0,0,0,0.12); 
    border-radius: 12px; 
}
h1 {
    color: #0056b3; 
    text-align: center;
    margin-bottom: 30px;
    font-size: 2.8em; 
    font-weight: 700;
}
h2 { 
    color: #17a2b8; 
    margin-top: 25px;
    margin-bottom: 20px;
    font-size: 2em; 
    border-bottom: 2px solid #e9ecef;
    padding-bottom: 10px;
    font-weight: 500;
}

/* Main Navigation Styles */
.main-navigation {
    display: flex;
    margin-bottom: 20px;
    border-bottom: 2px solid #0056b3;
}
.main-nav-button {
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-bottom: none;
    outline: none;
    cursor: pointer;
    padding: 15px 25px;
    font-size: 1.2em;
    font-weight: 500;
    color: #495057;
    transition: background-color 0.3s ease, color 0.3s ease;
    border-radius: 8px 8px 0 0;
    margin-right: 5px;
}
.main-nav-button:hover {
    background-color: #e9ecef;
    color: #0056b3;
}
.main-nav-button.active {
    background-color: #007bff;
    color: white;
    border-color: #007bff #007bff #007bff; 
    position: relative;
}
.panel-content {
    display: none; 
}
.panel-content.active {
    display: block; 
    animation: fadeInPanel 0.4s ease-in-out;
}
@keyframes fadeInPanel {
    from { opacity: 0; }
    to { opacity: 1; }
}

.tab-navigation {
    display: flex; 
    flex-wrap: wrap; 
    border-bottom: 1px solid #dee2e6;
    margin-bottom: 30px; 
}
.tab-navigation button { 
    background-color: #e9ecef; 
    border: none;
    outline: none;
    cursor: pointer;
    padding: 14px 18px; 
    transition: background-color 0.3s ease, color 0.3s ease;
    font-size: 1.05em; 
    border-radius: 8px 8px 0 0; 
    margin-right: 5px; 
    margin-bottom: -1px; 
    color: #495057; 
    font-weight: 500;
}
.tab-navigation button:hover {
    background-color: #ced4da; 
    color: #0056b3;
}
.tab-navigation button.active {
    background-color: #007bff; 
    color: white;
    border-bottom: 1px solid #007bff; 
    box-shadow: 0 -2px 5px rgba(0,0,0,0.1) inset;
}
.tab-content {
    display: none; 
    padding: 20px; 
    border-top: none;
    animation: fadeIn 0.5s ease-in-out;
}
@keyframes fadeIn {
    from {opacity: 0; transform: translateY(10px);}
    to {opacity: 1; transform: translateY(0);}
}
form { 
    display: flex;
    flex-direction: column;
    gap: 25px; 
}
form div, form fieldset { 
    display: flex;
    flex-direction: column;
    position: relative;
    gap: 8px; 
}

label { 
    margin-bottom: 0px; 
    font-weight: 500;
    font-size: 1.1em; 
    color: #495057;
}
input[type="text"], input[type="url"], input[type="number"], select { 
    padding: 12px; 
    border: 1px solid #ced4da;
    border-radius: 6px;
    font-size: 1em; 
    box-sizing: border-box;
    transition: border-color 0.2s ease, box-shadow 0.2s ease;
}
input[type="text"]:focus, input[type="url"]:focus, input[type="number"]:focus, select:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
    outline: none;
}
input[readonly] { 
    background-color: #e9ecef;
    cursor: not-allowed;
}
button[type="submit"], .action-button { 
    background-color: #28a745;
    color: white;
    padding: 12px 20px; 
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 1.05em; 
    align-self: flex-start;
    transition: background-color 0.2s ease, transform 0.1s ease;
    font-weight: 500;
}
button[type="submit"]:hover, .action-button:hover {
    background-color: #218838;
    transform: translateY(-1px);
}
button[type="submit"]:active, .action-button:active {
    transform: translateY(0px);
}
.action-button.secondary { background-color: #6c757d; }
.action-button.secondary:hover { background-color: #5a6268; }
.action-button.danger { background-color: #dc3545; }
.action-button.danger:hover { background-color: #c82333; }

.status-message {
    margin-top: 20px; padding: 15px; border-radius: 6px; font-size: 1em; font-weight: 500;
}
.status-message.success { background-color: #d1e7dd; color: #0f5132; border: 1px solid #badbcc; }
.status-message.error { background-color: #f8d7da; color: #842029; border: 1px solid #f5c2c7; }

.suggestions-container {
    position: absolute; border: 1px solid #ced4da; border-top: none; z-index: 99;
    top: 100%; left: 0; right: 0; background-color: white; max-height: 180px;
    overflow-y: auto; box-shadow: 0 4px 8px rgba(0,0,0,0.1); border-radius: 0 0 6px 6px;
}
.suggestion-item { 
    padding: 8px 12px; 
    cursor: pointer;
    border-bottom: 1px solid #eee;
    font-size: 1em;
    display: flex; 
    flex-direction: row;
    align-items: center; 
}
.suggestion-item img {
    width: 30px; 
    height: 30px;
    object-fit: contain; 
    margin-right: 10px;
    border-radius: 50%; 
    border: 1px solid #ddd; 
    flex-shrink: 0;
}
.suggestion-item span {
    flex-grow: 1;
    line-height: 1.4;
}
.suggestion-item:last-child { border-bottom: none; }
.suggestion-item:hover { background-color: #f0f8ff; color: #0056b3; }

.modal {
    display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%;
    overflow: auto; background-color: rgba(0,0,0,0.5);
}
.modal-content {
    background-color: #fefefe; margin: 10% auto; padding: 25px; border: 1px solid #888;
    width: 60%; max-width: 550px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.2);
}
.modal-content h3 { margin-top: 0; color: #007bff; }
.modal-close-btn {
    color: #aaa; float: right; font-size: 28px; font-weight: bold;
}
.modal-close-btn:hover, .modal-close-btn:focus { color: black; text-decoration: none; cursor: pointer; }

.form-grid { display: grid; grid-template-columns: 1fr; gap: 15px; }
 @media (min-width: 600px) {
    .form-grid.two-cols { grid-template-columns: 1fr 1fr; }
    .form-grid.three-cols { grid-template-columns: repeat(3, 1fr); align-items: end; }
}

/* === STYLES SPECIFIC TO #tabJogo, #tabEditJogo & OTHER EDIT TABS === */
#tabJogo h2, .tab-content[id^="tabEdit"] h2 { 
    color: #007bff; 
    border-bottom: 2px solid #007bff;
    padding-bottom: 15px;
    margin-bottom: 30px;
    font-size: 2.2em; 
}

#tabJogo form, .tab-content[id^="tabEdit"] form {
    gap: 30px; 
}

#tabJogo fieldset, .tab-content[id^="tabEdit"] fieldset {
    border: 1px solid #ced4da; 
    border-radius: 10px; 
    padding: 25px; 
    background-color: #ffffff; 
    box-shadow: 0 2px 8px rgba(0,0,0,0.07); 
    transition: all 0.3s ease-in-out;
}

/* Specific fieldset styling for Criar Jogo and Editar Jogo */
#tabJogo fieldset:nth-of-type(1), #tabEditJogo fieldset:nth-of-type(1) { 
    border-left: 5px solid #17a2b8; 
    background-color: #f8f9fa; 
}
#tabJogo fieldset:nth-of-type(1) legend, #tabEditJogo fieldset:nth-of-type(1) legend { color: #17a2b8; }

#tabJogo fieldset:nth-of-type(2), #tabEditJogo fieldset:nth-of-type(2) { 
    border-left: 5px solid #28a745; 
}
#tabJogo fieldset:nth-of-type(2) legend, #tabEditJogo fieldset:nth-of-type(2) legend { color: #28a745; }

#tabJogo fieldset#fieldsetPlacarStats, #tabEditJogo fieldset#fieldsetEditPlacarStats { 
    border-left: 5px solid #ffc107; 
    background-color: #fdf8e2; 
}
#tabJogo fieldset#fieldsetPlacarStats.open, #tabEditJogo fieldset#fieldsetEditPlacarStats.open {
    background-color: #f8f9fa; 
}
#tabJogo fieldset#fieldsetPlacarStats legend#legendPlacarStats, 
#tabEditJogo fieldset#fieldsetEditPlacarStats legend#legendEditPlacarStats { 
    color: #c89400; 
}

#tabJogo fieldset:nth-of-type(4), #tabEditJogo fieldset:nth-of-type(4) { /* Plantel fieldset */
    border-left: 5px solid #6f42c1; 
}
#tabJogo fieldset:nth-of-type(4) legend, #tabEditJogo fieldset:nth-of-type(4) legend { color: #6f42c1; }


/* General legend and label styling for Jogo and Edit tabs */
#tabJogo legend, .tab-content[id^="tabEdit"] legend {
    font-size: 1.6em; 
    font-weight: 600; 
    padding: 0 15px;
    margin-bottom: 15px; 
}

#tabJogo label, .tab-content[id^="tabEdit"] label {
    font-size: 1.2em; 
    color: #343a40; 
    margin-bottom: 8px; 
}

/* Input styling for Jogo and Edit tabs */
#tabJogo input[type="text"], #tabJogo input[type="url"], #tabJogo input[type="number"], #tabJogo select,
.tab-content[id^="tabEdit"] input[type="text"], .tab-content[id^="tabEdit"] input[type="url"], 
.tab-content[id^="tabEdit"] input[type="number"], .tab-content[id^="tabEdit"] select {
    font-size: 1.1em; 
    padding: 14px; 
    border-radius: 6px;
    border: 1px solid #bcc3ca; 
}

/* Input with background image (player image, country flag) */
#tabJogo .player-input-grid input[type="text"].has-image-bg,
#goalDetailModal input[type="text"].has-image-bg,
.tab-content[id^="tabEdit"] input[type="text"].has-image-bg,
#tabEditJogo .player-input-grid input[type="text"].has-image-bg {
    background-repeat: no-repeat;
    background-position: 8px center;  
    background-size: 28px 28px;    
    padding-left: 42px !important;  
}

/* Readonly input styling for Jogo and Edit tabs */
#tabJogo input[readonly], .tab-content[id^="tabEdit"] input[readonly] {
    background-color: #e2e6ea; 
    color: #495057;
    font-weight: 500;
}

/* Minute input styling for Jogo and Edit Jogo */
#tabJogo .minute-input-group, #tabEditJogo .minute-input-group {
    display: flex; align-items: center; gap: 12px; margin-bottom: 15px;
}
#tabJogo .minute-input-group input[type="number"], #tabEditJogo .minute-input-group input[type="number"] { flex-grow: 1; }

#tabJogo .minute-list, #tabEditJogo .minute-list { list-style: none; padding: 0; }

#tabJogo .minute-list-item, #tabEditJogo .minute-list-item {
    padding: 10px 15px; font-size: 1em; 
    border-radius: 4px; margin-bottom: 5px;
    display: flex; justify-content: space-between; align-items: center; 
    transition: background-color 0.3s ease, border-left-color 0.3s ease; 
    border-left: 5px solid transparent; 
}
#tabJogo .minute-text-scorer-container, #tabEditJogo .minute-text-scorer-container { 
    display: flex; align-items: center; flex-grow: 1; margin-right: 8px; flex-wrap: nowrap;     
}
#tabJogo .minute-text-scorer-container .minute-value, #tabJogo .minute-text-scorer-container .scorer-name,
#tabEditJogo .minute-text-scorer-container .minute-value, #tabEditJogo .minute-text-scorer-container .scorer-name {
    white-space: nowrap; 
}
#tabJogo .minute-list-item .minute-value, #tabEditJogo .minute-list-item .minute-value { 
    font-weight: 500; cursor: pointer; text-decoration: underline;
}
#tabJogo .minute-list-item .scorer-name, #tabEditJogo .minute-list-item .scorer-name { 
    font-style: italic; color: #555; margin-left: 8px; font-size: 0.9em;
}
#tabJogo .minute-list-item .remove-minute-btn, #tabEditJogo .minute-list-item .remove-minute-btn {
    background: none; border: none; color: #dc3545; cursor: pointer;
    font-weight: bold; font-size: 1.3em; flex-shrink: 0; 
}
/* Status classes for minute items */
.minute-list-item.status-pending { background-color: #fde0e0; border-left-color: #dc3545; }
.minute-list-item.status-pending .minute-value { color: #721c24; }
.minute-list-item.status-incomplete { background-color: #fff9e0; border-left-color: #ffc107; }
.minute-list-item.status-incomplete .minute-value { color: #856404; }
.minute-list-item.status-complete { background-color: #d4edda; border-left-color: #28a745; }
.minute-list-item.status-complete .minute-value { color: #155724; }

/* Submit button for Jogo forms */
#tabJogo > form > button[type="submit"], #tabEditJogo > form > button[type="submit"] {
    padding: 15px 30px; font-size: 1.25em; background-color: #0069d9; 
    font-weight: 600; width: auto; align-self: center; margin-top: 20px; 
}
#tabJogo > form > button[type="submit"]:hover, #tabEditJogo > form > button[type="submit"]:hover { background-color: #0056b3; }

/* Suggestions container for Jogo and Edit tabs */
#tabJogo .suggestions-container, .tab-content[id^="tabEdit"] .suggestions-container { 
    border-color: #adb5bd; font-size: 1em; 
}
#tabJogo .suggestion-item, .tab-content[id^="tabEdit"] .suggestion-item { 
    padding: 12px; 
}

/* Player input grid for Criar Jogo and Editar Jogo */
#tabJogo .player-input-grid, #tabEditJogo .player-input-grid {
    display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
    gap: 18px; margin-bottom: 20px; 
}
#tabJogo .player-input-wrapper, #tabEditJogo .player-input-wrapper {
    position: relative; display: flex; align-items: center;
}
#tabJogo .player-input-grid input[type="text"], #tabEditJogo .player-input-grid input[type="text"] { 
    background-color: #fff; width: 100%; box-sizing: border-box;
}
/* Clear button for player inputs */
.player-input-clear-btn {
    position: absolute; right: 8px; top: 50%; transform: translateY(-50%);
    background: none; border: none; color: #888; font-size: 1.4em; 
    font-weight: bold; cursor: pointer; padding: 0 5px; line-height: 1;
    display: none; z-index: 2; 
}
.player-input-clear-btn:hover { color: #333; }

/* Padding adjustment for inputs with clear button and/or image */
#tabJogo .player-input-grid input[type="text"].has-image-bg.has-clear-btn,
#goalDetailModal input[type="text"].has-image-bg.has-clear-btn,
.tab-content[id^="tabEdit"] input[type="text"].has-image-bg.has-clear-btn,
#tabEditJogo .player-input-grid input[type="text"].has-image-bg.has-clear-btn {
    padding-right: 35px !important; 
}
#tabJogo .player-input-grid input[type="text"].has-clear-btn:not(.has-image-bg),
#goalDetailModal input[type="text"].has-clear-btn:not(.has-image-bg),
.tab-content[id^="tabEdit"] input[type="text"].has-clear-btn:not(.has-image-bg),
#tabEditJogo .player-input-grid input[type="text"].has-clear-btn:not(.has-image-bg) {
    padding-right: 35px !important; 
}

/* Goal Detail Modal specific styling */
#goalDetailModal .modal-content { padding: 30px; }
#goalDetailModal .modal-content label { font-size: 1.15em; }
#goalDetailModal .modal-content input[type="text"],
#goalDetailModal .modal-content select,
#goalDetailModal #goalZoneGridContainer { font-size: 1.05em; }

#goalZoneGridContainer {
    display: grid; grid-template-columns: repeat(3, 1fr);
    grid-template-rows: repeat(3, 55px); gap: 6px;
    margin-top: 5px; border: 1px solid #ccc; padding: 5px; border-radius: 4px;
}
.goal-zone-cell {
    display: flex; align-items: center; justify-content: center;
    border: 1px solid #ddd; background-color: #f9f9f9; cursor: pointer;
    font-size: 0.9em; text-align: center; transition: background-color 0.2s;
}
.goal-zone-cell:hover { background-color: #e9e9e9; }
.goal-zone-cell.selected { background-color: #007bff; color: white; border-color: #0056b3; }

/* Toggle legend for collapsible fieldsets (Criar Jogo and Editar Jogo) */
.toggle-legend { /* Applied to legendPlacarStats and legendEditPlacarStats */
    cursor: pointer; display: flex; justify-content: space-between; 
    align-items: center; width: 100%; 
    padding-left: 0; /* Reset padding as fieldset has it */
    padding-right: 0; /* Reset padding */
    box-sizing: border-box; 
}
.toggle-legend .toggle-indicator { font-weight: bold; font-size: 1.2em; margin-left: 10px; }

fieldset.open .toggle-content { animation: slideDown 0.3s ease-out; }
@keyframes slideDown {
    from { opacity: 0; transform: translateY(-10px); max-height: 0; }
    to { opacity: 1; transform: translateY(0); max-height: 1500px; } /* Adjust max-height as needed */
}

/* Styles for Edit Item Selector (generic for all edit tabs) */
.edit-item-selector {
    margin-bottom: 25px;
    padding: 20px;
    background-color: #f9f9f9;
    border-radius: 8px;
    border: 1px solid #e0e0e0;
}
.edit-item-selector label {
    font-size: 1.2em;
    font-weight: 500;
    margin-bottom: 10px;
    display: block;
}

/* Edit specific fieldset styling (example for Clube, adapt for others) */
#tabEditClube form#formEditClube fieldset,
#tabEditPosicao form#formEditPosicao fieldset,
#tabEditJogador form#formEditJogador fieldset,
#tabEditPais form#formEditPais fieldset { 
    /* Note: #tabEditJogo uses its own fieldset styling similar to #tabJogo */
    border-left: 5px solid #fd7e14; /* Orange accent for these edit forms */
}
#tabEditClube form#formEditClube legend,
#tabEditPosicao form#formEditPosicao legend,
#tabEditJogador form#formEditJogador legend,
#tabEditPais form#formEditPais legend {
    color: #fd7e14;
}

.form-actions { /* For grouping save/delete buttons in edit forms */
    display: flex;
    gap: 15px;
    margin-top: 10px;
    align-items: center; 
}
    </style>
</head>
<body>

    <div class="container">
        <h1>Painel de Gest√£o Firebase</h1>

        <div class="main-navigation">
            <button id="showCreatePanelBtn" class="main-nav-button active">Criar</button>
            <button id="showEditPanelBtn" class="main-nav-button">Editar</button>
        </div>

        <div id="createPanel" class="panel-content active">
            <div class="tab-navigation" id="createTabNavigation">
                <button class="tab-button" onclick="openTab(event, 'tabJogo', 'createPanel')">Criar Jogo</button>
                <button class="tab-button" onclick="openTab(event, 'tabClube', 'createPanel')">Criar Clube</button>
                <button class="tab-button" onclick="openTab(event, 'tabPosicao', 'createPanel')">Criar Posi√ß√£o</button>
                <button class="tab-button" onclick="openTab(event, 'tabJogador', 'createPanel')">Criar Jogador</button>
                <button class="tab-button" onclick="openTab(event, 'tabPais', 'createPanel')">Criar Pa√≠s</button>
            </div>

            <!-- Tab Criar Jogo -->
            <div id="tabJogo" class="tab-content">
                <h2>Criar Novo Jogo</h2>
                <form id="formJogo">
                    <fieldset> 
                        <legend>Informa√ß√µes Gerais do Jogo</legend>
                        <div class="form-grid two-cols">
                            <div>
                                <label for="jogoTemporada">Temporada:</label>
                                <select id="jogoTemporada" required></select>
                            </div>
                            <div>
                                <label for="jogoJornada">Jornada:</label>
                                <select id="jogoJornada" required></select>
                            </div>
                            <div>
                                <label for="jogoClubeCasa">Clube Casa:</label>
                                <input type="text" id="jogoClubeCasa" autocomplete="off" placeholder="Pesquisar clube..." required>
                                <div id="clubeCasaSuggestions" class="suggestions-container" style="display: none;"></div>
                            </div>
                            <div>
                                <label for="jogoClubeFora">Clube Fora:</label>
                                <input type="text" id="jogoClubeFora" autocomplete="off" placeholder="Pesquisar clube..." required>
                                <div id="clubeForaSuggestions" class="suggestions-container" style="display: none;"></div>
                            </div>
                        </div>
                    </fieldset>

                    <fieldset> 
                        <legend>Golos do Sporting</legend>
                        <div class="form-grid two-cols">
                            <div>
                                <label for="jogoMinutoGoloMarcado">Minuto do Golo Marcado (Sporting):</label>
                                <div class="minute-input-group">
                                    <input type="number" id="jogoMinutoGoloMarcadoInput" placeholder="Ex: 17" min="1">
                                    <button type="button" class="action-button secondary" id="addMinutoGoloMarcadoBtn">Adicionar</button>
                                </div>
                                <ul id="listaMinutosGolosMarcados" class="minute-list"></ul>
                            </div>
                            <div>
                                <label for="jogoMinutoGoloSofrido">Minuto do Golo Sofrido (pelo Sporting):</label>
                                <div class="minute-input-group">
                                    <input type="number" id="jogoMinutoGoloSofridoInput" placeholder="Ex: 48" min="1">
                                    <button type="button" class="action-button secondary" id="addMinutoGoloSofridoBtn">Adicionar</button>
                                </div>
                                <ul id="listaMinutosGolosSofridos" class="minute-list"></ul>
                            </div>
                        </div>
                    </fieldset>

                    <fieldset id="fieldsetPlacarStats"> 
                        <legend id="legendPlacarStats" class="toggle-legend">
                            Placar e Estat√≠sticas (Autom√°tico)
                            <span class="toggle-indicator">[+]</span>
                        </legend>
                        <div class="toggle-content" style="display: none;">
                            <div style="margin-bottom: 15px;">
                                <label for="jogoNomeJogo">Nome do Jogo (Autom√°tico):</label>
                                <input type="text" id="jogoNomeJogo" readonly>
                            </div>
                            <div class="form-grid three-cols">
                                <div><label for="jogoGMCasa">Golos Marcados Equipa da Casa:</label><input type="text" id="jogoGMCasa" readonly></div>
                                <div><label for="jogoResultadoFinal">Resultado Final:</label><input type="text" id="jogoResultadoFinal" readonly></div>
                                <div><label for="jogoGMFora">Golos Marcados Equipa de Fora:</label><input type="text" id="jogoGMFora" readonly></div>
                            </div>
                             <div class="form-grid two-cols" style="margin-top: 15px;">
                                <div><label for="jogoGSCasa">Golos Sofridos Equipa da Casa:</label><input type="text" id="jogoGSCasa" readonly></div>
                                <div><label for="jogoGSFora">Golos Sofridos Equipa de Fora:</label><input type="text" id="jogoGSFora" readonly></div>
                                
                                <div><label for="jogoMarcados1P">Golos Marcados Sporting (1¬™ Parte):</label><input type="text" id="jogoMarcados1P" readonly></div>
                                <div><label for="jogoMarcados2P">Golos Marcados Sporting (2¬™ Parte):</label><input type="text" id="jogoMarcados2P" readonly></div>
                                <div><label for="jogoSofridos1P">Golos Sofridos Sporting (1¬™ Parte):</label><input type="text" id="jogoSofridos1P" readonly></div>
                                <div><label for="jogoSofridos2P">Golos Sofridos Sporting (2¬™ Parte):</label><input type="text" id="jogoSofridos2P" readonly></div>
                                <div><label for="jogoEstado">Estado (Resultado Sporting):</label><input type="text" id="jogoEstado" readonly></div>
                            </div>
                        </div>
                    </fieldset>

                    <fieldset> 
                        <legend>Plantel</legend>
                        <div>
                            <label>11 Inicial (11 jogadores):</label>
                            <div id="jogo11InicialContainer" class="player-input-grid"></div>
                        </div>
                        <div>
                            <label>Suplentes (11 jogadores):</label>
                            <div id="jogoSuplentesContainer" class="player-input-grid"></div>
                        </div>
                    </fieldset>

                    <button type="submit">Criar Jogo</button>
                </form>
                <div id="statusJogo" class="status-message"></div>
            </div>

            <!-- Tab Criar Clube -->
            <div id="tabClube" class="tab-content">
                <h2>Criar Novo Clube</h2>
                <form id="formClube">
                    <div><label for="clubeNome">Nome do Clube:</label><input type="text" id="clubeNome" required></div>
                    <div><label for="clubeLogo">Link do Logo:</label><input type="url" id="clubeLogo" required></div>
                    <div><label for="clubeRegiao">Regi√£o:</label><input type="text" id="clubeRegiao" required></div>
                    <div><label for="clubeCidade">Cidade:</label><input type="text" id="clubeCidade" required></div>
                    <button type="submit">Adicionar Clube</button>
                </form>
                <div id="statusClube" class="status-message"></div>
            </div>

            <!-- Tab Criar Posi√ß√£o -->
            <div id="tabPosicao" class="tab-content">
                <h2>Criar Nova Posi√ß√£o</h2>
                <form id="formPosicao">
                    <div><label for="posicaoAbreviacao">Abrevia√ß√£o (ex: DC, PL):</label><input type="text" id="posicaoAbreviacao" required maxlength="3"></div>
                    <div><label for="posicaoGenericaForm">Posi√ß√£o Gen√©rica (ex: Defesa, Avan√ßado):</label><input type="text" id="posicaoGenericaForm" required></div>
                    <button type="submit">Adicionar Posi√ß√£o</button>
                </form>
                <div id="statusPosicao" class="status-message"></div>
            </div>

            <!-- Tab Criar Jogador -->
            <div id="tabJogador" class="tab-content">
                <h2>Criar Novo Jogador</h2>
                <form id="formJogador">
                    <div><label for="jogadorNome">Nome do Jogador:</label><input type="text" id="jogadorNome" required></div>
                    <div><label for="jogadorImagem">Link da Imagem:</label><input type="url" id="jogadorImagem" required></div>
                    <div>
                        <label for="jogadorPosEspecifica">Posi√ß√£o Espec√≠fica:</label>
                        <select id="jogadorPosEspecifica" required><option value="">A carregar posi√ß√µes...</option></select>
                    </div>
                    <div><label for="jogadorPosGenerica">Posi√ß√£o Gen√©rica (Autom√°tico):</label><input type="text" id="jogadorPosGenerica" readonly></div>
                    <div>
                        <label for="jogadorPaisNome">Nome do Pa√≠s:</label>
                        <input type="text" id="jogadorPaisNome" autocomplete="off" placeholder="Comece a digitar..." required>
                        <div id="paisSuggestions" class="suggestions-container" style="display: none;"></div>
                    </div>
                    <button type="submit">Adicionar Jogador</button>
                </form>
                <div id="statusJogador" class="status-message"></div>
            </div>

            <!-- Tab Criar Pa√≠s -->
            <div id="tabPais" class="tab-content">
                <h2>Criar Novo Pa√≠s</h2>
                <form id="formPais">
                    <div><label for="paisNome">Nome do Pa√≠s:</label><input type="text" id="paisNome" required></div>
                    <div><label for="paisBandeira">Link da Bandeira:</label><input type="url" id="paisBandeira" required></div>
                    <div>
                        <label for="paisContinenteSelect">Continente:</label>
                        <select id="paisContinenteSelect" required>
                            <option value="">A carregar continentes...</option>
                        </select>
                    </div>
                    <button type="submit">Adicionar Pa√≠s</button>
                </form>
                <div id="statusPais" class="status-message"></div>
            </div>
        </div> <!-- End of #createPanel -->


        <div id="editPanel" class="panel-content">
            <div class="tab-navigation" id="editTabNavigation">
                <button class="tab-button" onclick="openTab(event, 'tabEditClube', 'editPanel')">Editar Clube</button>
                <button class="tab-button" onclick="openTab(event, 'tabEditPosicao', 'editPanel')">Editar Posi√ß√£o</button>
                <button class="tab-button" onclick="openTab(event, 'tabEditJogador', 'editPanel')">Editar Jogador</button>
                <button class="tab-button" onclick="openTab(event, 'tabEditPais', 'editPanel')">Editar Pa√≠s</button>
                <button class="tab-button" onclick="openTab(event, 'tabEditJogo', 'editPanel')">Editar Jogo</button>
            </div>

            <!-- Tab Editar Clube -->
            <div id="tabEditClube" class="tab-content">
                <h2>Editar Clube Existente</h2>
                <div class="edit-item-selector">
                    <label for="selectEditClubeNome">Procurar Clube para Editar:</label>
                    <input type="text" id="selectEditClubeNome" autocomplete="off" placeholder="Comece a digitar nome do clube...">
                    <div id="selectEditClubeSuggestions" class="suggestions-container" style="display: none;"></div>
                </div>

                <form id="formEditClube" style="display: none;">
                    <fieldset>
                        <legend>Detalhes do Clube</legend>
                        <div><label for="editClubeNome">Nome do Clube (ID - N√£o edit√°vel):</label><input type="text" id="editClubeNome" readonly></div>
                        <div><label for="editClubeLogo">Link do Logo:</label><input type="url" id="editClubeLogo" required></div>
                        <div><label for="editClubeRegiao">Regi√£o:</label><input type="text" id="editClubeRegiao" required></div>
                        <div><label for="editClubeCidade">Cidade:</label><input type="text" id="editClubeCidade" required></div>
                    </fieldset>
                    <div class="form-actions">
                        <button type="submit" id="saveEditClubeBtn" class="action-button">Guardar Altera√ß√µes</button>
                        <button type="button" id="deleteClubeBtn" class="action-button danger">Eliminar Clube</button>
                    </div>
                </form>
                <div id="statusEditClube" class="status-message"></div>
            </div>

            <!-- Tab Editar Posi√ß√£o -->
            <div id="tabEditPosicao" class="tab-content">
                <h2>Editar Posi√ß√£o Existente</h2>
                <div class="edit-item-selector">
                    <label for="selectEditPosicaoInput">Procurar Posi√ß√£o para Editar:</label>
                    <input type="text" id="selectEditPosicaoInput" autocomplete="off" placeholder="Comece a digitar abrevia√ß√£o ou nome...">
                    <div id="selectEditPosicaoSuggestions" class="suggestions-container" style="display: none;"></div>
                </div>
                <form id="formEditPosicao" style="display: none;">
                    <fieldset>
                        <legend>Detalhes da Posi√ß√£o</legend>
                        <div><label for="editPosicaoAbreviacao">Abrevia√ß√£o (ID - N√£o edit√°vel):</label><input type="text" id="editPosicaoAbreviacao" readonly></div>
                        <div><label for="editPosicaoGenericaForm">Posi√ß√£o Gen√©rica:</label><input type="text" id="editPosicaoGenericaForm" required></div>
                    </fieldset>
                    <div class="form-actions">
                        <button type="submit" id="saveEditPosicaoBtn" class="action-button">Guardar Altera√ß√µes</button>
                        <button type="button" id="deletePosicaoBtn" class="action-button danger">Eliminar Posi√ß√£o</button>
                    </div>
                </form>
                <div id="statusEditPosicao" class="status-message"></div>
            </div>

            <!-- Tab Editar Jogador -->
            <div id="tabEditJogador" class="tab-content">
                <h2>Editar Jogador Existente</h2>
                <p>Funcionalidade de Editar Jogador a ser implementada.</p>
                <!-- Search bar and form will go here -->
                <div id="statusEditJogador" class="status-message"></div>
            </div>

            <!-- Tab Editar Pa√≠s -->
            <div id="tabEditPais" class="tab-content">
                <h2>Editar Pa√≠s Existente</h2>
                <p>Funcionalidade de Editar Pa√≠s a ser implementada.</p>
                <!-- Search bar and form will go here -->
                <div id="statusEditPais" class="status-message"></div>
            </div>

           <!-- Tab Editar Jogo -->
           <div id="tabEditJogo" class="tab-content">
            <h2>Editar Jogo Existente</h2>
            <p>Funcionalidade de Editar Jogo a ser implementada.</p> <!-- REMOVA ESTA LINHA -->
            
            <!-- A barra de pesquisa e o formul√°rio de edi√ß√£o do jogo devem estar aqui -->
            <div class="edit-item-selector">
                <label for="selectEditJogoInput">Procurar Jogo para Editar:</label>
                <input type="text" id="selectEditJogoInput" autocomplete="off" placeholder="Nome Jogo - Temporada - Jornada...">
                <div id="selectEditJogoSuggestions" class="suggestions-container" style="display: none;"></div>
            </div>
            <form id="formEditJogo" style="display:none;">
                <!-- Fieldsets e inputs para editar o jogo ir√£o aqui, conforme definido no HTML anterior -->
                </form>
            <div id="statusEditJogo" class="status-message"></div>
        </div>

    </div> <!-- End of .container -->

    <!-- Modal for Goal Details -->
    <div id="goalDetailModal" class="modal">
        <div class="modal-content">
            <span class="modal-close-btn" id="closeGoalDetailModalBtn">√ó</span>
            <h3 id="goalDetailModalTitle">Detalhes do Golo</h3>
            <form id="formGoalDetail">
                <input type="hidden" id="goalDetailType">
                <input type="hidden" id="goalDetailMinute">
                
                <div id="goalDetailScorerSection">
                    <label for="goalDetailJogador">Marcador (Jogador do Sporting):</label>
                    <input type="text" id="goalDetailJogador" class="has-image-bg" autocomplete="off" placeholder="Pesquisar jogador...">
                    <div id="goalDetailJogadorSuggestions" class="suggestions-container" style="display: none;"></div>
                </div>
                
                <div>
                    <label for="goalDetailZonaGrid">Zona do Golo:</label>
                    <div id="goalZoneGridContainer"></div>
                    <input type="hidden" id="selectedGoalZoneHidden">
                </div>

                <div id="goalDetailAssistenciaSection" style="margin-top:15px;">
                    <label for="goalDetailAssistencia">Assist√™ncia (Jogador do Sporting):</label>
                    <input type="text" id="goalDetailAssistencia" class="has-image-bg" autocomplete="off" placeholder="Pesquisar jogador...">
                    <div id="goalDetailAssistenciaSuggestions" class="suggestions-container" style="display: none;"></div>
                </div>
                <button type="button" id="saveGoalDetailBtn" class="action-button" style="margin-top:20px;">Guardar Detalhes</button>
            </form>
        </div>
    </div>

    // <script type="module">

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, collection, getDocs, serverTimestamp, addDoc, query, where, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        // Firebase Initialization
        const firebaseConfig = {
            apiKey: "AIzaSyASIFSwhZj8B4ON6fVGjNixgLW-CL39CnI",
            authDomain: "sporting-stats.firebaseapp.com",
            projectId: "sporting-stats",
            storageBucket: "sporting-stats.firebasestorage.app",
            messagingSenderId: "584175657940",
            appId: "1:584175657940:web:7e57b0b83f2b22646d6c41"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // --- GLOBAL CACHES & STATE ---
        let posicoesMap = new Map();
        let allPosicoesArray = []; // { id, abreviacao, posicao_generica, display }
        let allPaisesData = []; // {id(nome), nome, bandeira, continente}
        let allPaisesSimpleList = []; // Just names for "Criar Jogador"
        let allContinentesSet = new Set();
        let allClubes = []; // { id, nome, logo, regiao, cidade }
        let allJogadores = []; // { id(nome_jogador), nome, imagem_link, ...}
        let allJogosCache = []; // {id, nomeJogo, temporada, jornada, displayString, ...full data}
        
        // "Criar Jogo" specific state
        let minutosGolosMarcados = [];
        let minutosGolosSofridos = [];
        
        // "Editar Jogo" specific state
        let editMinutosGolosMarcados = [];
        let editMinutosGolosSofridos = [];
        let currentEditingJogoId = null;
        let currentEditingJogoData = null;
        
        const goalZoneNames = [
            "Esquerda Cima", "Meio Cima", "Direita Cima",
            "Esquerda Centro", "Meio Centro", "Direita Centro",
            "Esquerda Baixo", "Meio Baixo", "Direita Baixo"
        ];
        const sportingCanonicoNomeDb = "Sporting CP";
        const sportingCanonicoNomesInput = ["Sporting CP", "Sporting"];
        
        // --- DOM ELEMENTS - MAIN NAVIGATION & PANELS ---
        const mainCreateBtn = document.getElementById('showCreatePanelBtn');
        const mainEditBtn = document.getElementById('showEditPanelBtn');
        const createPanel = document.getElementById('createPanel');
        const editPanel = document.getElementById('editPanel');
        let activePanelId = 'createPanel';
        
        // --- DOM ELEMENTS - "CRIAR" FORMS (Selected) ---
        const formJogo = document.getElementById('formJogo');
        const jogoTemporadaSelect = document.getElementById('jogoTemporada');
        const jogoJornadaSelect = document.getElementById('jogoJornada');
        const jogoClubeCasaInput = document.getElementById('jogoClubeCasa');
        const clubeCasaSuggestions = document.getElementById('clubeCasaSuggestions');
        const jogoClubeForaInput = document.getElementById('jogoClubeFora');
        const clubeForaSuggestions = document.getElementById('clubeForaSuggestions');
        const jogoMinutoGoloMarcadoInput = document.getElementById('jogoMinutoGoloMarcadoInput');
        const addMinutoGoloMarcadoBtn = document.getElementById('addMinutoGoloMarcadoBtn');
        const listaMinutosGolosMarcadosEl = document.getElementById('listaMinutosGolosMarcados');
        const jogoMinutoGoloSofridoInput = document.getElementById('jogoMinutoGoloSofridoInput');
        const addMinutoGoloSofridoBtn = document.getElementById('addMinutoGoloSofridoBtn');
        const listaMinutosGolosSofridosEl = document.getElementById('listaMinutosGolosSofridos');
        const jogoNomeJogoOutput = document.getElementById('jogoNomeJogo');
        const jogoGMCasaOutput = document.getElementById('jogoGMCasa');
        const jogoResultadoFinalOutput = document.getElementById('jogoResultadoFinal');
        const jogoGMForaOutput = document.getElementById('jogoGMFora');
        const jogoGSCasaOutput = document.getElementById('jogoGSCasa');
        const jogoGSForaOutput = document.getElementById('jogoGSFora');
        const jogoMarcados1POutput = document.getElementById('jogoMarcados1P');
        const jogoMarcados2POutput = document.getElementById('jogoMarcados2P');
        const jogoSofridos1POutput = document.getElementById('jogoSofridos1P');
        const jogoSofridos2POutput = document.getElementById('jogoSofridos2P');
        const jogoEstadoOutput = document.getElementById('jogoEstado');
        const jogo11InicialContainer = document.getElementById('jogo11InicialContainer');
        const jogoSuplentesContainer = document.getElementById('jogoSuplentesContainer');
        
        
        const formClube = document.getElementById('formClube');
        const clubeNomeInput = document.getElementById('clubeNome');
        const clubeLogoInput = document.getElementById('clubeLogo');
        const clubeRegiaoInput = document.getElementById('clubeRegiao');
        const clubeCidadeInput = document.getElementById('clubeCidade');
        
        const formPosicao = document.getElementById('formPosicao');
        const posicaoAbreviacaoInput = document.getElementById('posicaoAbreviacao');
        const posicaoGenericaFormInput = document.getElementById('posicaoGenericaForm');
        
        const formJogador = document.getElementById('formJogador');
        const jogadorNomeInput = document.getElementById('jogadorNome');
        const jogadorImagemInput = document.getElementById('jogadorImagem');
        const jogadorPosEspecificaDropdown = document.getElementById('jogadorPosEspecifica');
        const jogadorPosGenericaInput = document.getElementById('jogadorPosGenerica');
        const jogadorPaisNomeInput = document.getElementById('jogadorPaisNome');
        const paisSuggestionsContainer = document.getElementById('paisSuggestions');
        
        const formPais = document.getElementById('formPais');
        const paisNomeInput = document.getElementById('paisNome');
        const paisBandeiraInput = document.getElementById('paisBandeira');
        const paisContinenteSelect = document.getElementById('paisContinenteSelect');
        
        // --- DOM ELEMENTS - GOAL DETAIL MODAL ---
        const goalDetailModal = document.getElementById('goalDetailModal');
        const closeGoalDetailModalBtn = document.getElementById('closeGoalDetailModalBtn');
        const goalDetailModalTitle = document.getElementById('goalDetailModalTitle');
        const formGoalDetail = document.getElementById('formGoalDetail');
        const goalDetailContextInput = document.getElementById('goalDetailContext');
        const goalDetailTypeInput = document.getElementById('goalDetailType');
        const goalDetailMinuteInput = document.getElementById('goalDetailMinute');
        const goalDetailScorerSection = document.getElementById('goalDetailScorerSection');
        const goalDetailJogadorInput = document.getElementById('goalDetailJogador');
        const goalDetailJogadorSuggestions = document.getElementById('goalDetailJogadorSuggestions');
        const goalZoneGridContainer = document.getElementById('goalZoneGridContainer');
        const selectedGoalZoneHidden = document.getElementById('selectedGoalZoneHidden');
        const goalDetailAssistenciaSection = document.getElementById('goalDetailAssistenciaSection');
        const goalDetailAssistenciaInput = document.getElementById('goalDetailAssistencia');
        const goalDetailAssistenciaSuggestions = document.getElementById('goalDetailAssistenciaSuggestions');
        const saveGoalDetailBtn = document.getElementById('saveGoalDetailBtn');
        
        // --- DOM ELEMENTS - "EDITAR CLUBE" ---
        const selectEditClubeNomeInput = document.getElementById('selectEditClubeNome');
        const selectEditClubeSuggestionsContainer = document.getElementById('selectEditClubeSuggestions');
        const formEditClube = document.getElementById('formEditClube');
        const editClubeNomeInput = document.getElementById('editClubeNome');
        const editClubeLogoInput = document.getElementById('editClubeLogo');
        const editClubeRegiaoInput = document.getElementById('editClubeRegiao');
        const editClubeCidadeInput = document.getElementById('editClubeCidade');
        const deleteClubeBtn = document.getElementById('deleteClubeBtn');
        let currentEditingClubId = null;
        
        // --- DOM ELEMENTS - "EDITAR POSI√á√ÉO" ---
        const selectEditPosicaoInput = document.getElementById('selectEditPosicaoInput');
        const selectEditPosicaoSuggestions = document.getElementById('selectEditPosicaoSuggestions');
        const formEditPosicao = document.getElementById('formEditPosicao');
        const editPosicaoAbreviacaoInput = document.getElementById('editPosicaoAbreviacao'); // Note: ID was editPosicaoAbreviacao in HTML
        const editPosicaoGenericaFormInput = document.getElementById('editPosicaoGenericaForm'); // Note: ID was editPosicaoGenericaForm in HTML
        const deletePosicaoBtn = document.getElementById('deletePosicaoBtn');
        let currentEditingPosicaoId = null;
        
        // --- DOM ELEMENTS - "EDITAR JOGADOR" ---
        const selectEditJogadorInput = document.getElementById('selectEditJogadorInput');
        const selectEditJogadorSuggestions = document.getElementById('selectEditJogadorSuggestions');
        const formEditJogador = document.getElementById('formEditJogador');
        const editJogadorNomeInput = document.getElementById('editJogadorNome');
        const editJogadorImagemInput = document.getElementById('editJogadorImagem');
        const editJogadorPosEspecificaDropdown = document.getElementById('editJogadorPosEspecifica');
        const editJogadorPosGenericaInput = document.getElementById('editJogadorPosGenerica');
        const editJogadorPaisNomeInput = document.getElementById('editJogadorPaisNome');
        const editJogadorPaisSuggestions = document.getElementById('editJogadorPaisSuggestions');
        const deleteJogadorBtn = document.getElementById('deleteJogadorBtn');
        let currentEditingJogadorId = null;
        
        // --- DOM ELEMENTS - "EDITAR PA√çS" ---
        const selectEditPaisInput = document.getElementById('selectEditPaisInput');
        const selectEditPaisSuggestions = document.getElementById('selectEditPaisSuggestions');
        const formEditPais = document.getElementById('formEditPais');
        const editPaisNomeInput = document.getElementById('editPaisNome');
        const editPaisBandeiraInput = document.getElementById('editPaisBandeira');
        const editPaisContinenteSelect = document.getElementById('editPaisContinenteSelect');
        const deletePaisBtn = document.getElementById('deletePaisBtn');
        let currentEditingPaisId = null;
        
        // --- DOM ELEMENTS - "EDITAR JOGO" ---
        const selectEditJogoInput = document.getElementById('selectEditJogoInput');
        const selectEditJogoSuggestions = document.getElementById('selectEditJogoSuggestions');
        const formEditJogo = document.getElementById('formEditJogo');
        const editJogoTemporadaInput = document.getElementById('editJogoTemporada');
        const editJogoJornadaInput = document.getElementById('editJogoJornada');
        const editJogoClubeCasaInput = document.getElementById('editJogoClubeCasa');
        const editJogoClubeForaInput = document.getElementById('editJogoClubeFora');
        const editJogoMinutoGoloMarcadoInput = document.getElementById('editJogoMinutoGoloMarcadoInput');
        const addEditMinutoGoloMarcadoBtn = document.getElementById('addEditMinutoGoloMarcadoBtn');
        const editListaMinutosGolosMarcadosEl = document.getElementById('editListaMinutosGolosMarcados');
        const editJogoMinutoGoloSofridoInput = document.getElementById('editJogoMinutoGoloSofridoInput');
        const addEditMinutoGoloSofridoBtn = document.getElementById('addEditMinutoGoloSofridoBtn');
        const editListaMinutosGolosSofridosEl = document.getElementById('editListaMinutosGolosSofridos');
        const editJogoNomeJogoOutput = document.getElementById('editJogoNomeJogo');
        const editJogoGMCasaOutput = document.getElementById('editJogoGMCasa');
        const editJogoResultadoFinalOutput = document.getElementById('editJogoResultadoFinal');
        const editJogoGMForaOutput = document.getElementById('editJogoGMFora');
        const editJogoGSCasaOutput = document.getElementById('editJogoGSCasa');
        const editJogoGSForaOutput = document.getElementById('editJogoGSFora');
        const editJogoMarcados1POutput = document.getElementById('editJogoMarcados1P');
        const editJogoMarcados2POutput = document.getElementById('editJogoMarcados2P');
        const editJogoSofridos1POutput = document.getElementById('editJogoSofridos1P');
        const editJogoSofridos2POutput = document.getElementById('editJogoSofridos2P');
        const editJogoEstadoOutput = document.getElementById('editJogoEstado');
        const editJogo11InicialContainer = document.getElementById('editJogo11InicialContainer');
        const editJogoSuplentesContainer = document.getElementById('editJogoSuplentesContainer');
        const deleteEditJogoBtn = document.getElementById('deleteEditJogoBtn');
        
        // --- UTILITY FUNCTIONS ---
        function showStatus(elementId, message, isSuccess) {
            const statusEl = document.getElementById(elementId);
            if (!statusEl) { console.warn("Status element not found:", elementId); return; }
            statusEl.textContent = message;
            statusEl.className = 'status-message ' + (isSuccess ? 'success' : 'error');
            setTimeout(() => { if(statusEl) {statusEl.textContent = ''; statusEl.className = 'status-message'; }}, 5000);
        }
        
        function setupSuggestionHandler(inputElement, suggestionsContainer, dataArray, displayField, imageField = null, clearBtnElement = null, onSuggestionClick = null, dataItemToText = null) {
            if (!inputElement || !suggestionsContainer) {
                return;
            }
            inputElement.addEventListener('input', function() {
                const inputText = this.value.toLowerCase();
                suggestionsContainer.innerHTML = '';
                if (!inputText.trim()) {
                    suggestionsContainer.style.display = 'none';
                    if (!(imageField && inputElement.dataset.fixedBg === "true")) {
                        inputElement.style.backgroundImage = 'none';
                        inputElement.classList.remove('has-image-bg');
                    }
                    if (clearBtnElement) {
                        clearBtnElement.style.display = 'none'; inputElement.classList.remove('has-clear-btn');
                    }
                    return;
                }
                const filteredData = dataArray.filter(item => {
                    let itemTextForSearch;
                    if (dataItemToText) { itemTextForSearch = dataItemToText(item); } 
                    else { itemTextForSearch = (typeof item === 'string' ? item : item[displayField]); }
                    return itemTextForSearch ? itemTextForSearch.toLowerCase().includes(inputText) : false;
                });
        
                if (filteredData.length > 0) {
                    filteredData.slice(0, 10).forEach(item => {
                        const suggestionItemDiv = document.createElement('div');
                        suggestionItemDiv.classList.add('suggestion-item');
                        let itemTextForDisplay;
                        if (dataItemToText) { itemTextForDisplay = dataItemToText(item); } 
                        else { itemTextForDisplay = (typeof item === 'string' ? item : item[displayField]); }
        
                        if (imageField && typeof item === 'object' && item[imageField]) {
                            const img = document.createElement('img'); img.src = item[imageField]; img.alt = itemTextForDisplay;
                            img.onerror = function() { this.style.display='none'; };
                            suggestionItemDiv.appendChild(img);
                        }
                        const textSpan = document.createElement('span'); textSpan.textContent = itemTextForDisplay;
                        suggestionItemDiv.appendChild(textSpan);
                        suggestionItemDiv.addEventListener('click', function() {
                            inputElement.value = (typeof item === 'string' ? item : item[displayField]); 
                            suggestionsContainer.style.display = 'none';
                            if (imageField && typeof item === 'object' && item[imageField]) {
                                inputElement.style.backgroundImage = `url('${item[imageField]}')`;
                                inputElement.classList.add('has-image-bg');
                                inputElement.dataset.fixedBg = "true"; 
                            } else {
                                inputElement.style.backgroundImage = 'none';
                                inputElement.classList.remove('has-image-bg');
                                delete inputElement.dataset.fixedBg;
                            }
                            if (clearBtnElement) {
                                clearBtnElement.style.display = 'block'; inputElement.classList.add('has-clear-btn');
                            }
                            inputElement.dispatchEvent(new Event('change', { bubbles: true }));
                            if (onSuggestionClick && typeof onSuggestionClick === 'function') { onSuggestionClick(item); }
                        });
                        suggestionsContainer.appendChild(suggestionItemDiv);
                    });
                    suggestionsContainer.style.display = 'block';
                } else { suggestionsContainer.style.display = 'none'; }
            });
            document.addEventListener('click', (e) => {
                if (suggestionsContainer && !inputElement.contains(e.target) && !suggestionsContainer.contains(e.target)) {
                    suggestionsContainer.style.display = 'none';
                }
            });
        }
        
        // --- MAIN NAVIGATION & TAB LOGIC ---
        function switchMainPanel(targetPanelId) {
            activePanelId = targetPanelId;
            const createNav = document.getElementById('createTabNavigation');
            const editNav = document.getElementById('editTabNavigation');
        
            if (!createPanel || !editPanel || !mainCreateBtn || !mainEditBtn || !createNav || !editNav) {
                console.error("Um ou mais elementos principais de navega√ß√£o/painel n√£o foram encontrados!");
                return;
            }
        
            if (targetPanelId === 'createPanel') {
                createPanel.classList.add('active');
                editPanel.classList.remove('active');
                mainCreateBtn.classList.add('active');
                mainEditBtn.classList.remove('active');
                const firstCreateTabButton = createNav.querySelector('.tab-button');
                if (firstCreateTabButton) {
                    const onclickAttr = firstCreateTabButton.getAttribute('onclick');
                    const match = onclickAttr.match(/openTab\s*\(\s*event\s*,\s*'([^']*)'\s*,\s*'([^']*)'\s*\)/);
                    if (match && match[1] && match[2]) {
                        openTab({currentTarget: firstCreateTabButton}, match[1], match[2]);
                    }
                }
            } else { // 'editPanel'
                editPanel.classList.add('active');
                createPanel.classList.remove('active');
                mainEditBtn.classList.add('active');
                mainCreateBtn.classList.remove('active');
                const firstEditTabButton = editNav.querySelector('.tab-button');
                 if (firstEditTabButton) {
                    const onclickAttr = firstEditTabButton.getAttribute('onclick');
                    const match = onclickAttr.match(/openTab\s*\(\s*event\s*,\s*'([^']*)'\s*,\s*'([^']*)'\s*\)/);
                    if (match && match[1] && match[2]) {
                        openTab({currentTarget: firstEditTabButton}, match[1], match[2]);
                    }
                }
            }
        }
        
        window.openTab = function(evt, tabName, panelIdForTabs) {
            var i, tabcontent, tabbuttons;
            const currentPanel = document.getElementById(panelIdForTabs);
            if (!currentPanel) { console.error("Painel n√£o encontrado em openTab:", panelIdForTabs); return; }
        
            tabcontent = currentPanel.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) { tabcontent[i].style.display = "none"; }
        
            const tabNav = currentPanel.querySelector('.tab-navigation');
            if (tabNav) {
                tabbuttons = tabNav.getElementsByClassName("tab-button");
                for (i = 0; i < tabbuttons.length; i++) { tabbuttons[i].className = tabbuttons[i].className.replace(" active", ""); }
            }
            
            const targetTabContent = currentPanel.querySelector("#" + tabName);
            if (targetTabContent) { targetTabContent.style.display = "block"; } 
            else { console.error("Target tab content not found:", "#" + tabName, "in panel:", panelIdForTabs); }
        
            let eventTargetButton = null;
            if (evt && evt.currentTarget) { 
                eventTargetButton = evt.currentTarget;
            } else if (tabNav && tabbuttons) { 
                for (i = 0; i < tabbuttons.length; i++) {
                    const onclickAttr = tabbuttons[i].getAttribute('onclick');
                    if (onclickAttr && onclickAttr.includes(`'${tabName}'`)) {
                        eventTargetButton = tabbuttons[i];
                        break;
                    }
                }
            }
            if(eventTargetButton) eventTargetButton.className += " active";
        
        
            // --- Data loading logic based on tab name and panel ---
            if (panelIdForTabs === 'createPanel') {
                if (tabName === 'tabJogador') {
                    loadPosicoesParaDropdown(jogadorPosEspecificaDropdown); 
                    loadPaisesParaSugestoes(jogadorPaisNomeInput, paisSuggestionsContainer, false); 
                } else if (tabName === 'tabPais') {
                    loadContinentesParaDropdown(paisContinenteSelect, false); 
                } else if (tabName === 'tabJogo') {
                    populateTemporadaDropdown();
                    setSuggestedJornada(); 
                    if (allClubes.length === 0) loadAllClubesData(true); 
                    else { 
                        if(jogoClubeCasaInput) setupSuggestionHandler(jogoClubeCasaInput, clubeCasaSuggestions, allClubes, 'nome', 'logo');
                        if(jogoClubeForaInput) setupSuggestionHandler(jogoClubeForaInput, clubeForaSuggestions, allClubes, 'nome', 'logo');
                    }
                    if (allJogadores.length === 0) {
                        loadAllJogadoresCache().then(() => { 
                            if (jogo11InicialContainer.children.length === 0) setupDynamicPlayerInputs_contextAware('jogo11InicialContainer', 11, 'inicial', 'create');
                            if (jogoSuplentesContainer.children.length === 0) setupDynamicPlayerInputs_contextAware('jogoSuplentesContainer', 11, 'suplente', 'create');
                            if(goalDetailJogadorInput) setupSuggestionHandler(goalDetailJogadorInput, goalDetailJogadorSuggestions, allJogadores, 'nome', 'imagem_link', null, null);
                            if(goalDetailAssistenciaInput) setupSuggestionHandler(goalDetailAssistenciaInput, goalDetailAssistenciaSuggestions, allJogadores, 'nome', 'imagem_link', null, null);
                        });
                    } else { 
                         if (jogo11InicialContainer.children.length === 0) setupDynamicPlayerInputs_contextAware('jogo11InicialContainer', 11, 'inicial', 'create');
                         if (jogoSuplentesContainer.children.length === 0) setupDynamicPlayerInputs_contextAware('jogoSuplentesContainer', 11, 'suplente', 'create');
                         if(goalDetailJogadorInput) setupSuggestionHandler(goalDetailJogadorInput, goalDetailJogadorSuggestions, allJogadores, 'nome', 'imagem_link', null, null);
                         if(goalDetailAssistenciaInput) setupSuggestionHandler(goalDetailAssistenciaInput, goalDetailAssistenciaSuggestions, allJogadores, 'nome', 'imagem_link', null, null);
                    }
                    if (goalZoneGridContainer.children.length === 0) populateGoalZoneGrid();
                }
            } else if (panelIdForTabs === 'editPanel') {
                if (tabName === 'tabEditClube') {
                    if(formEditClube) formEditClube.style.display = 'none'; 
                    if(selectEditClubeNomeInput) selectEditClubeNomeInput.value = ''; 
                    if (allClubes.length === 0) loadAllClubesData(false); else setupEditClubeSuggestions(); 
                } else if (tabName === 'tabEditPosicao') {
                    if(formEditPosicao) formEditPosicao.style.display = 'none';
                    if(selectEditPosicaoInput) selectEditPosicaoInput.value = '';
                    if (allPosicoesArray.length === 0) loadAllPosicoesData().then(setupEditPosicaoSuggestions); else setupEditPosicaoSuggestions();
                } else if (tabName === 'tabEditJogador') {
                    if(formEditJogador) formEditJogador.style.display = 'none';
                    if(selectEditJogadorInput) selectEditJogadorInput.value = '';
                    if (allJogadores.length === 0) loadAllJogadoresCache().then(setupEditJogadorSuggestions); else setupEditJogadorSuggestions();
                    loadPosicoesParaDropdown(editJogadorPosEspecificaDropdown); 
                    loadPaisesParaSugestoes(editJogadorPaisNomeInput, editJogadorPaisSuggestions, true); 
                } else if (tabName === 'tabEditPais') {
                    if(formEditPais) formEditPais.style.display = 'none';
                    if(selectEditPaisInput) selectEditPaisInput.value = '';
                    if (allPaisesData.length === 0) loadAllPaisesData(true).then(setupEditPaisSuggestions); else setupEditPaisSuggestions();
                    loadContinentesParaDropdown(editPaisContinenteSelect, true); 
                } else if (tabName === 'tabEditJogo') {
                    if(formEditJogo) formEditJogo.style.display = 'none';
                    if(selectEditJogoInput) selectEditJogoInput.value = '';
                    if(allJogosCache.length === 0) loadAllJogosCache().then(setupEditJogoSuggestions); else setupEditJogoSuggestions();
                    if(allJogadores.length === 0) loadAllJogadoresCache(); 
                    if (goalZoneGridContainer.children.length === 0) populateGoalZoneGrid();
                    if (editJogo11InicialContainer.children.length === 0) setupDynamicPlayerInputs_contextAware('editJogo11InicialContainer', 11, 'editInicial', 'edit');
                    if (editJogoSuplentesContainer.children.length === 0) setupDynamicPlayerInputs_contextAware('editJogoSuplentesContainer', 11, 'editSuplente', 'edit');
                     // Ensure suggestion handlers for goal modal are set up if players are loaded
                    if (allJogadores.length > 0) {
                        if(goalDetailJogadorInput) setupSuggestionHandler(goalDetailJogadorInput, goalDetailJogadorSuggestions, allJogadores, 'nome', 'imagem_link', null, null);
                        if(goalDetailAssistenciaInput) setupSuggestionHandler(goalDetailAssistenciaInput, goalDetailAssistenciaSuggestions, allJogadores, 'nome', 'imagem_link', null, null);
                    }
                }
            }
        };
    


        // --- DATA LOADING FUNCTIONS ---
async function loadAllJogadoresCache() {
    if (allJogadores.length > 0 && allJogadores.every(j => j.id && j.nome && j.posicao_especifica_id !== undefined)) return; // Check for more complete data
    allJogadores = []; 
    try {
        const snap = await getDocs(collection(db, "jogadores"));
        snap.forEach(s => {
            const data = s.data();
            allJogadores.push({ 
                id: s.id, // Firestore document ID (usually nome_jogador if you set it that way)
                nome: data.nome_jogador, 
                imagem_link: data.imagem_link,
                posicao_especifica_id: data.posicao_especifica_id, // Should match an 'abreviacao' from posicoes
                posicao_generica_id: data.posicao_generica_id, // Should be derived from pos_especifica
                pais_id: data.pais_id // Should match a 'nome' from paises
            });
        });
        allJogadores.sort((a, b) => (a.nome || "").localeCompare(b.nome || ""));
    } catch (e) { 
        console.error("Erro loadAllJogadoresCache: ", e); 
        if (document.getElementById('tabJogo')?.style.display === 'block') showStatus('statusJogo', 'Erro lista de jogadores.', false);
        if (document.getElementById('tabEditJogador')?.style.display === 'block') showStatus('statusEditJogador', 'Erro lista de jogadores.', false);
        if (document.getElementById('tabEditJogo')?.style.display === 'block') showStatus('statusEditJogo', 'Erro lista de jogadores.', false);
    }
}

async function loadAllPosicoesData() {
    if (allPosicoesArray.length > 0 && posicoesMap.size > 0) return;
    posicoesMap.clear(); allPosicoesArray = [];
    try {
        const querySnapshot = await getDocs(collection(db, "posicoes"));
        querySnapshot.forEach((docSnap) => {
            const data = docSnap.data();
            posicoesMap.set(data.abreviacao, data.posicao_generica);
            allPosicoesArray.push({ 
                id: docSnap.id, // Firestore document ID (abreviacao)
                abreviacao: data.abreviacao, 
                posicao_generica: data.posicao_generica,
                display: `${data.abreviacao} - ${data.posicao_generica}`
            });
        });
        allPosicoesArray.sort((a,b) => (a.abreviacao || "").localeCompare(b.abreviacao || ""));
    } catch (error) { console.error("Erro ao carregar todas as posi√ß√µes: ", error); }
}

async function loadPosicoesParaDropdown(dropdownElement) { 
    if (!dropdownElement) return;
    const isEditForm = dropdownElement.id.startsWith('editJogador');
    const genericaInput = isEditForm ? editJogadorPosGenericaInput : jogadorPosGenericaInput;

    if (posicoesMap.size === 0) await loadAllPosicoesData();

    const currentValue = dropdownElement.value;
    dropdownElement.innerHTML = '<option value="">A carregar posi√ß√µes...</option>';
    if(genericaInput) genericaInput.value = ''; 
    
    if (posicoesMap.size === 0) {
        dropdownElement.innerHTML = `<option value="">Nenhuma posi√ß√£o. Crie em "Criar Posi√ß√£o".</option>`; return;
    }
    dropdownElement.innerHTML = '<option value="">Selecione uma Posi√ß√£o</option>';
    const sortedAbreviacoes = Array.from(posicoesMap.keys()).sort();
    sortedAbreviacoes.forEach(abr => dropdownElement.add(new Option(abr, abr)));
    if (currentValue && posicoesMap.has(currentValue)) {
        dropdownElement.value = currentValue;
        if(genericaInput) genericaInput.value = posicoesMap.get(currentValue) || '';
    } else if (dropdownElement.options.length > 1) {
        dropdownElement.selectedIndex = 0;
    }
}

async function loadAllPaisesData(forEditContextOrFullLoad = false) {
    if (allPaisesData.length > 0 && (forEditContextOrFullLoad || allPaisesSimpleList.length > 0) ) return;
    
    allPaisesData = []; 
    allPaisesSimpleList = []; 
    try {
        const querySnapshot = await getDocs(collection(db, "paises"));
        querySnapshot.forEach((docSnap) => {
            const data = docSnap.data();
            allPaisesData.push({ id: docSnap.id, nome: data.nome, bandeira: data.bandeira, continente: data.continente });
            allPaisesSimpleList.push(data.nome);
        });
        allPaisesData.sort((a,b) => (a.nome || "").localeCompare(b.nome || ""));
        allPaisesSimpleList.sort();
    } catch (error) { 
        console.error("Erro ao carregar todos os pa√≠ses: ", error); 
        if (document.getElementById('tabJogador')?.style.display === 'block') showStatus('statusJogador', 'Erro ao carregar pa√≠ses.', false);
        if (document.getElementById('tabEditJogador')?.style.display === 'block') showStatus('statusEditJogador', 'Erro ao carregar pa√≠ses.', false);
        if (document.getElementById('tabEditPais')?.style.display === 'block') showStatus('statusEditPais', 'Erro ao carregar pa√≠ses.', false);
    }
}

async function loadPaisesParaSugestoes(inputElement, suggestionsContainer, forEditForm) { 
    if (!inputElement || !suggestionsContainer) return;
    const statusTarget = forEditForm ? 
        (inputElement.id.includes('editJogador') ? 'statusEditJogador' : 'statusEditPais') 
        : 'statusJogador';

    await loadAllPaisesData(forEditForm); 

    if (!forEditForm) { 
        setupSuggestionHandler(inputElement, suggestionsContainer, allPaisesSimpleList, null, null, null, null);
    } else { 
        setupSuggestionHandler(inputElement, suggestionsContainer, allPaisesData, 'nome', 'bandeira', null, 
        (selectedPais) => { 
            inputElement.value = selectedPais.nome; 
        });
    }
}

async function loadAllContinentesSet() {
    if (allContinentesSet.size > 0) return;
    allContinentesSet.clear();
    try {
        if (allPaisesData.length === 0) await loadAllPaisesData(true); 
        
        allPaisesData.forEach(pais => {
            if (pais.continente) allContinentesSet.add(pais.continente);
        });
        if (allContinentesSet.size === 0) { // Fallback if paisesData was empty or no continents
            const querySnapshot = await getDocs(collection(db, "paises"));
            querySnapshot.forEach((docSnap) => { if (docSnap.data().continente) allContinentesSet.add(docSnap.data().continente); });
        }
    } catch (error) { console.error("Erro ao carregar continentes (set): ", error); }
}

async function loadContinentesParaDropdown(selectElement, isEditContext) {
    if (!selectElement) return;
    const statusTarget = isEditContext ? 
        (selectElement.id.includes('editPais') ? 'statusEditPais' : 'statusEditJogador') 
        : 'statusPais';

    await loadAllContinentesSet(); 

    const currentValue = selectElement.value;
    selectElement.innerHTML = '<option value="">A carregar continentes...</option>';
    
    if (allContinentesSet.size === 0) {
        selectElement.innerHTML = '<option value="">Nenhum continente. Adicione um pa√≠s com continente.</option>';
    } else {
        selectElement.innerHTML = '<option value="">Selecione um Continente</option>';
        Array.from(allContinentesSet).sort().forEach(c => selectElement.add(new Option(c,c)));
    }
    if (currentValue && Array.from(selectElement.options).some(opt => opt.value === currentValue)) {
        selectElement.value = currentValue;
    } else if (selectElement.options.length > 1) {
        selectElement.selectedIndex = 0;
    }
}

async function loadAllClubesData(forCriarJogoContext) { 
    if (allClubes.length > 0) {
        if (forCriarJogoContext) {
            if(jogoClubeCasaInput) setupSuggestionHandler(jogoClubeCasaInput, clubeCasaSuggestions, allClubes, 'nome', 'logo');
            if(jogoClubeForaInput) setupSuggestionHandler(jogoClubeForaInput, clubeForaSuggestions, allClubes, 'nome', 'logo');
        } else {
            setupEditClubeSuggestions();
        }
        return;
    }
    allClubes = [];
    try {
        const snap = await getDocs(collection(db, "clubes"));
        snap.forEach(s => allClubes.push({ id: s.id, nome: s.data().nome, logo: s.data().logo, regiao: s.data().regiao, cidade: s.data().cidade }));
        allClubes.sort((a, b) => (a.nome || "").localeCompare(b.nome || ""));
        
        if (forCriarJogoContext) {
            if(jogoClubeCasaInput) setupSuggestionHandler(jogoClubeCasaInput, clubeCasaSuggestions, allClubes, 'nome', 'logo');
            if(jogoClubeForaInput) setupSuggestionHandler(jogoClubeForaInput, clubeForaSuggestions, allClubes, 'nome', 'logo');
        } else { 
            setupEditClubeSuggestions();
        }
    } catch (e) { 
        console.error("Erro loadAllClubesData: ", e); 
        const statusId = forCriarJogoContext ? 'statusJogo' : 'statusEditClube';
        showStatus(statusId, 'Erro ao carregar lista de clubes.', false); 
    }
}

async function loadAllJogosCache() {
    if (allJogosCache.length > 0) return;
    allJogosCache = [];
    try {
        const querySnapshot = await getDocs(collection(db, "jogos"));
        querySnapshot.forEach(docSnap => {
            const data = docSnap.data();
            allJogosCache.push({
                id: docSnap.id,
                nomeJogo: data.nomeJogo,
                temporada: data.temporada,
                jornada: data.jornada,
                displayString: `${data.nomeJogo || `Jogo ${docSnap.id.substring(0,5)}...`} (${data.temporada} J${data.jornada})`,
                ...data 
            });
        });
        allJogosCache.sort((a,b) => (b.temporada || "").localeCompare(a.temporada || "") || Number(b.jornada) - Number(a.jornada) || (a.nomeJogo || '').localeCompare(b.nomeJogo || ''));
    } catch (error) {
        console.error("Erro ao carregar jogos para cache:", error);
        if (document.getElementById('tabEditJogo')?.style.display === 'block') {
            showStatus('statusEditJogo', 'Erro ao carregar lista de jogos.', false);
        }
    }
}


// --- "CRIAR" FORMS LOGIC & SUBMIT HANDLERS ---
async function handleFormClubeSubmit(e) {
    e.preventDefault();
    const nome = clubeNomeInput.value.trim();
    const logo = clubeLogoInput.value.trim();
    const regiao = clubeRegiaoInput.value.trim();
    const cidade = clubeCidadeInput.value.trim();
    if (!nome || !logo || !regiao || !cidade) { showStatus('statusClube', 'Todos os campos s√£o obrigat√≥rios.', false); return; }
    try {
        await setDoc(doc(db, "clubes", nome), { nome, logo, regiao, cidade });
        showStatus('statusClube', `Clube "${nome}" adicionado!`, true); e.target.reset();
        allClubes = []; 
        if(document.getElementById('tabEditClube')?.style.display === 'block') loadAllClubesData(false);
        if(document.getElementById('tabJogo')?.style.display === 'block') loadAllClubesData(true);
    } catch (error) { showStatus('statusClube', `Erro: ${error.message}`, false); }
}

async function handleFormPosicaoSubmit(e) {
    e.preventDefault();
    const abreviacao = posicaoAbreviacaoInput.value.trim().toUpperCase();
    const posicao_generica = posicaoGenericaFormInput.value.trim();
    if (!abreviacao || !posicao_generica) { showStatus('statusPosicao', 'Todos os campos s√£o obrigat√≥rios.', false); return; }
    try {
        await setDoc(doc(db, "posicoes", abreviacao), { abreviacao, posicao_generica });
        showStatus('statusPosicao', `Posi√ß√£o "${abreviacao}" adicionada!`, true); e.target.reset();
        posicoesMap.clear(); allPosicoesArray = []; 
        if (document.getElementById('tabJogador')?.style.display === 'block') loadPosicoesParaDropdown(jogadorPosEspecificaDropdown);
        if (document.getElementById('tabEditPosicao')?.style.display === 'block') loadAllPosicoesData().then(setupEditPosicaoSuggestions);
        if (document.getElementById('tabEditJogador')?.style.display === 'block') loadPosicoesParaDropdown(editJogadorPosEspecificaDropdown);
    } catch (error) { showStatus('statusPosicao', `Erro: ${error.message}`, false); }
}

async function handleFormJogadorSubmit(e) {
    e.preventDefault();
    const nome_jogador = jogadorNomeInput.value.trim();
    const imagem_link = jogadorImagemInput.value.trim();
    const posEspecifica = jogadorPosEspecificaDropdown.value;
    const posGenerica = jogadorPosGenericaInput.value;
    const paisNomeForm = jogadorPaisNomeInput.value.trim();
    if (!nome_jogador || !imagem_link || !posEspecifica || !paisNomeForm) { showStatus('statusJogador', 'Todos os campos s√£o obrigat√≥rios.', false); return; }
    if (!posGenerica) { showStatus('statusJogador', 'Posi√ß√£o gen√©rica n√£o definida. Selecione uma posi√ß√£o espec√≠fica.', false); return; }
    
    await loadAllPaisesData(false); // Ensure allPaisesSimpleList is populated for validation
    if (!allPaisesSimpleList.includes(paisNomeForm) && allPaisesSimpleList.length > 0) {
         showStatus('statusJogador', `Pa√≠s "${paisNomeForm}" n√£o encontrado. Selecione da lista ou crie um novo.`, false); return;
    }

    try {
        await setDoc(doc(db, "jogadores", nome_jogador), { 
            nome_jogador, imagem_link, 
            posicao_especifica_id: posEspecifica, posicao_especifica_nome: posEspecifica,
            posicao_generica_id: posGenerica, posicao_generica_nome: posGenerica,
            pais_id: paisNomeForm, pais_nome: paisNomeForm 
        });
        showStatus('statusJogador', `Jogador "${nome_jogador}" adicionado!`, true); 
        e.target.reset(); 
        if(jogadorPosGenericaInput) jogadorPosGenericaInput.value = ''; 
        if(paisSuggestionsContainer) paisSuggestionsContainer.style.display = 'none'; 
        if(jogadorPaisNomeInput) { jogadorPaisNomeInput.style.backgroundImage = 'none'; jogadorPaisNomeInput.classList.remove('has-image-bg'); delete jogadorPaisNomeInput.dataset.fixedBg; }
        allJogadores = []; 
        if (document.getElementById('tabEditJogador')?.style.display === 'block') loadAllJogadoresCache().then(setupEditJogadorSuggestions);
        if (document.getElementById('tabJogo')?.style.display === 'block') loadAllJogadoresCache();
        if (document.getElementById('tabEditJogo')?.style.display === 'block') loadAllJogadoresCache();
    } catch (error) { showStatus('statusJogador', `Erro: ${error.message}`, false); }
}

async function handleFormPaisSubmit(e) { 
    e.preventDefault();
    const nome = paisNomeInput.value.trim();
    const bandeira = paisBandeiraInput.value.trim();
    const continente = paisContinenteSelect.value; 
    if (!nome || !bandeira || !continente) { showStatus('statusPais', 'Todos os campos s√£o obrigat√≥rios.', false); return; }
    try {
        await setDoc(doc(db, "paises", nome), { nome, bandeira, continente });
        showStatus('statusPais', `Pa√≠s "${nome}" adicionado!`, true); e.target.reset(); 
        if(paisContinenteSelect) paisContinenteSelect.value = ""; 
        allPaisesData = []; allPaisesSimpleList = []; allContinentesSet.clear(); 
        
        if (document.getElementById('tabJogador')?.style.display === 'block') loadPaisesParaSugestoes(jogadorPaisNomeInput, paisSuggestionsContainer, false);
        if (document.getElementById('tabEditJogador')?.style.display === 'block') loadPaisesParaSugestoes(editJogadorPaisNomeInput, editJogadorPaisSuggestions, true);
        if (document.getElementById('tabPais')?.style.display === 'block') loadContinentesParaDropdown(paisContinenteSelect, false); 
        if (document.getElementById('tabEditPais')?.style.display === 'block') {
            loadAllPaisesData(true).then(setupEditPaisSuggestions);
            loadContinentesParaDropdown(editPaisContinenteSelect, true);
        }
    } catch (error) { showStatus('statusPais', `Erro: ${error.message}`, false); }
}


// --- "CRIAR JOGO" SPECIFIC LOGIC ---
function populateTemporadaDropdown() {
    if (!jogoTemporadaSelect || jogoTemporadaSelect.options.length > 1) return;
    jogoTemporadaSelect.innerHTML = '<option value="">Selecione a Temporada</option>';
    const currentYear = new Date().getFullYear();
    for (let year = currentYear + 2; year >= 2000; year--) { // Allow one future season
        const displayTemporada = `${year-1}/${year}`;
        jogoTemporadaSelect.add(new Option(displayTemporada, displayTemporada));
    }
     // Set a reasonable default if possible (e.g., current season)
    const defaultSeason = `${currentYear-1}/${currentYear}`;
    if (Array.from(jogoTemporadaSelect.options).find(opt => opt.value === defaultSeason)) {
        jogoTemporadaSelect.value = defaultSeason;
    } else if (jogoTemporadaSelect.options.length > 1) {
        jogoTemporadaSelect.selectedIndex = 1; // Select the first actual season
    }
    setSuggestedJornada(); // Trigger jornada suggestion after setting temporada
}

async function setSuggestedJornada() {
    if (!jogoJornadaSelect || !jogoTemporadaSelect) return;
    const selectedTemporada = jogoTemporadaSelect.value;
    
    const currentJornadaVal = jogoJornadaSelect.value;
    jogoJornadaSelect.innerHTML = ''; // Clear previous options
    const defaultOption = new Option("Selecione a Jornada", "");
    jogoJornadaSelect.add(defaultOption);
    for (let i = 1; i <= 40; i++) { // Populate with standard jornada numbers
        jogoJornadaSelect.add(new Option(i.toString(), i.toString()));
    }
    // Attempt to restore previous value if it's valid
    if (currentJornadaVal && !isNaN(parseInt(currentJornadaVal)) && parseInt(currentJornadaVal) >=1 && parseInt(currentJornadaVal) <=40) {
        jogoJornadaSelect.value = currentJornadaVal;
    } else {
        jogoJornadaSelect.value = ""; // Default to placeholder
    }
    if (!selectedTemporada) { return; } 
    
    defaultOption.textContent = "A calcular..."; // Update placeholder while fetching
    try {
        const q = query(collection(db, "jogos"), where("temporada", "==", selectedTemporada));
        const querySnapshot = await getDocs(q);
        let maxJornada = 0;
        querySnapshot.forEach((doc) => {
            const data = doc.data();
            if (data.jornada != null && !isNaN(Number(data.jornada)) && Number(data.jornada) > maxJornada) {
                maxJornada = Number(data.jornada);
            }
        });
        const nextJornada = maxJornada + 1;
        const suggestedJornadaValue = Math.min(nextJornada, 40); 
        if (jogoJornadaSelect.querySelector(`option[value="${suggestedJornadaValue}"]`)) {
            jogoJornadaSelect.value = suggestedJornadaValue.toString();
        } else if (jogoJornadaSelect.options.length > 1 && !jogoJornadaSelect.value) { // If suggestion is invalid, and nothing selected
             jogoJornadaSelect.value = ""; // Keep placeholder
        }
    } catch (error) {
        console.error("Erro ao sugerir pr√≥xima jornada:", error);
        showStatus('statusJogo', 'Erro ao calcular jornada. Selecione manualmente.', false);
    } finally {
        if (defaultOption.textContent.includes("calcular")) { // Restore placeholder if it was "A calcular..."
             defaultOption.textContent = "Selecione a Jornada";
        }
    }
}

async function handleFormJogoSubmit(e) {
    e.preventDefault(); const statusEl = 'statusJogo';
    const temporada = jogoTemporadaSelect.value;
    const jornada = jogoJornadaSelect.value; 
    const clubeCasaNomeForm = jogoClubeCasaInput.value.trim(); 
    const clubeForaNomeForm = jogoClubeForaInput.value.trim(); 
    
    const isSportingCasa = sportingCanonicoNomesInput.map(n => n.toLowerCase()).includes(clubeCasaNomeForm.toLowerCase());
    const isSportingFora = sportingCanonicoNomesInput.map(n => n.toLowerCase()).includes(clubeForaNomeForm.toLowerCase());

    if (!temporada || !jornada || !clubeCasaNomeForm || !clubeForaNomeForm) { showStatus(statusEl, 'Temporada, Jornada e Clubes s√£o obrigat√≥rios.', false); return; }
    if (!isSportingCasa && !isSportingFora) { showStatus(statusEl, `Um dos clubes deve ser ${sportingCanonicoNomesInput.join(" ou ")}. Verifique nomes.`, false); return; }
    if (clubeCasaNomeForm.toLowerCase() === clubeForaNomeForm.toLowerCase()) { showStatus(statusEl, 'Clubes da casa e de fora devem ser diferentes.', false); return; }

    const getPlantel = (containerSel) => Array.from(document.querySelectorAll(`${containerSel} input[type="text"]`))
        .map(inp => {
            const nome = inp.value.trim();
            if (!nome) return { nome: null, id: null }; 
            const jogador = allJogadores.find(j => j.nome === nome); 
            return { nome: nome, id: jogador ? jogador.id : nome }; 
        }).filter(p => p.nome); 

    const onzeInicial = getPlantel('#jogo11InicialContainer');
    const suplentes = getPlantel('#jogoSuplentesContainer');
    if (onzeInicial.length !== 11) { showStatus(statusEl, 'O 11 Inicial deve ter 11 jogadores preenchidos.', false); return; }
    
    const jogoData = {
        temporada, jornada: parseInt(jornada), 
        nomeJogo: jogoNomeJogoOutput.value, 
        clubeCasaNome: isSportingCasa ? sportingCanonicoNomeDb : clubeCasaNomeForm, 
        clubeForaNome: isSportingFora ? sportingCanonicoNomeDb : clubeForaNomeForm, 
        sportingCasa: isSportingCasa,
        golosMarcadosSportingMinutos: minutosGolosMarcados.map(g => ({ minute: g.minute, details: g.details || {} })),
        golosSofridosSportingMinutos: minutosGolosSofridos.map(g => ({ minute: g.minute, details: g.details || {} })),
        resultadoFinal: jogoResultadoFinalOutput.value, 
        resultadoGMCasa: parseInt(jogoGMCasaOutput.value) || 0, 
        resultadoGMFora: parseInt(jogoGMForaOutput.value) || 0,
        sportingGolosMarcados1P: parseInt(jogoMarcados1POutput.value) || 0, 
        sportingGolosMarcados2P: parseInt(jogoMarcados2POutput.value) || 0,
        sportingGolosSofridos1P: parseInt(jogoSofridos1POutput.value) || 0, 
        sportingGolosSofridos2P: parseInt(jogoSofridos2POutput.value) || 0,
        resultadoEstadoSporting: jogoEstadoOutput.value, 
        onzeInicial: onzeInicial, suplentes: suplentes, dataCriacao: serverTimestamp()
    };

    try {
        const batch = writeBatch(db);
        const jogoDocRef = doc(collection(db, "jogos")); // Auto-generate ID for new game
        batch.set(jogoDocRef, jogoData);

        const equipaAdversaria = isSportingCasa ? jogoData.clubeForaNome : jogoData.clubeCasaNome;
        minutosGolosMarcados.forEach(golo => {
            const newGoalRef = doc(collection(db, "golos"));
            batch.set(newGoalRef, {
                jogoId: jogoDocRef.id, temporada: jogoData.temporada, jornada: jogoData.jornada, nomeJogo: jogoData.nomeJogo,
                minutoGolo: golo.minute, marcadorNome: golo.details?.jogadorNome || null, marcadorId: golo.details?.jogadorId || golo.details?.jogadorNome || null, 
                assistenciaNome: golo.details?.assistenciaNome || null, assistenciaId: golo.details?.assistenciaId || golo.details?.assistenciaNome || null,
                parte: golo.minute <= 45 ? "Primeira Parte" : "Segunda Parte", zonaGolo: golo.details?.zona || null,
                estado: "Marcado", equipaQueMarcou: sportingCanonicoNomeDb, tipoGolo: "MarcadoPeloSporting", dataCriacao: serverTimestamp()
            });
        });
        minutosGolosSofridos.forEach(golo => {
            const newGoalRef = doc(collection(db, "golos"));
            batch.set(newGoalRef, {
                jogoId: jogoDocRef.id, temporada: jogoData.temporada, jornada: jogoData.jornada, nomeJogo: jogoData.nomeJogo,
                minutoGolo: golo.minute, marcadorNome: null, marcadorId: null, assistenciaNome: null, assistenciaId: null,
                parte: golo.minute <= 45 ? "Primeira Parte" : "Segunda Parte", zonaGolo: golo.details?.zona || null,
                estado: "Sofrido", equipaQueMarcou: equipaAdversaria, tipoGolo: "SofridoPeloSporting", dataCriacao: serverTimestamp()
            });
        });
        
        await batch.commit();
        showStatus(statusEl, `Jogo ID: ${jogoDocRef.id} e golos adicionados!`, true);
        
        const currentTemporada = jogoTemporadaSelect.value; // Save current temporada
        e.target.reset(); 
        // Clear dynamic inputs and their visual state
        [jogo11InicialContainer, jogoSuplentesContainer].forEach(container => {
            if(container) container.querySelectorAll('.player-input-wrapper input').forEach(input => {
                input.style.backgroundImage = 'none'; input.classList.remove('has-image-bg', 'has-clear-btn'); delete input.dataset.fixedBg;
                const clearBtn = input.parentElement.querySelector('.player-input-clear-btn');
                if(clearBtn) clearBtn.style.display = 'none';
            });
        });
        minutosGolosMarcados = []; minutosGolosSofridos = [];
        renderMinuteList_contextAware(listaMinutosGolosMarcadosEl, minutosGolosMarcados, 'marcado', 'create');
        renderMinuteList_contextAware(listaMinutosGolosSofridosEl, minutosGolosSofridos, 'sofrido', 'create');
        updateCalculatedScores_contextAware('create'); 
        
        if (currentTemporada && jogoTemporadaSelect) jogoTemporadaSelect.value = currentTemporada; // Restore temporada
        else if(jogoTemporadaSelect) jogoTemporadaSelect.value = "";
        setSuggestedJornada(); // Suggest next jornada for the restored/cleared temporada
        allJogosCache = []; // Invalidate jogos cache as a new one was added
    } catch (error) { showStatus(statusEl, `Erro ao criar jogo: ${error.message}`, false); console.error(error); }
}

// --- GOAL DETAIL MODAL LOGIC (Full definitions) ---
function populateGoalZoneGrid() {
    if (!goalZoneGridContainer || goalZoneGridContainer.children.length > 0) return;
    goalZoneNames.forEach(zoneName => {
        const cell = document.createElement('div'); cell.classList.add('goal-zone-cell');
        cell.textContent = zoneName; cell.dataset.zone = zoneName;
        cell.addEventListener('click', handleZoneSelection); goalZoneGridContainer.appendChild(cell);
    });
}

function handleZoneSelection(event) {
    const selectedCell = event.target;
    goalZoneGridContainer.querySelectorAll('.goal-zone-cell').forEach(cell => cell.classList.remove('selected'));
    selectedCell.classList.add('selected'); 
    if(selectedGoalZoneHidden) selectedGoalZoneHidden.value = selectedCell.dataset.zone;
}

function openGoalDetailModal_contextAware(event) {
    const context = event.target.dataset.context || goalDetailContextInput.value; 
    const type = event.target.dataset.type; 
    const index = parseInt(event.target.dataset.index);
    
    if(goalDetailContextInput) goalDetailContextInput.value = context; 
    if(goalDetailTypeInput) goalDetailTypeInput.value = type;
    
    let minuteEntry;
    if (context === 'create') {
        minuteEntry = type === 'marcado' ? minutosGolosMarcados[index] : minutosGolosSofridos[index];
    } else { // 'edit'
        minuteEntry = type === 'marcado' ? editMinutosGolosMarcados[index] : editMinutosGolosSofridos[index];
    }
    if (!minuteEntry) { console.error("Minute entry not found for modal."); return; }

    if(goalDetailMinuteInput) goalDetailMinuteInput.value = minuteEntry.minute;
    if(goalDetailModalTitle) goalDetailModalTitle.textContent = `Detalhes do Golo - Minuto ${minuteEntry.minute} (${type === 'marcado' ? 'Marcado' : 'Sofrido'})`;
    if(formGoalDetail) formGoalDetail.reset(); 
    if(selectedGoalZoneHidden) selectedGoalZoneHidden.value = '';
    if(goalZoneGridContainer) goalZoneGridContainer.querySelectorAll('.goal-zone-cell').forEach(cell => cell.classList.remove('selected'));
    
    if(goalDetailJogadorInput) {
        goalDetailJogadorInput.style.backgroundImage = 'none'; 
        goalDetailJogadorInput.classList.remove('has-image-bg'); 
        delete goalDetailJogadorInput.dataset.fixedBg;
        goalDetailJogadorInput.value = ''; // Explicitly clear
    }
    if(goalDetailAssistenciaInput) {
        goalDetailAssistenciaInput.style.backgroundImage = 'none'; 
        goalDetailAssistenciaInput.classList.remove('has-image-bg'); 
        delete goalDetailAssistenciaInput.dataset.fixedBg;
        goalDetailAssistenciaInput.value = ''; // Explicitly clear
    }


    const details = minuteEntry.details || {};
    if(goalDetailJogadorInput) goalDetailJogadorInput.value = details.jogadorNome || '';
    if (details.jogadorNome && allJogadores.length > 0) {
        const scorerDetails = allJogadores.find(j => j.nome === details.jogadorNome);
        if (scorerDetails && scorerDetails.imagem_link && goalDetailJogadorInput) {
            goalDetailJogadorInput.style.backgroundImage = `url('${scorerDetails.imagem_link}')`;
            goalDetailJogadorInput.classList.add('has-image-bg'); 
            goalDetailJogadorInput.dataset.fixedBg = "true";
        }
    }
    if(goalDetailAssistenciaInput) goalDetailAssistenciaInput.value = details.assistenciaNome || '';
     if (details.assistenciaNome && allJogadores.length > 0) {
        const assisterDetails = allJogadores.find(j => j.nome === details.assistenciaNome);
        if (assisterDetails && assisterDetails.imagem_link && goalDetailAssistenciaInput) {
            goalDetailAssistenciaInput.style.backgroundImage = `url('${assisterDetails.imagem_link}')`;
            goalDetailAssistenciaInput.classList.add('has-image-bg'); 
            goalDetailAssistenciaInput.dataset.fixedBg = "true";
        }
    }
    if (details.zona) {
        if(selectedGoalZoneHidden) selectedGoalZoneHidden.value = details.zona;
        const preSelectedCell = goalZoneGridContainer.querySelector(`.goal-zone-cell[data-zone="${details.zona}"]`);
        if (preSelectedCell) preSelectedCell.classList.add('selected');
    }
    
    if(goalDetailScorerSection) goalDetailScorerSection.style.display = type === 'marcado' ? 'flex' : 'none'; 
    if(goalDetailAssistenciaSection) goalDetailAssistenciaSection.style.display = type === 'marcado' ? 'flex' : 'none'; 
    if(goalDetailModal) goalDetailModal.style.display = 'block';
}

function saveGoalDetailsFromModal() {
    const context = goalDetailContextInput.value;
    const type = goalDetailTypeInput.value; 
    const minute = parseInt(goalDetailMinuteInput.value);
    const statusId = context === 'create' ? 'statusJogo' : 'statusEditJogo';

    let targetArray = [];
    let listElement;

    if (context === 'create') {
        targetArray = type === 'marcado' ? minutosGolosMarcados : minutosGolosSofridos;
        listElement = type === 'marcado' ? listaMinutosGolosMarcadosEl : listaMinutosGolosSofridosEl;
    } else { // 'edit'
        targetArray = type === 'marcado' ? editMinutosGolosMarcados : editMinutosGolosSofridos;
        listElement = type === 'marcado' ? editListaMinutosGolosMarcadosEl : editListaMinutosGolosSofridosEl;
    }
    
    const entryIndex = targetArray.findIndex(e => e.minute === minute); 
    if (entryIndex === -1) { showStatus(statusId, 'Erro ao encontrar golo para guardar detalhes.', false); return; }

    const entry = targetArray[entryIndex];
    entry.details = entry.details || {}; 

    if (type === 'marcado') {
        entry.details.jogadorNome = goalDetailJogadorInput.value.trim() || null;
        const scorer = allJogadores.find(j => j.nome === entry.details.jogadorNome);
        entry.details.jogadorId = scorer ? scorer.id : null;
        
        entry.details.assistenciaNome = goalDetailAssistenciaInput.value.trim() || null;
        const assister = allJogadores.find(j => j.nome === entry.details.assistenciaNome);
        entry.details.assistenciaId = assister ? assister.id : null;
    }
    entry.details.zona = selectedGoalZoneHidden.value || null;
    
    showStatus(statusId, `Detalhes para golo aos ${minute}' guardados temporariamente.`, true);
    if(goalDetailModal) goalDetailModal.style.display = 'none';
    renderMinuteList_contextAware(listElement, targetArray, type, context);
    updateCalculatedScores_contextAware(context); 
}


// --- "CRIAR" & "EDITAR" JOGO - COMMON FUNCTIONS (Context-Aware) ---
function getGoalDetailStatus(details, type) {
    if (!details || Object.keys(details).length === 0) return 'status-pending';
    if (type === 'marcado') { 
        const hasScorer = !!details.jogadorNome;
        const hasZone = !!details.zona;
        if (hasScorer && hasZone) return 'status-complete';
        if (hasScorer || hasZone) return 'status-incomplete';
        return 'status-pending';
    } else if (type === 'sofrido') { 
        return details.zona ? 'status-complete' : 'status-pending';
    }
    return 'status-pending';
}

function renderMinuteList_contextAware(listElement, minutesArray, type, context) {
    if (!listElement) return;
    listElement.innerHTML = '';
    minutesArray.forEach((entry, index) => {
        const listItem = document.createElement('li');
        listItem.classList.add('minute-list-item');
        const statusClass = getGoalDetailStatus(entry.details, type);
        listItem.classList.add(statusClass);
        
        const textAndScorerContainer = document.createElement('div');
        textAndScorerContainer.classList.add('minute-text-scorer-container');

        const minuteSpan = document.createElement('span');
        minuteSpan.classList.add('minute-value');
        minuteSpan.textContent = `Minuto ${entry.minute}`;
        minuteSpan.dataset.index = index;
        minuteSpan.dataset.type = type; 
        minuteSpan.dataset.minute = entry.minute; 
        minuteSpan.dataset.context = context; 
        minuteSpan.addEventListener('click', openGoalDetailModal_contextAware);
        textAndScorerContainer.appendChild(minuteSpan);

        if (type === 'marcado' && entry.details && entry.details.jogadorNome) {
            const scorerSpan = document.createElement('span');
            scorerSpan.classList.add('scorer-name'); scorerSpan.textContent = `(${entry.details.jogadorNome})`;
            textAndScorerContainer.appendChild(scorerSpan);
        }

        const removeBtn = document.createElement('button');
        removeBtn.classList.add('remove-minute-btn'); removeBtn.innerHTML = '√ó';
        removeBtn.addEventListener('click', () => {
            minutesArray.splice(index, 1);
            renderMinuteList_contextAware(listElement, minutesArray, type, context); 
            updateCalculatedScores_contextAware(context);
        });
        listItem.appendChild(textAndScorerContainer); listItem.appendChild(removeBtn);
        listElement.appendChild(listItem);
    });
}

function addMinuteEntry_contextAware(type, listElement, minutesArray, context) {
    const minuteInputEl = context === 'create' ? 
        (type === 'marcado' ? jogoMinutoGoloMarcadoInput : jogoMinutoGoloSofridoInput) :
        (type === 'marcado' ? editJogoMinutoGoloMarcadoInput : editJogoMinutoGoloSofridoInput);
    const statusId = context === 'create' ? 'statusJogo' : 'statusEditJogo';
    
    if(!minuteInputEl) { console.error("Minute input element not found for context:", context, "type:", type); return; }
    const minute = parseInt(minuteInputEl.value);
    if (!minute || minute <= 0) { showStatus(statusId, 'Minuto inv√°lido.', false); return; }
    
    minutesArray.push({ minute, details: {} }); 
    minutesArray.sort((a, b) => a.minute - b.minute);
    renderMinuteList_contextAware(listElement, minutesArray, type, context);
    minuteInputEl.value = ''; 
    updateCalculatedScores_contextAware(context);
}

function setupDynamicPlayerInputs_contextAware(containerId, numPlayers, rolePrefix, context) {
    const container = document.getElementById(containerId); 
    if (!container) return;
    container.innerHTML = ''; 
    for (let i = 1; i <= numPlayers; i++) {
        const wrapperDiv = document.createElement('div'); wrapperDiv.classList.add('player-input-wrapper');
        const inputId = `${containerId}_player_${i}`; // Simpler ID structure
        const input = document.createElement('input');
        input.type = 'text'; input.id = inputId; input.placeholder = `Jogador ${i}`; input.autocomplete = 'off'; 
        input.dataset.playerType = rolePrefix; 
        
        const suggId = `sugg_${inputId}`;
        const suggDiv = document.createElement('div');
        suggDiv.id = suggId; suggDiv.classList.add('suggestions-container'); suggDiv.style.display = 'none';
        
        const clearBtn = document.createElement('span'); 
        clearBtn.classList.add('player-input-clear-btn'); clearBtn.innerHTML = '√ó'; clearBtn.style.display = 'none'; 
        clearBtn.addEventListener('click', function() {
            input.value = ''; input.style.backgroundImage = 'none';
            input.classList.remove('has-image-bg'); input.classList.remove('has-clear-btn'); delete input.dataset.fixedBg;
            this.style.display = 'none'; input.dispatchEvent(new Event('input', { bubbles: true })); 
        });
        input.addEventListener('input', function() { 
            if (this.value.trim() !== '') { clearBtn.style.display = 'block'; input.classList.add('has-clear-btn');} 
            else { 
                clearBtn.style.display = 'none'; input.classList.remove('has-clear-btn');
                input.style.backgroundImage = 'none'; input.classList.remove('has-image-bg'); delete input.dataset.fixedBg;
            }
        });
        wrapperDiv.appendChild(input); wrapperDiv.appendChild(clearBtn); wrapperDiv.appendChild(suggDiv); 
        container.appendChild(wrapperDiv);
        if (allJogadores.length > 0) {
            setupSuggestionHandler(input, suggDiv, allJogadores, 'nome', 'imagem_link', clearBtn); 
        } else { console.warn(`allJogadores n√£o carregado para ${containerId} - ${inputId}`); }
    }
}

function updateCalculatedScores_contextAware(context) {
    const clubeCasaEl = context === 'create' ? jogoClubeCasaInput : editJogoClubeCasaInput;
    const clubeForaEl = context === 'create' ? jogoClubeForaInput : editJogoClubeForaInput;
    const golosMarcadosArr = context === 'create' ? minutosGolosMarcados : editMinutosGolosMarcados;
    const golosSofridosArr = context === 'create' ? minutosGolosSofridos : editMinutosGolosSofridos;

    const nomeJogoOut = context === 'create' ? jogoNomeJogoOutput : editJogoNomeJogoOutput;
    const gmCasaOut = context === 'create' ? jogoGMCasaOutput : editJogoGMCasaOutput;
    const resultadoFinalOut = context === 'create' ? jogoResultadoFinalOutput : editJogoResultadoFinalOutput;
    const gmForaOut = context === 'create' ? jogoGMForaOutput : editJogoGMForaOutput;
    const gsCasaOut = context === 'create' ? jogoGSCasaOutput : editJogoGSCasaOutput;
    const gsForaOut = context === 'create' ? jogoGSForaOutput : editJogoGSForaOutput;
    const marcados1POut = context === 'create' ? jogoMarcados1POutput : editJogoMarcados1POutput;
    const marcados2POut = context === 'create' ? jogoMarcados2POutput : editJogoMarcados2POutput;
    const sofridos1POut = context === 'create' ? jogoSofridos1POutput : editJogoSofridos1POutput;
    const sofridos2POut = context === 'create' ? jogoSofridos2POutput : editJogoSofridos2POutput;
    const estadoOut = context === 'create' ? jogoEstadoOutput : editJogoEstadoOutput;
    
    if (!clubeCasaEl || !clubeForaEl) {
        // console.warn("Club input elements not found for score calculation in context:", context);
        return; 
    }

    const casaNomeInput = clubeCasaEl.value.trim(); 
    const foraNomeInput = clubeForaEl.value.trim(); 
    const casaNomeLower = casaNomeInput.toLowerCase();
    const isSportingCasa = sportingCanonicoNomesInput.map(n=>n.toLowerCase()).includes(casaNomeLower);
    const isSportingFora = sportingCanonicoNomesInput.map(n=>n.toLowerCase()).includes(foraNomeInput.toLowerCase());
    
    const gMarcadosPeloSporting = golosMarcadosArr.length;
    const gSofridosPeloSporting = golosSofridosArr.length;
    let gmCasaFinal, gmForaFinal; 

    if (isSportingCasa) {
        gmCasaFinal = gMarcadosPeloSporting; gmForaFinal = gSofridosPeloSporting;    
        if(gsCasaOut) gsCasaOut.value = gSofridosPeloSporting; if(gsForaOut) gsForaOut.value = gMarcadosPeloSporting; 
    } else if (isSportingFora) {
        gmCasaFinal = gSofridosPeloSporting; gmForaFinal = gMarcadosPeloSporting;    
        if(gsCasaOut) gsCasaOut.value = gMarcadosPeloSporting; if(gsForaOut) gsForaOut.value = gSofridosPeloSporting; 
    } else { 
        gmCasaFinal = (context === 'create' || (context === 'edit' && !(casaNomeInput.toLowerCase() === sportingCanonicoNomeDb.toLowerCase() || foraNomeInput.toLowerCase() === sportingCanonicoNomeDb.toLowerCase() ))) ? 0 : (casaNomeInput.toLowerCase() === sportingCanonicoNomeDb.toLowerCase() ? gMarcadosPeloSporting : gSofridosPeloSporting);
        gmForaFinal = (context === 'create' || (context === 'edit' && !(casaNomeInput.toLowerCase() === sportingCanonicoNomeDb.toLowerCase() || foraNomeInput.toLowerCase() === sportingCanonicoNomeDb.toLowerCase() ))) ? 0 : (foraNomeInput.toLowerCase() === sportingCanonicoNomeDb.toLowerCase() ? gMarcadosPeloSporting : gSofridosPeloSporting);
        
        // If Sporting is not involved (and not in edit mode where it might be predefined non-Sporting), clear GS fields
        if (context === 'create' || (context === 'edit' && !isSportingCasa && !isSportingFora)) {
            if(gsCasaOut) gsCasaOut.value = ""; 
            if(gsForaOut) gsForaOut.value = "";
        } else if (context === 'edit') { // In edit mode, if Sporting IS involved, set GS based on GM
            if(isSportingCasa) { if(gsCasaOut) gsCasaOut.value = gmForaFinal; if(gsForaOut) gsForaOut.value = gmCasaFinal; }
            else if(isSportingFora) { if(gsCasaOut) gsCasaOut.value = gmForaFinal; if(gsForaOut) gsForaOut.value = gmCasaFinal; }
        }
    }

    if(gmCasaOut) gmCasaOut.value = gmCasaFinal; 
    if(gmForaOut) gmForaOut.value = gmForaFinal;
    if(resultadoFinalOut) resultadoFinalOut.value = `${gmCasaFinal}-${gmForaFinal}`;
    if(nomeJogoOut) nomeJogoOut.value = (casaNomeInput && foraNomeInput) ? `${casaNomeInput} ${gmCasaFinal}-${gmForaFinal} ${foraNomeInput}` : "";
    
    if(marcados1POut) marcados1POut.value = golosMarcadosArr.filter(g => g.minute <= 45).length;
    if(marcados2POut) marcados2POut.value = golosMarcadosArr.filter(g => g.minute > 45).length;
    if(sofridos1POut) sofridos1POut.value = golosSofridosArr.filter(g => g.minute <= 45).length;
    if(sofridos2POut) sofridos2POut.value = golosSofridosArr.filter(g => g.minute > 45).length;
    
    if(estadoOut) {
        if (isSportingCasa || isSportingFora) { 
            if (gMarcadosPeloSporting > gSofridosPeloSporting) estadoOut.value = "V (Vit√≥ria)";
            else if (gMarcadosPeloSporting < gSofridosPeloSporting) estadoOut.value = "D (Derrota)";
            else if (gMarcadosPeloSporting > 0 || gSofridosPeloSporting > 0) estadoOut.value = "E (Empate)"; 
            else estadoOut.value = "E (Empate)"; 
        } else { estadoOut.value = ""; }
    }
}

// --- Editar Clube ---
function setupEditClubeSuggestions() {
    if (selectEditClubeNomeInput && selectEditClubeSuggestionsContainer && allClubes.length > 0) {
        setupSuggestionHandler( selectEditClubeNomeInput, selectEditClubeSuggestionsContainer, allClubes, 'nome', 'logo', null,
            (selectedClub) => { 
                if (selectedClub && selectedClub.id) {
                    currentEditingClubId = selectedClub.id; 
                    editClubeNomeInput.value = selectedClub.nome; // Nome is ID
                    editClubeLogoInput.value = selectedClub.logo || '';
                    editClubeRegiaoInput.value = selectedClub.regiao || '';
                    editClubeCidadeInput.value = selectedClub.cidade || '';
                    if(formEditClube) formEditClube.style.display = 'block'; 
                    showStatus('statusEditClube', '', true); // Clear status
                }
            }
        );
    }
}
async function handleFormEditClubeSubmit(e) {
    e.preventDefault();
    if (!currentEditingClubId) { showStatus('statusEditClube', 'Nenhum clube selecionado.', false); return; }
    const updatedClubData = {
        logo: editClubeLogoInput.value.trim(), 
        regiao: editClubeRegiaoInput.value.trim(), 
        cidade: editClubeCidadeInput.value.trim(),
    };
    if (!updatedClubData.logo || !updatedClubData.regiao || !updatedClubData.cidade) {
        showStatus('statusEditClube', 'Logo, Regi√£o e Cidade s√£o obrigat√≥rios.', false); return;
    }
    try {
        await updateDoc(doc(db, "clubes", currentEditingClubId), updatedClubData);
        showStatus('statusEditClube', `Clube "${currentEditingClubId}" atualizado!`, true);
        if(formEditClube) formEditClube.style.display = 'none'; 
        if(selectEditClubeNomeInput) selectEditClubeNomeInput.value = ''; 
        currentEditingClubId = null;
        allClubes = []; 
        if (document.getElementById('tabEditClube')?.style.display === 'block') loadAllClubesData(false); 
        if (document.getElementById('tabJogo')?.style.display === 'block') loadAllClubesData(true);
    } catch (error) { showStatus('statusEditClube', `Erro: ${error.message}`, false); }
}
async function handleDeleteClube() {
    if (!currentEditingClubId) { showStatus('statusEditClube', 'Nenhum clube selecionado.', false); return; }
    if (confirm(`Tem a certeza que quer eliminar o clube "${currentEditingClubId}"?`)) {
        try {
            await deleteDoc(doc(db, "clubes", currentEditingClubId));
            showStatus('statusEditClube', `Clube "${currentEditingClubId}" eliminado!`, true);
            if(formEditClube) formEditClube.style.display = 'none'; 
            if(selectEditClubeNomeInput) selectEditClubeNomeInput.value = ''; 
            currentEditingClubId = null;
            allClubes = []; 
            if (document.getElementById('tabEditClube')?.style.display === 'block') loadAllClubesData(false);
            if (document.getElementById('tabJogo')?.style.display === 'block') loadAllClubesData(true);
        } catch (error) { showStatus('statusEditClube', `Erro: ${error.message}`, false); }
    }
}

// --- Editar Posi√ß√£o ---
function setupEditPosicaoSuggestions() {
     if (selectEditPosicaoInput && selectEditPosicaoSuggestions && allPosicoesArray.length > 0) {
        setupSuggestionHandler(selectEditPosicaoInput, selectEditPosicaoSuggestions, allPosicoesArray, 'display', null, null,
            (selectedPosicao) => { 
                if (selectedPosicao && selectedPosicao.id) {
                    currentEditingPosicaoId = selectedPosicao.id; 
                    editPosicaoAbreviacaoInput.value = selectedPosicao.abreviacao;
                    editPosicaoGenericaFormInput.value = selectedPosicao.posicao_generica;
                    if(formEditPosicao) formEditPosicao.style.display = 'block';
                    showStatus('statusEditPosicao', '', true);
                }
            },
            (item) => `${item.abreviacao} ${item.posicao_generica}` 
        );
    }
}
async function handleFormEditPosicaoSubmit(e) {
    e.preventDefault();
    if (!currentEditingPosicaoId) { showStatus('statusEditPosicao', 'Nenhuma posi√ß√£o selecionada.', false); return; }
    const novaPosicaoGenerica = editPosicaoGenericaFormInput.value.trim();
    if (!novaPosicaoGenerica) { showStatus('statusEditPosicao', 'Posi√ß√£o gen√©rica n√£o pode ser vazia.', false); return; }
    try {
        await updateDoc(doc(db, "posicoes", currentEditingPosicaoId), { posicao_generica: novaPosicaoGenerica });
        showStatus('statusEditPosicao', `Posi√ß√£o "${currentEditingPosicaoId}" atualizada!`, true);
        if(formEditPosicao) formEditPosicao.style.display = 'none';
        if(selectEditPosicaoInput) selectEditPosicaoInput.value = '';
        currentEditingPosicaoId = null;
        posicoesMap.clear(); allPosicoesArray = []; 
        if (document.getElementById('tabEditPosicao')?.style.display === 'block') loadAllPosicoesData().then(setupEditPosicaoSuggestions);
        if (document.getElementById('tabJogador')?.style.display === 'block') loadPosicoesParaDropdown(jogadorPosEspecificaDropdown);
        if (document.getElementById('tabEditJogador')?.style.display === 'block') loadPosicoesParaDropdown(editJogadorPosEspecificaDropdown);
    } catch (error) { showStatus('statusEditPosicao', `Erro: ${error.message}`, false); }
}
async function handleDeletePosicao() {
    if (!currentEditingPosicaoId) { showStatus('statusEditPosicao', 'Nenhuma posi√ß√£o selecionada.', false); return; }
    if (confirm(`Tem a certeza que quer eliminar a posi√ß√£o "${currentEditingPosicaoId} (${editPosicaoGenericaFormInput.value})"?`)) {
        try {
            await deleteDoc(doc(db, "posicoes", currentEditingPosicaoId));
            showStatus('statusEditPosicao', `Posi√ß√£o "${currentEditingPosicaoId}" eliminada!`, true);
            if(formEditPosicao) formEditPosicao.style.display = 'none';
            if(selectEditPosicaoInput) selectEditPosicaoInput.value = '';
            currentEditingPosicaoId = null;
            posicoesMap.clear(); allPosicoesArray = []; 
            if (document.getElementById('tabEditPosicao')?.style.display === 'block') loadAllPosicoesData().then(setupEditPosicaoSuggestions);
            if (document.getElementById('tabJogador')?.style.display === 'block') loadPosicoesParaDropdown(jogadorPosEspecificaDropdown);
            if (document.getElementById('tabEditJogador')?.style.display === 'block') loadPosicoesParaDropdown(editJogadorPosEspecificaDropdown);
        } catch (error) { showStatus('statusEditPosicao', `Erro: ${error.message}`, false); }
    }
}

// --- Editar Jogador ---
function setupEditJogadorSuggestions() {
    if (selectEditJogadorInput && selectEditJogadorSuggestions && allJogadores.length > 0) {
        setupSuggestionHandler( selectEditJogadorInput, selectEditJogadorSuggestions, allJogadores, 'nome', 'imagem_link', null,
            async (selectedJogador) => { 
                if (selectedJogador && selectedJogador.id) {
                    currentEditingJogadorId = selectedJogador.id;
                    const jogadorData = allJogadores.find(j => j.id === currentEditingJogadorId);
                    if (jogadorData) {
                        editJogadorNomeInput.value = jogadorData.nome;
                        editJogadorImagemInput.value = jogadorData.imagem_link || '';
                        await loadPosicoesParaDropdown(editJogadorPosEspecificaDropdown); 
                        editJogadorPosEspecificaDropdown.value = jogadorData.posicao_especifica_id || '';
                        editJogadorPosEspecificaDropdown.dispatchEvent(new Event('change')); 
                        await loadPaisesParaSugestoes(editJogadorPaisNomeInput, editJogadorPaisSuggestions, true); 
                        editJogadorPaisNomeInput.value = jogadorData.pais_id || ''; 
                        const paisData = allPaisesData.find(p => p.nome === jogadorData.pais_id);
                        if (paisData && paisData.bandeira) {
                            editJogadorPaisNomeInput.style.backgroundImage = `url('${paisData.bandeira}')`;
                            editJogadorPaisNomeInput.classList.add('has-image-bg');
                            editJogadorPaisNomeInput.dataset.fixedBg = "true";
                        } else {
                            editJogadorPaisNomeInput.style.backgroundImage = 'none';
                            editJogadorPaisNomeInput.classList.remove('has-image-bg');
                            delete editJogadorPaisNomeInput.dataset.fixedBg;
                        }
                        if(formEditJogador) formEditJogador.style.display = 'block';
                        showStatus('statusEditJogador', '', true);
                    } else {
                        showStatus('statusEditJogador', 'Jogador n√£o encontrado no cache.', false);
                        if(formEditJogador) formEditJogador.style.display = 'none'; currentEditingJogadorId = null;
                    }
                }
            }
        );
    } else if (selectEditJogadorInput) {
         selectEditJogadorInput.placeholder = allJogadores.length === 0 ? "A carregar jogadores..." : "Comece a digitar nome do jogador...";
    }
}
async function handleFormEditJogadorSubmit(e) {
    e.preventDefault();
    if (!currentEditingJogadorId) { showStatus('statusEditJogador', 'Nenhum jogador selecionado.', false); return; }
    const updatedImagem = editJogadorImagemInput.value.trim();
    const updatedPosEspecifica = editJogadorPosEspecificaDropdown.value;
    const updatedPosGenerica = editJogadorPosGenericaInput.value; 
    const updatedPaisNome = editJogadorPaisNomeInput.value.trim();

    if (!updatedImagem || !updatedPosEspecifica || !updatedPaisNome) {
        showStatus('statusEditJogador', 'Imagem, Posi√ß√£o Espec√≠fica e Pa√≠s s√£o obrigat√≥rios.', false); return;
    }
    if (!updatedPosGenerica) { 
        showStatus('statusEditJogador', 'Posi√ß√£o gen√©rica n√£o definida. Selecione uma posi√ß√£o espec√≠fica v√°lida.', false); return;
    }
    await loadAllPaisesData(true); // ensure allPaisesData is current
    if (!allPaisesData.some(p => p.nome === updatedPaisNome) && allPaisesData.length > 0) {
         showStatus('statusEditJogador', `Pa√≠s "${updatedPaisNome}" n√£o encontrado. Selecione da lista ou crie um novo.`, false); return;
    }
    const jogadorDataToUpdate = {
        imagem_link: updatedImagem,
        posicao_especifica_id: updatedPosEspecifica, posicao_especifica_nome: updatedPosEspecifica,
        posicao_generica_id: updatedPosGenerica, posicao_generica_nome: updatedPosGenerica,
        pais_id: updatedPaisNome, pais_nome: updatedPaisNome 
    };
    try {
        await updateDoc(doc(db, "jogadores", currentEditingJogadorId), jogadorDataToUpdate);
        showStatus('statusEditJogador', `Jogador "${currentEditingJogadorId}" atualizado!`, true);
        if(formEditJogador) formEditJogador.style.display = 'none';
        if(selectEditJogadorInput) selectEditJogadorInput.value = '';
        currentEditingJogadorId = null;
        allJogadores = []; 
        if (document.getElementById('tabEditJogador')?.style.display === 'block') { loadAllJogadoresCache().then(setupEditJogadorSuggestions); }
        if (document.getElementById('tabJogo')?.style.display === 'block') loadAllJogadoresCache();
        if (document.getElementById('tabEditJogo')?.style.display === 'block') loadAllJogadoresCache();
    } catch (error) { showStatus('statusEditJogador', `Erro: ${error.message}`, false); }
}
async function handleDeleteJogador() {
    if (!currentEditingJogadorId) { showStatus('statusEditJogador', 'Nenhum jogador selecionado.', false); return; }
    if (confirm(`Tem a certeza que quer eliminar o jogador "${currentEditingJogadorId}"?`)) {
        try {
            await deleteDoc(doc(db, "jogadores", currentEditingJogadorId));
            showStatus('statusEditJogador', `Jogador "${currentEditingJogadorId}" eliminado!`, true);
            if(formEditJogador) formEditJogador.style.display = 'none';
            if(selectEditJogadorInput) selectEditJogadorInput.value = '';
            currentEditingJogadorId = null;
            allJogadores = []; 
             if (document.getElementById('tabEditJogador')?.style.display === 'block') { loadAllJogadoresCache().then(setupEditJogadorSuggestions); }
             if (document.getElementById('tabJogo')?.style.display === 'block') loadAllJogadoresCache();
             if (document.getElementById('tabEditJogo')?.style.display === 'block') loadAllJogadoresCache();
        } catch (error) { showStatus('statusEditJogador', `Erro: ${error.message}`, false); }
    }
}

// --- Editar Pa√≠s ---
function setupEditPaisSuggestions() {
    if (selectEditPaisInput && selectEditPaisSuggestions && allPaisesData.length > 0) {
        setupSuggestionHandler(selectEditPaisInput, selectEditPaisSuggestions, allPaisesData, 'nome', 'bandeira', null,
            async (selectedPais) => {
                if (selectedPais && selectedPais.id) {
                    currentEditingPaisId = selectedPais.id;
                    editPaisNomeInput.value = selectedPais.nome;
                    editPaisBandeiraInput.value = selectedPais.bandeira || '';
                    await loadContinentesParaDropdown(editPaisContinenteSelect, true); 
                    editPaisContinenteSelect.value = selectedPais.continente || '';
                    if(formEditPais) formEditPais.style.display = 'block';
                    showStatus('statusEditPais', '', true);
                }
            }
        );
    }
}
async function handleFormEditPaisSubmit(e) {
    e.preventDefault();
    if (!currentEditingPaisId) { showStatus('statusEditPais', 'Nenhum pa√≠s selecionado.', false); return; }
    const updatedBandeira = editPaisBandeiraInput.value.trim();
    const updatedContinente = editPaisContinenteSelect.value;
    if (!updatedBandeira || !updatedContinente) {
        showStatus('statusEditPais', 'Link da Bandeira e Continente s√£o obrigat√≥rios.', false); return;
    }
    try {
        await updateDoc(doc(db, "paises", currentEditingPaisId), { bandeira: updatedBandeira, continente: updatedContinente });
        showStatus('statusEditPais', `Pa√≠s "${currentEditingPaisId}" atualizado!`, true);
        if(formEditPais) formEditPais.style.display = 'none'; 
        if(selectEditPaisInput) selectEditPaisInput.value = ''; 
        currentEditingPaisId = null;
        allPaisesData = []; allPaisesSimpleList = []; allContinentesSet.clear(); 
        if (document.getElementById('tabEditPais')?.style.display === 'block') loadAllPaisesData(true).then(setupEditPaisSuggestions);
        if (document.getElementById('tabPais')?.style.display === 'block') loadContinentesParaDropdown(paisContinenteSelect, false);
        if (document.getElementById('tabJogador')?.style.display === 'block') loadPaisesParaSugestoes(jogadorPaisNomeInput, paisSuggestionsContainer, false);
        if (document.getElementById('tabEditJogador')?.style.display === 'block') loadPaisesParaSugestoes(editJogadorPaisNomeInput, editJogadorPaisSuggestions, true);

    } catch (error) { showStatus('statusEditPais', `Erro: ${error.message}`, false); }
}
async function handleDeletePais() {
    if (!currentEditingPaisId) { showStatus('statusEditPais', 'Nenhum pa√≠s selecionado.', false); return; }
    if (confirm(`Tem a certeza que quer eliminar o pa√≠s "${currentEditingPaisId}"?`)) {
        try {
            await deleteDoc(doc(db, "paises", currentEditingPaisId));
            showStatus('statusEditPais', `Pa√≠s "${currentEditingPaisId}" eliminado!`, true);
            if(formEditPais) formEditPais.style.display = 'none'; 
            if(selectEditPaisInput) selectEditPaisInput.value = ''; 
            currentEditingPaisId = null;
            allPaisesData = []; allPaisesSimpleList = []; allContinentesSet.clear();
            if (document.getElementById('tabEditPais')?.style.display === 'block') loadAllPaisesData(true).then(setupEditPaisSuggestions);
            if (document.getElementById('tabPais')?.style.display === 'block') loadContinentesParaDropdown(paisContinenteSelect, false);
            if (document.getElementById('tabJogador')?.style.display === 'block') loadPaisesParaSugestoes(jogadorPaisNomeInput, paisSuggestionsContainer, false);
            if (document.getElementById('tabEditJogador')?.style.display === 'block') loadPaisesParaSugestoes(editJogadorPaisNomeInput, editJogadorPaisSuggestions, true);
        } catch (error) { showStatus('statusEditPais', `Erro: ${error.message}`, false); }
    }
}

// --- Editar Jogo ---
function setupEditJogoSuggestions() {
     if (selectEditJogoInput && selectEditJogoSuggestions && allJogosCache.length > 0) {
        setupSuggestionHandler(selectEditJogoInput, selectEditJogoSuggestions, allJogosCache, 'displayString', null, null,
            (selectedJogoInfo) => { 
                currentEditingJogoId = selectedJogoInfo.id;
                currentEditingJogoData = allJogosCache.find(j => j.id === currentEditingJogoId); // Use cached full data
                if (currentEditingJogoData) {
                    populateEditJogoForm(currentEditingJogoData);
                    if(formEditJogo) formEditJogo.style.display = 'block';
                    showStatus('statusEditJogo', `Jogo "${currentEditingJogoData.nomeJogo || currentEditingJogoId}" carregado.`, true);
                } else {
                    showStatus('statusEditJogo', 'Dados do jogo n√£o encontrados no cache.', false); currentEditingJogoId = null; currentEditingJogoData = null;
                    if(formEditJogo) formEditJogo.style.display = 'none';
                }
            }
        );
    }
}
        
function populateEditJogoForm(data) {
    if (!data) return;
    // General Info (Readonly in form)
    if(editJogoTemporadaInput) editJogoTemporadaInput.value = data.temporada;
    if(editJogoJornadaInput) editJogoJornadaInput.value = data.jornada;
    if(editJogoClubeCasaInput) editJogoClubeCasaInput.value = data.clubeCasaNome;
    if(editJogoClubeForaInput) editJogoClubeForaInput.value = data.clubeForaNome;

    editMinutosGolosMarcados = JSON.parse(JSON.stringify(data.golosMarcadosSportingMinutos || [])); 
    editMinutosGolosSofridos = JSON.parse(JSON.stringify(data.golosSofridosSportingMinutos || [])); 
    renderMinuteList_contextAware(editListaMinutosGolosMarcadosEl, editMinutosGolosMarcados, 'marcado', 'edit');
    renderMinuteList_contextAware(editListaMinutosGolosSofridosEl, editMinutosGolosSofridos, 'sofrido', 'edit');
    
    populatePlantelInputs_contextAware('editJogo11InicialContainer', data.onzeInicial || [], 'edit');
    populatePlantelInputs_contextAware('editJogoSuplentesContainer', data.suplentes || [], 'edit');

    updateCalculatedScores_contextAware('edit'); 
    // Ensure collapsible section is appropriately shown/hidden or reset
    const editPlacarStatsContent = document.querySelector('#fieldsetEditPlacarStats .toggle-content');
    const editPlacarStatsIndicator = document.querySelector('#legendEditPlacarStats .toggle-indicator');
    if (editPlacarStatsContent) editPlacarStatsContent.style.display = 'none'; // Default to closed
    if (editPlacarStatsIndicator) editPlacarStatsIndicator.textContent = '[+]';
    document.getElementById('fieldsetEditPlacarStats')?.classList.remove('open');
}

function populatePlantelInputs_contextAware(containerId, plantelArray, context) {
    const container = document.getElementById(containerId);
    if (!container) return;
    const inputs = container.querySelectorAll('input[type="text"]');
    inputs.forEach((input, index) => {
        const jogadorData = plantelArray[index];
        if (jogadorData && jogadorData.nome) {
            input.value = jogadorData.nome;
            const jogadorCache = allJogadores.find(j => j.id === jogadorData.id || j.nome === jogadorData.nome);
            if (jogadorCache && jogadorCache.imagem_link) {
                input.style.backgroundImage = `url('${jogadorCache.imagem_link}')`;
                input.classList.add('has-image-bg');
                input.dataset.fixedBg = "true";
            } else {
                input.style.backgroundImage = 'none';
                input.classList.remove('has-image-bg');
                delete input.dataset.fixedBg;
            }
            input.dispatchEvent(new Event('input', { bubbles: true }));
        } else {
            input.value = '';
            input.style.backgroundImage = 'none';
            input.classList.remove('has-image-bg');
            delete input.dataset.fixedBg;
            input.dispatchEvent(new Event('input', { bubbles: true }));
        }
    });
}
        
async function handleFormEditJogoSubmit(e) {
    e.preventDefault();
    if(!currentEditingJogoId || !currentEditingJogoData) { showStatus('statusEditJogo', "Nenhum jogo carregado para edi√ß√£o.", false); return; }

    const getPlantelFromEditForm = (containerSel) => Array.from(document.querySelectorAll(`${containerSel} input[type="text"]`))
        .map(inp => {
            const nome = inp.value.trim();
            if (!nome) return { nome: null, id: null };
            const jogador = allJogadores.find(j => j.nome === nome);
            return { nome, id: jogador ? jogador.id : nome }; 
        }).filter(p => p.nome); 

    const updatedOnzeInicial = getPlantelFromEditForm('#editJogo11InicialContainer');
    const updatedSuplentes = getPlantelFromEditForm('#editJogoSuplentesContainer');

    if (updatedOnzeInicial.length !== 11) { showStatus('statusEditJogo', 'O 11 Inicial deve ter 11 jogadores preenchidos.', false); return; }
    
    const updatedJogoData = {
        ...currentEditingJogoData, 
        golosMarcadosSportingMinutos: editMinutosGolosMarcados.map(g => ({ minute: g.minute, details: g.details || {} })),
        golosSofridosSportingMinutos: editMinutosGolosSofridos.map(g => ({ minute: g.minute, details: g.details || {} })),
        onzeInicial: updatedOnzeInicial,
        suplentes: updatedSuplentes,
        nomeJogo: editJogoNomeJogoOutput.value,
        resultadoFinal: editJogoResultadoFinalOutput.value,
        resultadoGMCasa: parseInt(editJogoGMCasaOutput.value) || 0,
        resultadoGMFora: parseInt(editJogoGMForaOutput.value) || 0,
        sportingGolosMarcados1P: parseInt(editJogoMarcados1POutput.value) || 0,
        sportingGolosMarcados2P: parseInt(editJogoMarcados2POutput.value) || 0,
        sportingGolosSofridos1P: parseInt(editJogoSofridos1POutput.value) || 0,
        sportingGolosSofridos2P: parseInt(editJogoSofridos2POutput.value) || 0,
        resultadoEstadoSporting: editJogoEstadoOutput.value,
        dataUltimaModificacao: serverTimestamp()
    };

    try {
        const batch = writeBatch(db);
        const jogoDocRef = doc(db, "jogos", currentEditingJogoId);
        batch.update(jogoDocRef, updatedJogoData);

        const oldGoalsQuery = query(collection(db, "golos"), where("jogoId", "==", currentEditingJogoId));
        const oldGoalsSnap = await getDocs(oldGoalsQuery);
        oldGoalsSnap.forEach(goalDoc => batch.delete(goalDoc.ref));

        const equipaAdversaria = updatedJogoData.sportingCasa ? updatedJogoData.clubeForaNome : updatedJogoData.clubeCasaNome;
        updatedJogoData.golosMarcadosSportingMinutos.forEach(golo => {
            const newGoalRef = doc(collection(db, "golos")); 
            batch.set(newGoalRef, {
                jogoId: currentEditingJogoId, temporada: updatedJogoData.temporada, jornada: updatedJogoData.jornada, nomeJogo: updatedJogoData.nomeJogo,
                minutoGolo: golo.minute, marcadorNome: golo.details?.jogadorNome || null, marcadorId: golo.details?.jogadorId || golo.details?.jogadorNome || null,
                assistenciaNome: golo.details?.assistenciaNome || null, assistenciaId: golo.details?.assistenciaId || golo.details?.assistenciaNome || null,
                parte: golo.minute <= 45 ? "Primeira Parte" : "Segunda Parte", zonaGolo: golo.details?.zona || null,
                estado: "Marcado", equipaQueMarcou: sportingCanonicoNomeDb, tipoGolo: "MarcadoPeloSporting", dataCriacao: serverTimestamp() 
            });
        });
        updatedJogoData.golosSofridosSportingMinutos.forEach(golo => {
             const newGoalRef = doc(collection(db, "golos"));
            batch.set(newGoalRef, {
                jogoId: currentEditingJogoId, temporada: updatedJogoData.temporada, jornada: updatedJogoData.jornada, nomeJogo: updatedJogoData.nomeJogo,
                minutoGolo: golo.minute, marcadorNome: null, marcadorId: null, assistenciaNome: null, assistenciaId: null,
                parte: golo.minute <= 45 ? "Primeira Parte" : "Segunda Parte", zonaGolo: golo.details?.zona || null,
                estado: "Sofrido", equipaQueMarcou: equipaAdversaria, tipoGolo: "SofridoPeloSporting", dataCriacao: serverTimestamp()
            });
        });
        await batch.commit();
        showStatus('statusEditJogo', `Jogo "${updatedJogoData.nomeJogo}" e golos associados atualizados!`, true);
        if(formEditJogo) formEditJogo.style.display = 'none';
        if(selectEditJogoInput) selectEditJogoInput.value = '';
        currentEditingJogoId = null; currentEditingJogoData = null;
        allJogosCache = []; 
        if(document.getElementById('tabEditJogo')?.style.display === 'block') loadAllJogosCache().then(setupEditJogoSuggestions);
    } catch (error) {
        console.error("Erro ao atualizar jogo e golos:", error);
        showStatus('statusEditJogo', `Erro ao atualizar jogo: ${error.message}`, false);
    }
}
        
async function handleDeleteEditJogo() {
    if (!currentEditingJogoId || !currentEditingJogoData) { showStatus('statusEditJogo', 'Nenhum jogo carregado.', false); return; }
    if (confirm(`Tem a certeza que quer eliminar o jogo "${currentEditingJogoData.nomeJogo || currentEditingJogoId}" e TODOS os seus golos associados? Esta a√ß√£o √© IRREVERS√çVEL.`)) {
        try {
            const batch = writeBatch(db);
            batch.delete(doc(db, "jogos", currentEditingJogoId));
            const goalsQuery = query(collection(db, "golos"), where("jogoId", "==", currentEditingJogoId));
            const goalsSnap = await getDocs(goalsQuery);
            goalsSnap.forEach(goalDoc => batch.delete(goalDoc.ref));
            await batch.commit();
            showStatus('statusEditJogo', `Jogo "${currentEditingJogoData.nomeJogo || currentEditingJogoId}" e ${goalsSnap.size} golos eliminados!`, true);
            if(formEditJogo) formEditJogo.style.display = 'none';
            if(selectEditJogoInput) selectEditJogoInput.value = '';
            currentEditingJogoId = null; currentEditingJogoData = null;
            allJogosCache = []; 
            if(document.getElementById('tabEditJogo')?.style.display === 'block') loadAllJogosCache().then(setupEditJogoSuggestions);
        } catch (error) {
            console.error("Erro ao eliminar jogo e golos:", error);
            showStatus('statusEditJogo', `Erro ao eliminar: ${error.message}`, false);
        }
    }
}
        
        
        // --- INITIALIZATION (DOMContentLoaded) ---
        document.addEventListener('DOMContentLoaded', () => {
            if (mainCreateBtn && mainEditBtn) {
                mainCreateBtn.addEventListener('click', () => switchMainPanel('createPanel'));
                mainEditBtn.addEventListener('click', () => switchMainPanel('editPanel'));
            } else { console.error("Main create/edit buttons not found."); }
        
            switchMainPanel('createPanel'); 
            
            const placarStatsLegend = document.getElementById('legendPlacarStats');
            const placarStatsContent = document.querySelector('#fieldsetPlacarStats .toggle-content');
            const placarStatsFieldset = document.getElementById('fieldsetPlacarStats');
            const placarStatsIndicator = placarStatsLegend?.querySelector('.toggle-indicator');
            if (placarStatsLegend && placarStatsContent && placarStatsIndicator && placarStatsFieldset) {
                placarStatsLegend.addEventListener('click', () => {
                    const isOpen = placarStatsContent.style.display === 'block';
                    placarStatsContent.style.display = isOpen ? 'none' : 'block';
                    if(placarStatsIndicator) placarStatsIndicator.textContent = isOpen ? '[+]' : '[-]';
                    placarStatsFieldset.classList.toggle('open', !isOpen);
                });
            }
        
            const editPlacarStatsLegend = document.getElementById('legendEditPlacarStats');
            const editPlacarStatsContent = document.querySelector('#fieldsetEditPlacarStats .toggle-content');
            const editPlacarStatsFieldset = document.getElementById('fieldsetEditPlacarStats');
            const editPlacarStatsIndicator = editPlacarStatsLegend?.querySelector('.toggle-indicator');
            if (editPlacarStatsLegend && editPlacarStatsContent && editPlacarStatsIndicator && editPlacarStatsFieldset) {
                editPlacarStatsLegend.addEventListener('click', () => {
                    const isOpen = editPlacarStatsContent.style.display === 'block';
                    editPlacarStatsContent.style.display = isOpen ? 'none' : 'block';
                    if(editPlacarStatsIndicator) editPlacarStatsIndicator.textContent = isOpen ? '[+]' : '[-]';
                    editPlacarStatsFieldset.classList.toggle('open', !isOpen);
                });
            }
            
            loadAllJogadoresCache(); 
            loadAllPosicoesData();
            loadAllPaisesData(true); // Load full paises data initially
            loadAllClubesData(true); // Load clubes for 'Criar Jogo' context initially as it's the default
            loadAllJogosCache();     // Load jogos cache for 'Editar Jogo'
        
            addMinutoGoloMarcadoBtn?.addEventListener('click', () => addMinuteEntry_contextAware('marcado', listaMinutosGolosMarcadosEl, minutosGolosMarcados, 'create'));
            addMinutoGoloSofridoBtn?.addEventListener('click', () => addMinuteEntry_contextAware('sofrido', listaMinutosGolosSofridosEl, minutosGolosSofridos, 'create'));
            jogoClubeCasaInput?.addEventListener('change', () => updateCalculatedScores_contextAware('create'));
            jogoClubeForaInput?.addEventListener('change', () => updateCalculatedScores_contextAware('create'));
            jogoTemporadaSelect?.addEventListener('change', setSuggestedJornada);
            
            addEditMinutoGoloMarcadoBtn?.addEventListener('click', () => addMinuteEntry_contextAware('marcado', editListaMinutosGolosMarcadosEl, editMinutosGolosMarcados, 'edit'));
            addEditMinutoGoloSofridoBtn?.addEventListener('click', () => addMinuteEntry_contextAware('sofrido', editListaMinutosGolosSofridosEl, editMinutosGolosSofridos, 'edit'));
        
            jogadorPosEspecificaDropdown?.addEventListener('change', function() { 
                if(jogadorPosGenericaInput) jogadorPosGenericaInput.value = this.value && posicoesMap.has(this.value) ? posicoesMap.get(this.value) : '';
            });
            editJogadorPosEspecificaDropdown?.addEventListener('change', function() {
                if(editJogadorPosGenericaInput) editJogadorPosGenericaInput.value = this.value && posicoesMap.has(this.value) ? posicoesMap.get(this.value) : '';
            });
            
            closeGoalDetailModalBtn?.addEventListener('click', () => {if(goalDetailModal) goalDetailModal.style.display = 'none'});
            saveGoalDetailBtn?.addEventListener('click', saveGoalDetailsFromModal);
        
            // CRIAR FORMS
            formJogo?.addEventListener('submit', handleFormJogoSubmit);
            formClube?.addEventListener('submit', handleFormClubeSubmit);
            formPosicao?.addEventListener('submit', handleFormPosicaoSubmit);
            formJogador?.addEventListener('submit', handleFormJogadorSubmit);
            formPais?.addEventListener('submit', handleFormPaisSubmit);
            
            // EDITAR FORMS
            formEditClube?.addEventListener('submit', handleFormEditClubeSubmit);
            deleteClubeBtn?.addEventListener('click', handleDeleteClube);
        
            formEditPosicao?.addEventListener('submit', handleFormEditPosicaoSubmit);
            deletePosicaoBtn?.addEventListener('click', handleDeletePosicao);
        
            formEditJogador?.addEventListener('submit', handleFormEditJogadorSubmit);
            deleteJogadorBtn?.addEventListener('click', handleDeleteJogador);
            
            formEditPais?.addEventListener('submit', handleFormEditPaisSubmit);
            deletePaisBtn?.addEventListener('click', handleDeletePais);
        
            formEditJogo?.addEventListener('submit', handleFormEditJogoSubmit);
            deleteEditJogoBtn?.addEventListener('click', handleDeleteEditJogo);
        });
        
        // </script>
</body>
</html>
