<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão Firebase</title>
    <style>
       @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');

body {
    font-family: 'Roboto', Arial, sans-serif;
    margin: 0;
    padding: 0;
    background-color: #f8f9fa; 
    color: #343a40; 
    line-height: 1.7;
    font-size: 17px; 
}
.container {
    width: 85%; 
    margin: 30px auto; 
    padding: 30px; 
    background: #fff;
    box-shadow: 0 5px 15px rgba(0,0,0,0.12); 
    border-radius: 12px; 
}
h1 {
    color: #0056b3; 
    text-align: center;
    margin-bottom: 30px;
    font-size: 2.8em; 
    font-weight: 700;
}
h2 { 
    color: #17a2b8; 
    margin-top: 25px;
    margin-bottom: 20px;
    font-size: 2em; 
    border-bottom: 2px solid #e9ecef;
    padding-bottom: 10px;
    font-weight: 500;
}
.tab-navigation {
    overflow: hidden;
    border-bottom: 1px solid #dee2e6;
    margin-bottom: 30px; 
}
.tab-navigation button {
    background-color: #e9ecef; 
    float: left;
    border: none;
    outline: none;
    cursor: pointer;
    padding: 16px 22px; 
    transition: background-color 0.3s ease, color 0.3s ease;
    font-size: 1.1em; 
    border-radius: 8px 8px 0 0; 
    margin-right: 8px;
    color: #495057; 
    font-weight: 500;
}
.tab-navigation button:hover {
    background-color: #ced4da; 
    color: #0056b3;
}
.tab-navigation button.active {
    background-color: #007bff; 
    color: white;
    box-shadow: 0 -2px 5px rgba(0,0,0,0.1) inset;
}
.tab-content {
    display: none;
    padding: 20px; 
    border-top: none;
    animation: fadeIn 0.5s ease-in-out;
}
@keyframes fadeIn {
    from {opacity: 0; transform: translateY(10px);}
    to {opacity: 1; transform: translateY(0);}
}
form { 
    display: flex;
    flex-direction: column;
    gap: 25px; 
}
form div, form fieldset { 
    display: flex;
    flex-direction: column;
    position: relative;
    gap: 8px; 
}

label { 
    margin-bottom: 0px; 
    font-weight: 500;
    font-size: 1.1em; 
    color: #495057;
}
input[type="text"], input[type="url"], input[type="number"], select { 
    padding: 12px; 
    border: 1px solid #ced4da;
    border-radius: 6px;
    font-size: 1em; 
    box-sizing: border-box;
    transition: border-color 0.2s ease, box-shadow 0.2s ease;
}
input[type="text"]:focus, input[type="url"]:focus, input[type="number"]:focus, select:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
    outline: none;
}
input[readonly] { 
    background-color: #e9ecef;
    cursor: not-allowed;
}
button[type="submit"], .action-button { 
    background-color: #28a745; /* Default green for submit/action */
    color: white;
    padding: 12px 20px; 
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 1.05em; 
    align-self: flex-start;
    transition: background-color 0.2s ease, transform 0.1s ease;
    font-weight: 500;
}
button[type="submit"]:hover, .action-button:hover {
    background-color: #218838;
    transform: translateY(-1px);
}
button[type="submit"]:active, .action-button:active {
    transform: translateY(0px);
}

/* Specific button for "Update Game" - might be blue */
button.update-button {
    background-color: #007bff; /* Blue for update */
}
button.update-button:hover {
    background-color: #0056b3;
}

.action-button.secondary { background-color: #6c757d; }
.action-button.secondary:hover { background-color: #5a6268; }
.action-button.danger { background-color: #dc3545; }
.action-button.danger:hover { background-color: #c82333; }

.status-message {
    margin-top: 20px; padding: 15px; border-radius: 6px; font-size: 1em; font-weight: 500;
}
.status-message.success { background-color: #d1e7dd; color: #0f5132; border: 1px solid #badbcc; }
.status-message.error { background-color: #f8d7da; color: #842029; border: 1px solid #f5c2c7; }

.suggestions-container {
    position: absolute; border: 1px solid #ced4da; border-top: none; z-index: 99;
    top: 100%; left: 0; right: 0; background-color: white; max-height: 180px;
    overflow-y: auto; box-shadow: 0 4px 8px rgba(0,0,0,0.1); border-radius: 0 0 6px 6px;
}
.suggestion-item { 
    padding: 8px 12px; 
    cursor: pointer;
    border-bottom: 1px solid #eee;
    font-size: 1em;
    display: flex; 
    flex-direction: row;
    align-items: center; 
}
.suggestion-item img {
    width: 30px; 
    height: 30px;
    object-fit: contain; 
    margin-right: 10px;
    border-radius: 50%; 
    border: 1px solid #ddd; 
    flex-shrink: 0;
}
.suggestion-item span {
    flex-grow: 1;
    line-height: 1.4;
}
.suggestion-item:last-child { border-bottom: none; }
.suggestion-item:hover { background-color: #f0f8ff; color: #0056b3; }

.modal {
    display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%;
    overflow: auto; background-color: rgba(0,0,0,0.5);
}
.modal-content {
    background-color: #fefefe; margin: 10% auto; padding: 25px; border: 1px solid #888;
    width: 60%; max-width: 550px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.2);
}
.modal-content h3 { margin-top: 0; color: #007bff; }
.modal-close-btn {
    color: #aaa; float: right; font-size: 28px; font-weight: bold;
}
.modal-close-btn:hover, .modal-close-btn:focus { color: black; text-decoration: none; cursor: pointer; }

.form-grid { display: grid; grid-template-columns: 1fr; gap: 15px; }
 @media (min-width: 600px) {
    .form-grid.two-cols { grid-template-columns: 1fr 1fr; }
    .form-grid.three-cols { grid-template-columns: repeat(3, 1fr); align-items: end; }
}

/* ============================================ */
/* === STYLES SPECIFIC TO #tabJogo & #tabEditarJogo (SHARED) === */
/* ============================================ */

#tabJogo h2, #tabEditarJogo h2.form-section-title { /* Target specific h2 for form sections */
    color: #007bff; 
    border-bottom: 2px solid #007bff;
    padding-bottom: 15px;
    margin-bottom: 30px;
    font-size: 2.2em; 
}
 /* Main title for Edit tab */
#tabEditarJogo > h2:first-of-type {
    color: #007bff; /* Or your preferred color for the main edit title */
     border-bottom: 2px solid #007bff;
    padding-bottom: 15px;
    margin-bottom: 30px;
    font-size: 2.2em;
}


#tabJogo form, #tabEditarJogo form {
    gap: 30px; 
}

#tabJogo fieldset, #tabEditarJogo fieldset {
    border: 1px solid #ced4da; 
    border-radius: 10px; 
    padding: 25px; 
    background-color: #ffffff; 
    box-shadow: 0 2px 8px rgba(0,0,0,0.07); 
    transition: all 0.3s ease-in-out;
}

#tabJogo fieldset:nth-of-type(1), #tabEditarJogo fieldset.general-info-fieldset { 
    border-left: 5px solid #17a2b8; 
    background-color: #f8f9fa; 
}
#tabJogo fieldset:nth-of-type(1) legend, #tabEditarJogo fieldset.general-info-fieldset legend { color: #17a2b8; }

#tabJogo fieldset:nth-of-type(2), #tabEditarJogo fieldset.sporting-goals-fieldset { 
    border-left: 5px solid #28a745; 
}
#tabJogo fieldset:nth-of-type(2) legend, #tabEditarJogo fieldset.sporting-goals-fieldset legend { color: #28a745; }

#tabJogo fieldset#fieldsetPlacarStats, #tabEditarJogo fieldset.placar-stats-fieldset { 
    border-left: 5px solid #ffc107; 
    background-color: #fdf8e2; 
}
#tabJogo fieldset#fieldsetPlacarStats.open, #tabEditarJogo fieldset.placar-stats-fieldset.open {
    background-color: #f8f9fa; 
}
#tabJogo fieldset#fieldsetPlacarStats legend#legendPlacarStats,
#tabEditarJogo fieldset.placar-stats-fieldset legend.toggle-legend { 
    color: #c89400; 
}

#tabJogo fieldset#fieldsetPlantel, #tabEditarJogo fieldset.plantel-fieldset { 
    border-left: 5px solid #6f42c1; 
}
#tabJogo fieldset#fieldsetPlantel legend, #tabEditarJogo fieldset.plantel-fieldset legend { color: #6f42c1; }

#tabJogo fieldset#fieldsetEstadoJogo, #tabEditarJogo fieldset.estado-jogo-fieldset { 
    border-left: 5px solid #fd7e14; 
}
#tabJogo fieldset#fieldsetEstadoJogo legend, #tabEditarJogo fieldset.estado-jogo-fieldset legend { color: #fd7e14; }

.estado-jogo-checkbox-container {
    display: flex;
    flex-direction: row; 
    align-items: center; 
    gap: 25px; 
    flex-wrap: wrap; 
    padding: 5px 0; 
}

.checkbox-item-wrapper {
    display: flex;
    align-items: center; 
}

.checkbox-item-wrapper input[type="checkbox"] {
    margin-right: 5px; 
    width: auto; 
    height: auto;
    vertical-align: middle;
}

.checkbox-item-wrapper label {
    margin-bottom: 0; 
    font-size: 1.1em; 
    color: #343a40;
    font-weight: 500; 
}


#tabJogo legend, #tabEditarJogo legend {
    font-size: 1.6em; 
    font-weight: 600; 
    padding: 0 15px;
    margin-bottom: 15px; 
}

#tabJogo label, #tabEditarJogo label { 
    font-size: 1.2em; 
    color: #343a40; 
    margin-bottom: 8px; 
}

#tabJogo input[type="text"], #tabEditarJogo input[type="text"],
#tabJogo input[type="url"], #tabEditarJogo input[type="url"],
#tabJogo input[type="number"], #tabEditarJogo input[type="number"],
#tabJogo select, #tabEditarJogo select {
    font-size: 1.1em; 
    padding: 14px; 
    border-radius: 6px;
    border: 1px solid #bcc3ca; 
}

#tabJogo input#jogoClubeCasa.has-image-bg, #tabEditarJogo input#editJogoClubeCasa.has-image-bg,
#tabJogo input#jogoClubeFora.has-image-bg, #tabEditarJogo input#editJogoClubeFora.has-image-bg {
    background-repeat: no-repeat;
    background-position: 8px center;  
    background-size: 28px 28px;    
    padding-left: 42px !important; 
}

#tabJogo .player-input-grid input[type="text"].has-image-bg,
#tabEditarJogo .player-input-grid input[type="text"].has-image-bg,
#goalDetailModal input[type="text"].has-image-bg,
#editGoalDetailModal input[type="text"].has-image-bg { /* For edit form modal */
    background-repeat: no-repeat;
    background-position: 8px center;  
    background-size: 28px 28px;    
    padding-left: 42px !important;  
}


#tabJogo input[readonly], #tabEditarJogo input[readonly] {
    background-color: #e2e6ea; 
    color: #495057;
    font-weight: 500;
}

#tabJogo .minute-input-group, #tabEditarJogo .minute-input-group {
    display: flex; align-items: center; gap: 12px; margin-bottom: 15px;
}
#tabJogo .minute-input-group input[type="number"], #tabEditarJogo .minute-input-group input[type="number"] { flex-grow: 1; }
#tabJogo .minute-list, #tabEditarJogo .minute-list { list-style: none; padding: 0; }

#tabJogo .minute-list-item, #tabEditarJogo .minute-list-item {
    padding: 10px 15px; font-size: 1em; 
    border-radius: 4px; margin-bottom: 5px;
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    transition: background-color 0.3s ease, border-left-color 0.3s ease; 
    border-left: 5px solid transparent; 
}

#tabJogo .minute-text-scorer-container, #tabEditarJogo .minute-text-scorer-container {
    display: flex;
    flex-direction: row;   
    justify-content: flex-start; 
    align-items: center;   
    flex-grow: 1;
    margin-right: 8px;
    flex-wrap: nowrap;     
}

#tabJogo .minute-text-scorer-container > *, #tabEditarJogo .minute-text-scorer-container > * { }

#tabJogo .minute-text-scorer-container .minute-value, #tabEditarJogo .minute-text-scorer-container .minute-value,
#tabJogo .minute-text-scorer-container .scorer-name, #tabEditarJogo .minute-text-scorer-container .scorer-name {
    white-space: nowrap; 
}

#tabJogo .minute-list-item .minute-value, #tabEditarJogo .minute-list-item .minute-value { 
    font-weight: 500; 
    cursor: pointer; 
    text-decoration: underline;
}

#tabJogo .minute-list-separator, #tabEditarJogo .minute-list-separator {
    margin: 0 8px; 
    color: #555;
}

#tabJogo .minute-list-player-image, #tabEditarJogo .minute-list-player-image {
    width: 24px; 
    height: 24px;
    object-fit: cover; 
    border-radius: 50%; 
    margin-right: 6px; 
    border: 1px solid #ddd; 
    flex-shrink: 0; 
}

#tabJogo .minute-list-item .scorer-name, #tabEditarJogo .minute-list-item .scorer-name { 
    font-style: normal; 
    color: #333; 
    margin-left: 0; 
    font-size: 1em; 
    font-weight: 500;
}

#tabJogo .minute-list-item .remove-minute-btn, #tabEditarJogo .minute-list-item .remove-minute-btn {
    background: none; border: none; color: #dc3545; cursor: pointer;
    font-weight: bold; font-size: 1.3em; 
    flex-shrink: 0; 
}
#tabJogo .minute-list-item.status-pending, #tabEditarJogo .minute-list-item.status-pending { background-color: #fde0e0; border-left-color: #dc3545; }
#tabJogo .minute-list-item.status-pending .minute-value, #tabEditarJogo .minute-list-item.status-pending .minute-value { color: #721c24; }
#tabJogo .minute-list-item.status-incomplete, #tabEditarJogo .minute-list-item.status-incomplete { background-color: #fff9e0; border-left-color: #ffc107; }
#tabJogo .minute-list-item.status-incomplete .minute-value, #tabEditarJogo .minute-list-item.status-incomplete .minute-value { color: #856404; }
#tabJogo .minute-list-item.status-complete, #tabEditarJogo .minute-list-item.status-complete { background-color: #d4edda; border-left-color: #28a745; }
#tabJogo .minute-list-item.status-complete .minute-value, #tabEditarJogo .minute-list-item.status-complete .minute-value { color: #155724; }


#tabJogo > form > button[type="submit"], #tabEditarJogo > form > button.update-button { /* Target specific submit for Jogo/EditarJogo */
    padding: 15px 30px; font-size: 1.25em; 
    font-weight: 600; width: auto; align-self: center; margin-top: 20px; 
}
 /* Create Jogo button */
#tabJogo > form > button[type="submit"] { background-color: #0069d9; }
#tabJogo > form > button[type="submit"]:hover { background-color: #0056b3; }

/* Update Jogo button - already styled by .update-button */
#tabEditarJogo > form > button.update-button {} /* Specificity if needed */


#tabJogo .suggestions-container, #tabEditarJogo .suggestions-container { border-color: #adb5bd; font-size: 1em; }
#tabJogo .suggestion-item, #tabEditarJogo .suggestion-item { padding: 12px; }

#tabJogo .player-input-grid, #tabEditarJogo .player-input-grid {
    display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
    gap: 18px; margin-bottom: 20px; 
}
#tabJogo .player-input-wrapper, #tabEditarJogo .player-input-wrapper {
    position: relative; 
    display: flex;      
    align-items: center;
}
#tabJogo .player-input-grid input[type="text"], #tabEditarJogo .player-input-grid input[type="text"] { 
    background-color: #fff; 
    width: 100%;
    box-sizing: border-box;
}
.player-input-clear-btn {
    position: absolute;
    right: 8px;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    color: #888;
    font-size: 1.4em; 
    font-weight: bold;
    cursor: pointer;
    padding: 0 5px; 
    line-height: 1;
    display: none; 
    z-index: 2; 
}
.player-input-clear-btn:hover { color: #333; }

#tabJogo .player-input-grid input[type="text"].has-image-bg.has-clear-btn,
#tabEditarJogo .player-input-grid input[type="text"].has-image-bg.has-clear-btn,
#goalDetailModal input[type="text"].has-image-bg.has-clear-btn,
#editGoalDetailModal input[type="text"].has-image-bg.has-clear-btn { 
    padding-right: 35px !important; 
}
#tabJogo .player-input-grid input[type="text"].has-clear-btn:not(.has-image-bg),
#tabEditarJogo .player-input-grid input[type="text"].has-clear-btn:not(.has-image-bg),
#goalDetailModal input[type="text"].has-clear-btn:not(.has-image-bg),
#editGoalDetailModal input[type="text"].has-clear-btn:not(.has-image-bg) {
    padding-right: 35px !important; 
}

#goalDetailModal .modal-content, #editGoalDetailModal .modal-content { padding: 30px; }
#goalDetailModal .modal-content label, #editGoalDetailModal .modal-content label { font-size: 1.15em; }
#goalDetailModal .modal-content input[type="text"], #editGoalDetailModal .modal-content input[type="text"],
#goalDetailModal .modal-content select, #editGoalDetailModal .modal-content select,
#goalDetailModal #goalZoneGridContainer, #editGoalDetailModal #editGoalZoneGridContainer { font-size: 1.05em; }

#goalZoneGridContainer, #editGoalZoneGridContainer {
    display: grid; grid-template-columns: repeat(3, 1fr);
    grid-template-rows: repeat(3, 55px); gap: 6px;
    margin-top: 5px; border: 1px solid #ccc; padding: 5px; border-radius: 4px;
}
.goal-zone-cell {
    display: flex; align-items: center; justify-content: center;
    border: 1px solid #ddd; background-color: #f9f9f9; cursor: pointer;
    font-size: 0.9em; text-align: center; transition: background-color 0.2s;
}
.goal-zone-cell:hover { background-color: #e9e9e9; }
.goal-zone-cell.selected { background-color: #007bff; color: white; border-color: #0056b3; }

#tabJogo .toggle-legend, #tabEditarJogo .toggle-legend {
    cursor: pointer; display: flex; justify-content: space-between; 
    align-items: center; width: 100%; 
    padding-left: 15px; padding-right: 15px; box-sizing: border-box; 
}
#tabJogo .toggle-legend .toggle-indicator, #tabEditarJogo .toggle-legend .toggle-indicator { 
    font-weight: bold; font-size: 1.2em; margin-left: 10px; 
}

#tabJogo fieldset.open .toggle-content, #tabEditarJogo fieldset.open .toggle-content { 
    animation: slideDown 0.3s ease-out; 
}
@keyframes slideDown {
    from { opacity: 0; transform: translateY(-10px); max-height: 0; }
    to { opacity: 1; transform: translateY(0); max-height: 1000px; } /* Ensure max-height is sufficient */
}

/* Specific styles for Edit Jogo Selection Area */
#editJogoSelectionFieldset {
    border-left: 5px solid #007bff; /* Blue accent */
    margin-bottom: 30px;
}
#editJogoSelectionFieldset legend {
    color: #007bff;
}
#editJogoFormContainer {
    display: none; /* Initially hidden until a game is loaded */
}

#editJogoSelectionFieldset > .form-grid > div {
     position: relative;
}


/* Styles for Relevant/Live Games Display */
#relevantGamesSection {
    background-color: #f0f3f5;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 30px; 
    box-shadow: 0 3px 6px rgba(0,0,0,0.07);
}

#relevantGamesSection h3 {
    margin-top: 0;
    margin-bottom: 18px;
    color: #0069d9;
    text-align: center;
    font-size: 1.7em;
    font-weight: 600;
    border-bottom: 2px solid #0069d9;
    padding-bottom: 12px;
}

.live-game-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.live-game-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 15px;
    background-color: #fff;
    border: 1px solid #ced4da;
    border-radius: 6px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
}
.live-game-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.08);
}

.live-game-item .team-info {
    display: flex;
    align-items: center;
    gap: 10px; 
    flex-basis: 40%; 
    min-width: 0; 
}
.live-game-item .team-info.home-team { 
    justify-content: flex-start;
}
.live-game-item .team-info.away-team { 
    justify-content: flex-end;
    text-align: right;
}

.live-game-item .team-info img {
    width: 28px; 
    height: 28px;
    object-fit: contain;
    border-radius: 50%;
    border: 1px solid #eee;
    background-color: #f8f9fa;
    flex-shrink: 0; 
}

.live-game-item .team-info span {
    font-weight: 500;
    font-size: 1.05em;
    color: #212529;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    flex-grow: 1; 
}

.live-game-item .game-details {
    font-weight: bold;
    color: #dc3545; 
    font-size: 1em;
    flex-basis: auto; 
    flex-shrink: 0; 
    padding: 0 10px;
    text-align: center;
}
.live-game-item .game-details .score {
    font-size: 1.1em;
}
.live-game-item .game-details .live-indicator { 
    display: block;
    font-size: 0.8em;
    color: #c82333; 
    font-weight: normal;
}
.live-game-item .game-details .jornada-info {
    display: block;
    font-size: 0.8em;
    color: #495057;
    font-weight: normal;
    margin-bottom: 3px;
}

.live-game-item .edit-game-btn {
    background-color: #007bff;
    color: white;
    border: none;
    padding: 6px 12px;
    font-size: 0.9em;
    border-radius: 4px;
    cursor: pointer;
    transition: background-color 0.2s ease;
    margin-left: 10px; 
    flex-shrink: 0; 
}

.live-game-item .edit-game-btn:hover {
    background-color: #0056b3;
}

.no-live-games {
    text-align: center;
    color: #6c757d;
    font-style: italic;
    padding: 15px;
    background-color: #fff;
    border: 1px dashed #ced4da;
    border-radius: 6px;
}

/* Styles for Tipo de Golo Radio Buttons */
.radio-group-inline {
    display: flex;
    flex-direction: row;
    align-items: center;
    gap: 20px; 
    flex-wrap: wrap; 
}
.radio-group-inline > div {
    display: flex;
    align-items: center;
}
.radio-group-inline input[type="radio"] {
    margin-right: 6px;
    vertical-align: middle;
    width: auto; 
    height: auto; 
}
.radio-group-inline label {
    margin-bottom: 0; 
    font-weight: normal; 
    font-size: 1em; 
    color: #343a40; 
}

    </style>
</head>
<body>

    <div class="container">
        <h1>Sporting Stats Edit</h1>

        <div class="tab-navigation">
            <button class="tab-button" onclick="openTab(event, 'tabJogo')">Criar Jogo</button>
            <button class="tab-button" onclick="openTab(event, 'tabEditarJogo')">Editar Jogo</button>
            <button class="tab-button" onclick="openTab(event, 'tabClube')">Criar Clube</button>
            <button class="tab-button" onclick="openTab(event, 'tabPosicao')">Criar Posição</button>
            <button class="tab-button" onclick="openTab(event, 'tabJogador')">Criar Jogador</button>
            <button class="tab-button" onclick="openTab(event, 'tabPais')">Criar País</button>
        </div>

        <!-- Tab Criar Jogo (Existing) -->
        <div id="tabJogo" class="tab-content">
            <h2 class="form-section-title">Criar Novo Jogo</h2>
            <form id="formJogo">
                <fieldset class="general-info-fieldset"> 
                    <legend>Informações Gerais do Jogo</legend>
                    <div class="form-grid two-cols">
                        <div>
                            <label for="jogoTemporada">Temporada:</label>
                            <select id="jogoTemporada" required></select>
                        </div>
                        <div>
                            <label for="jogoJornada">Jornada:</label>
                            <select id="jogoJornada" required></select>
                        </div>
                        <div>
                            <label for="jogoClubeCasa">Clube Casa:</label>
                            <input type="text" id="jogoClubeCasa" autocomplete="off" placeholder="Pesquisar clube..." required>
                            <div id="clubeCasaSuggestions" class="suggestions-container" style="display: none;"></div>
                        </div>
                        <div>
                            <label for="jogoClubeFora">Clube Fora:</label>
                            <input type="text" id="jogoClubeFora" autocomplete="off" placeholder="Pesquisar clube..." required>
                            <div id="clubeForaSuggestions" class="suggestions-container" style="display: none;"></div>
                        </div>
                    </div>
                </fieldset>

                <fieldset class="sporting-goals-fieldset"> 
                    <legend>Golos do Sporting</legend>
                    <div class="form-grid two-cols">
                        <div>
                            <label for="jogoMinutoGoloMarcado">Minuto do Golo Marcado (Sporting):</label>
                            <div class="minute-input-group">
                                <input type="number" id="jogoMinutoGoloMarcadoInput" placeholder="Ex: 17" min="1">
                                <button type="button" class="action-button secondary" id="addMinutoGoloMarcadoBtn">Adicionar</button>
                            </div>
                            <ul id="listaMinutosGolosMarcados" class="minute-list"></ul>
                        </div>
                        <div>
                            <label for="jogoMinutoGoloSofrido">Minuto do Golo Sofrido (pelo Sporting):</label>
                            <div class="minute-input-group">
                                <input type="number" id="jogoMinutoGoloSofridoInput" placeholder="Ex: 48" min="1">
                                <button type="button" class="action-button secondary" id="addMinutoGoloSofridoBtn">Adicionar</button>
                            </div>
                            <ul id="listaMinutosGolosSofridos" class="minute-list"></ul>
                        </div>
                    </div>
                </fieldset>

                <fieldset id="fieldsetPlacarStats" class="placar-stats-fieldset"> 
                    <legend id="legendPlacarStats" class="toggle-legend">
                        Placar e Estatísticas (Automático)
                        <span class="toggle-indicator">[+]</span>
                    </legend>
                    <div class="toggle-content" style="display: none;">
                        <div style="margin-bottom: 15px;">
                            <label for="jogoNomeJogo">Nome do Jogo (Automático):</label>
                            <input type="text" id="jogoNomeJogo" readonly>
                        </div>
                        <div class="form-grid three-cols">
                            <div><label for="jogoGMCasa">Golos Marcados Equipa da Casa:</label><input type="text" id="jogoGMCasa" readonly></div>
                            <div><label for="jogoResultadoFinal">Resultado Final:</label><input type="text" id="jogoResultadoFinal" readonly></div>
                            <div><label for="jogoGMFora">Golos Marcados Equipa de Fora:</label><input type="text" id="jogoGMFora" readonly></div>
                        </div>
                         <div class="form-grid two-cols" style="margin-top: 15px;">
                            <div><label for="jogoGSCasa">Golos Sofridos Equipa da Casa:</label><input type="text" id="jogoGSCasa" readonly></div>
                            <div><label for="jogoGSFora">Golos Sofridos Equipa de Fora:</label><input type="text" id="jogoGSFora" readonly></div>
                            
                            <div><label for="jogoMarcados1P">Golos Marcados Sporting (1ª Parte):</label><input type="text" id="jogoMarcados1P" readonly></div>
                            <div><label for="jogoMarcados2P">Golos Marcados Sporting (2ª Parte):</label><input type="text" id="jogoMarcados2P" readonly></div>
                            <div><label for="jogoSofridos1P">Golos Sofridos Sporting (1ª Parte):</label><input type="text" id="jogoSofridos1P" readonly></div>
                            <div><label for="jogoSofridos2P">Golos Sofridos Sporting (2ª Parte):</label><input type="text" id="jogoSofridos2P" readonly></div>
                            <div><label for="jogoEstado">Estado (Resultado Sporting):</label><input type="text" id="jogoEstado" readonly></div>
                        </div>
                    </div>
                </fieldset>

                <fieldset id="fieldsetPlantel" class="plantel-fieldset"> 
                    <legend>Plantel</legend>
                    <div>
                        <label>11 Inicial (11 jogadores):</label>
                        <div id="jogo11InicialContainer" class="player-input-grid"></div>
                    </div>
                    <div>
                        <label>Suplentes (11 jogadores):</label>
                        <div id="jogoSuplentesContainer" class="player-input-grid"></div>
                    </div>
                </fieldset>

                <fieldset id="fieldsetEstadoJogo" class="estado-jogo-fieldset">
                    <legend>Estado do Jogo</legend>
                    <div class="estado-jogo-checkbox-container">
                        <div class="checkbox-item-wrapper">
                            <input type="checkbox" id="jogoLive">
                            <label for="jogoLive">Live</label>
                        </div>
                        <div class="checkbox-item-wrapper">
                            <input type="checkbox" id="jogoTerminado">
                            <label for="jogoTerminado">Terminado</label>
                        </div>
                        <div class="checkbox-item-wrapper">
                            <input type="checkbox" id="jogoFuturo">
                            <label for="jogoFuturo">Futuro</label>
                        </div>
                    </div>
                </fieldset>

                <button type="submit">Criar Jogo</button>
            </form>
            <div id="statusJogo" class="status-message"></div>
        </div>

        <!-- Tab Editar Jogo (New) -->
        <div id="tabEditarJogo" class="tab-content">
             <!-- SEÇÃO PARA JOGOS RELEVANTES (AO VIVO / FUTUROS) -->
            <div id="relevantGamesSection" style="display: none;">
                <h3>Jogos Em Destaque (Ao Vivo / Futuros)</h3>
                <div id="relevantGamesListDisplay" class="live-game-list">
                    <!-- Os jogos serão inseridos aqui pelo JavaScript -->
                </div>
            </div>
            <!-- FIM DA SEÇÃO -->

            <h2>Editar Jogo Existente</h2>
            <fieldset id="editJogoSelectionFieldset">
                <legend>Selecionar Jogo para Editar</legend>
                <div class="form-grid two-cols">
                    <div>
                        <label for="editJogoTemporadaSelect">Temporada:</label>
                        <select id="editJogoTemporadaSelect" required></select>
                    </div>
                    <div>
                        <label for="editJogoSearchInput">Pesquisar Jogo (Nome do Jogo):</label>
                        <input type="text" id="editJogoSearchInput" autocomplete="off" placeholder="Digite para pesquisar jogos..." disabled>
                        <div id="editJogoSuggestionsContainer" class="suggestions-container" style="display: none;"></div>
                    </div>
                </div>
            </fieldset>

            <div id="editJogoFormContainer" style="display:none;">
                <h2 class="form-section-title" style="margin-top: 0;">Detalhes do Jogo</h2>
                <form id="formEditarJogo">
                    <input type="hidden" id="editJogoDocId"> 
                    
                    <fieldset class="general-info-fieldset">
                        <legend>Informações Gerais do Jogo</legend>
                        <div class="form-grid two-cols">
                            <div>
                                <label for="editJogoJornada">Jornada:</label>
                                <select id="editJogoJornada" required></select>
                            </div>
                            <div>
                                <label for="editJogoTemporadaDisplay">Temporada (Selecionada):</label>
                                <input type="text" id="editJogoTemporadaDisplay" readonly>
                            </div>
                            <div>
                                <label for="editJogoClubeCasa">Clube Casa:</label>
                                <input type="text" id="editJogoClubeCasa" autocomplete="off" placeholder="Pesquisar clube..." required>
                                <div id="editClubeCasaSuggestions" class="suggestions-container" style="display: none;"></div>
                            </div>
                            <div>
                                <label for="editJogoClubeFora">Clube Fora:</label>
                                <input type="text" id="editJogoClubeFora" autocomplete="off" placeholder="Pesquisar clube..." required>
                                <div id="editClubeForaSuggestions" class="suggestions-container" style="display: none;"></div>
                            </div>
                        </div>
                    </fieldset>

                    <fieldset class="sporting-goals-fieldset">
                        <legend>Golos do Sporting</legend>
                        <div class="form-grid two-cols">
                            <div>
                                <label for="editJogoMinutoGoloMarcadoInput">Minuto do Golo Marcado (Sporting):</label>
                                <div class="minute-input-group">
                                    <input type="number" id="editJogoMinutoGoloMarcadoInput" placeholder="Ex: 17" min="1">
                                    <button type="button" class="action-button secondary" id="editAddMinutoGoloMarcadoBtn">Adicionar</button>
                                </div>
                                <ul id="editListaMinutosGolosMarcados" class="minute-list"></ul>
                            </div>
                            <div>
                                <label for="editJogoMinutoGoloSofridoInput">Minuto do Golo Sofrido (pelo Sporting):</label>
                                <div class="minute-input-group">
                                    <input type="number" id="editJogoMinutoGoloSofridoInput" placeholder="Ex: 48" min="1">
                                    <button type="button" class="action-button secondary" id="editAddMinutoGoloSofridoBtn">Adicionar</button>
                                </div>
                                <ul id="editListaMinutosGolosSofridos" class="minute-list"></ul>
                            </div>
                        </div>
                    </fieldset>

                    <fieldset class="placar-stats-fieldset" id="editFieldsetPlacarStats">
                        <legend class="toggle-legend" id="editLegendPlacarStats">
                            Placar e Estatísticas (Automático)
                            <span class="toggle-indicator">[+]</span>
                        </legend>
                        <div class="toggle-content" style="display: none;">
                            <div style="margin-bottom: 15px;">
                                <label for="editJogoNomeJogo">Nome do Jogo (Automático):</label>
                                <input type="text" id="editJogoNomeJogo" readonly>
                            </div>
                            <div class="form-grid three-cols">
                                <div><label for="editJogoGMCasa">Golos Marcados Equipa da Casa:</label><input type="text" id="editJogoGMCasa" readonly></div>
                                <div><label for="editJogoResultadoFinal">Resultado Final:</label><input type="text" id="editJogoResultadoFinal" readonly></div>
                                <div><label for="editJogoGMFora">Golos Marcados Equipa de Fora:</label><input type="text" id="editJogoGMFora" readonly></div>
                            </div>
                             <div class="form-grid two-cols" style="margin-top: 15px;">
                                <div><label for="editJogoGSCasa">Golos Sofridos Equipa da Casa:</label><input type="text" id="editJogoGSCasa" readonly></div>
                                <div><label for="editJogoGSFora">Golos Sofridos Equipa de Fora:</label><input type="text" id="editJogoGSFora" readonly></div>
                                
                                <div><label for="editJogoMarcados1P">Golos Marcados Sporting (1ª Parte):</label><input type="text" id="editJogoMarcados1P" readonly></div>
                                <div><label for="editJogoMarcados2P">Golos Marcados Sporting (2ª Parte):</label><input type="text" id="editJogoMarcados2P" readonly></div>
                                <div><label for="editJogoSofridos1P">Golos Sofridos Sporting (1ª Parte):</label><input type="text" id="editJogoSofridos1P" readonly></div>
                                <div><label for="editJogoSofridos2P">Golos Sofridos Sporting (2ª Parte):</label><input type="text" id="editJogoSofridos2P" readonly></div>
                                <div><label for="editJogoEstado">Estado (Resultado Sporting):</label><input type="text" id="editJogoEstado" readonly></div>
                            </div>
                        </div>
                    </fieldset>

                    <fieldset class="plantel-fieldset" id="editFieldsetPlantel">
                        <legend>Plantel</legend>
                        <div>
                            <label>11 Inicial (11 jogadores):</label>
                            <div id="editJogo11InicialContainer" class="player-input-grid"></div>
                        </div>
                        <div>
                            <label>Suplentes (11 jogadores):</label>
                            <div id="editJogoSuplentesContainer" class="player-input-grid"></div>
                        </div>
                    </fieldset>

                    <fieldset class="estado-jogo-fieldset" id="editFieldsetEstadoJogo">
                        <legend>Estado do Jogo</legend>
                        <div class="estado-jogo-checkbox-container">
                            <div class="checkbox-item-wrapper">
                                <input type="checkbox" id="editJogoLive">
                                <label for="editJogoLive">Live</label>
                            </div>
                            <div class="checkbox-item-wrapper">
                                <input type="checkbox" id="editJogoTerminado">
                                <label for="editJogoTerminado">Terminado</label>
                            </div>
                            <div class="checkbox-item-wrapper">
                                <input type="checkbox" id="editJogoFuturo">
                                <label for="editJogoFuturo">Futuro</label>
                            </div>
                        </div>
                    </fieldset>

                    <button type="submit" class="update-button">Guardar Alterações</button>
                </form>
            </div> 
            <div id="statusEditarJogo" class="status-message"></div>
        </div>


        <!-- Tab Criar Clube -->
        <div id="tabClube" class="tab-content">
            <h2>Criar Novo Clube</h2>
            <form id="formClube">
                <div><label for="clubeNome">Nome do Clube:</label><input type="text" id="clubeNome" required></div>
                <div><label for="clubeLogo">Link do Logo:</label><input type="url" id="clubeLogo" required></div>
                <div><label for="clubeRegiao">Região:</label><input type="text" id="clubeRegiao" required></div>
                <div><label for="clubeCidade">Cidade:</label><input type="text" id="clubeCidade" required></div>
                <button type="submit">Adicionar Clube</button>
            </form>
            <div id="statusClube" class="status-message"></div>
        </div>

        <!-- Tab Criar Posição -->
        <div id="tabPosicao" class="tab-content">
            <h2>Criar Nova Posição</h2>
            <form id="formPosicao">
                <div><label for="posicaoAbreviacao">Abreviação (ex: DC, PL):</label><input type="text" id="posicaoAbreviacao" required maxlength="3"></div>
                <div><label for="posicaoGenericaForm">Posição Genérica (ex: Defesa, Avançado):</label><input type="text" id="posicaoGenericaForm" required></div>
                <button type="submit">Adicionar Posição</button>
            </form>
            <div id="statusPosicao" class="status-message"></div>
        </div>

        <!-- Tab Criar Jogador -->
        <div id="tabJogador" class="tab-content">
            <h2>Criar Novo Jogador</h2>
            <form id="formJogador">
                <div><label for="jogadorNome">Nome do Jogador:</label><input type="text" id="jogadorNome" required></div>
                <div><label for="jogadorImagem">Link da Imagem:</label><input type="url" id="jogadorImagem" required></div>
                <div>
                    <label for="jogadorPosEspecifica">Posição Específica:</label>
                    <select id="jogadorPosEspecifica" required><option value="">A carregar posições...</option></select>
                </div>
                <div><label for="jogadorPosGenerica">Posição Genérica (Automático):</label><input type="text" id="jogadorPosGenerica" readonly></div>
                <div>
                    <label for="jogadorPaisNome">Nome do País:</label>
                    <input type="text" id="jogadorPaisNome" autocomplete="off" placeholder="Comece a digitar..." required>
                    <div id="paisSuggestions" class="suggestions-container" style="display: none;"></div>
                </div>
                <button type="submit">Adicionar Jogador</button>
            </form>
            <div id="statusJogador" class="status-message"></div>
        </div>

        <!-- Tab Criar País -->
        <div id="tabPais" class="tab-content">
            <h2>Criar Novo País</h2>
            <form id="formPais">
                <div><label for="paisNome">Nome do País:</label><input type="text" id="paisNome" required></div>
                <div><label for="paisBandeira">Link da Bandeira:</label><input type="url" id="paisBandeira" required></div>
                <div>
                    <label for="paisContinenteSelect">Continente:</label>
                    <select id="paisContinenteSelect" required>
                        <option value="">A carregar continentes...</option>
                    </select>
                </div>
                <button type="submit">Adicionar País</button>
            </form>
            <div id="statusPais" class="status-message"></div>
        </div>
    </div> <!-- End of .container -->

    <!-- Modal for Goal Details (CREATE JOGO) -->
    <div id="goalDetailModal" class="modal">
        <div class="modal-content">
            <span class="modal-close-btn" id="closeGoalDetailModalBtn">×</span>
            <h3 id="goalDetailModalTitle">Detalhes do Golo</h3>
            <form id="formGoalDetail">
                <input type="hidden" id="goalDetailType">
                <input type="hidden" id="goalDetailMinute">
                
                <div id="goalDetailScorerSection">
                    <label for="goalDetailJogador">Marcador (Jogador do Sporting):</label>
                    <input type="text" id="goalDetailJogador" autocomplete="off" placeholder="Pesquisar jogador...">
                    <div id="goalDetailJogadorSuggestions" class="suggestions-container" style="display: none;"></div>
                </div>
                
                <div>
                    <label for="goalDetailZonaGrid">Zona do Golo:</label>
                    <div id="goalZoneGridContainer"></div>
                    <input type="hidden" id="selectedGoalZoneHidden">
                </div>

                <div id="goalDetailAssistenciaSection" style="margin-top:15px;">
                    <label for="goalDetailAssistencia">Assistência (Jogador do Sporting):</label>
                    <input type="text" id="goalDetailAssistencia" autocomplete="off" placeholder="Pesquisar jogador...">
                    <div id="goalDetailAssistenciaSuggestions" class="suggestions-container" style="display: none;"></div>
                </div>

                <!-- NOVA SECÇÃO TIPO DE GOLO (CRIAR JOGO) -->
                <div id="goalDetailTipoGoloSection" style="margin-top:15px;">
                    <label>Tipo de Golo:</label>
                    <div class="radio-group-inline">
                        <div>
                            <input type="radio" id="tipoGoloNormalCreate" name="tipoGoloCreate" value="Normal" checked>
                            <label for="tipoGoloNormalCreate">Normal</label>
                        </div>
                        <div>
                            <input type="radio" id="tipoGoloAutoCreate" name="tipoGoloCreate" value="AutoGolo">
                            <label for="tipoGoloAutoCreate">AutoGolo</label>
                        </div>
                        <div>
                            <input type="radio" id="tipoGoloPenaltyCreate" name="tipoGoloCreate" value="Penalty">
                            <label for="tipoGoloPenaltyCreate">Penalty</label>
                        </div>
                    </div>
                </div>
                <button type="button" id="saveGoalDetailBtn" class="action-button" style="margin-top:20px;">Guardar Detalhes</button>
            </form>
        </div>
    </div>

    <!-- Modal for Goal Details (EDIT JOGO) -->
    <div id="editGoalDetailModal" class="modal">
        <div class="modal-content">
            <span class="modal-close-btn" id="editCloseGoalDetailModalBtn">×</span>
            <h3 id="editGoalDetailModalTitle">Detalhes do Golo (Editar)</h3>
            <form id="editFormGoalDetail">
                <input type="hidden" id="editGoalDetailType">
                <input type="hidden" id="editGoalDetailMinute">
                <input type="hidden" id="editGoalDetailIndex">
                
                <div id="editGoalDetailScorerSection">
                    <label for="editGoalDetailJogador">Marcador (Jogador do Sporting):</label>
                    <input type="text" id="editGoalDetailJogador" autocomplete="off" placeholder="Pesquisar jogador...">
                    <div id="editGoalDetailJogadorSuggestions" class="suggestions-container" style="display: none;"></div>
                </div>
                
                <div>
                    <label for="editGoalDetailZonaGrid">Zona do Golo:</label>
                    <div id="editGoalZoneGridContainer"></div>
                    <input type="hidden" id="editSelectedGoalZoneHidden">
                </div>

                <div id="editGoalDetailAssistenciaSection" style="margin-top:15px;">
                    <label for="editGoalDetailAssistencia">Assistência (Jogador do Sporting):</label>
                    <input type="text" id="editGoalDetailAssistencia" autocomplete="off" placeholder="Pesquisar jogador...">
                    <div id="editGoalDetailAssistenciaSuggestions" class="suggestions-container" style="display: none;"></div>
                </div>

                <!-- NOVA SECÇÃO TIPO DE GOLO (EDITAR JOGO) -->
                <div id="editGoalDetailTipoGoloSection" style="margin-top:15px;">
                    <label>Tipo de Golo:</label>
                    <div class="radio-group-inline">
                        <div>
                            <input type="radio" id="tipoGoloNormalEdit" name="tipoGoloEdit" value="Normal" checked>
                            <label for="tipoGoloNormalEdit">Normal</label>
                        </div>
                        <div>
                            <input type="radio" id="tipoGoloAutoEdit" name="tipoGoloEdit" value="AutoGolo">
                            <label for="tipoGoloAutoEdit">AutoGolo</label>
                        </div>
                        <div>
                            <input type="radio" id="tipoGoloPenaltyEdit" name="tipoGoloEdit" value="Penalty">
                            <label for="tipoGoloPenaltyEdit">Penalty</label>
                        </div>
                    </div>
                </div>
                <button type="button" id="editSaveGoalDetailBtn" class="action-button" style="margin-top:20px;">Guardar Detalhes</button>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, collection, getDocs, serverTimestamp, addDoc, query, where, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    
        const firebaseConfig = {
            apiKey: "AIzaSyASIFSwhZj8B4ON6fVGjNixgLW-CL39CnI", // SUBSTITUA COM SUA API KEY REAL
            authDomain: "sporting-stats.firebaseapp.com",
            projectId: "sporting-stats",
            storageBucket: "sporting-stats.firebasestorage.app",
            messagingSenderId: "584175657940",
            appId: "1:584175657940:web:7e57b0b83f2b22646d6c41"
        };
    
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
    
        // === UTILITY FUNCTION ===
        function generateUUID() {
            return crypto.randomUUID();
        }
    
        // === GLOBAL DATA CACHES ===
        let posicoesMap = new Map();
        let allPaises = [];
        let allContinentesSet = new Set();
        let allClubes = [];
        let allJogadores = [];
        const goalZoneNames = [
            "Esquerda Cima", "Meio Cima", "Direita Cima",
            "Esquerda Centro", "Meio Centro", "Direita Centro",
            "Esquerda Baixo", "Meio Baixo", "Direita Baixo"
        ];
        let sportingClubeDetalhes = null;
        const SPORTING_CP_CANONICAL_NAME = "Sporting CP";
        const sportingCanonicoNomesInputCheck = ["sporting cp", "sporting"];
    
        // === STATE VARIABLES FOR CREATE JOGO ===
        let createMinutosGolosMarcados = [];
        let createMinutosGolosSofridos = [];
    
        // === STATE VARIABLES FOR EDIT JOGO ===
        let editMinutosGolosMarcados = [];
        let editMinutosGolosSofridos = [];
        let loadedGamesForSeason = []; 
        let currentEditingGameData = null; 
    
        // === DOM ELEMENTS (CREATE JOGO - general) ===
        const jogoLiveCheckbox = document.getElementById('jogoLive');
        const jogoTerminadoCheckbox = document.getElementById('jogoTerminado');
        const jogoFuturoCheckbox = document.getElementById('jogoFuturo');
        const jogoTemporadaSelect = document.getElementById('jogoTemporada');
        const jogoJornadaSelect = document.getElementById('jogoJornada');
        const jogoClubeCasaInput = document.getElementById('jogoClubeCasa');
        const clubeCasaSuggestions = document.getElementById('clubeCasaSuggestions');
        const jogoClubeForaInput = document.getElementById('jogoClubeFora');
        const clubeForaSuggestions = document.getElementById('clubeForaSuggestions');
        const jogoMinutoGoloMarcadoInput = document.getElementById('jogoMinutoGoloMarcadoInput');
        const addMinutoGoloMarcadoBtn = document.getElementById('addMinutoGoloMarcadoBtn');
        const listaMinutosGolosMarcados = document.getElementById('listaMinutosGolosMarcados');
        const jogoMinutoGoloSofridoInput = document.getElementById('jogoMinutoGoloSofridoInput');
        const addMinutoGoloSofridoBtn = document.getElementById('addMinutoGoloSofridoBtn');
        const listaMinutosGolosSofridos = document.getElementById('listaMinutosGolosSofridos');
        const jogoNomeJogo = document.getElementById('jogoNomeJogo');
        const jogoGMCasa = document.getElementById('jogoGMCasa');
        const jogoGMFora = document.getElementById('jogoGMFora');
        const jogoGSCasa = document.getElementById('jogoGSCasa');
        const jogoGSFora = document.getElementById('jogoGSFora');
        const jogoResultadoFinal = document.getElementById('jogoResultadoFinal');
        const jogoMarcados1P = document.getElementById('jogoMarcados1P');
        const jogoMarcados2P = document.getElementById('jogoMarcados2P');
        const jogoSofridos1P = document.getElementById('jogoSofridos1P');
        const jogoSofridos2P = document.getElementById('jogoSofridos2P');
        const jogoEstado = document.getElementById('jogoEstado');
        const goalDetailModal = document.getElementById('goalDetailModal');
        const closeGoalDetailModalBtn = document.getElementById('closeGoalDetailModalBtn');
        const goalDetailModalTitle = document.getElementById('goalDetailModalTitle');
        const formGoalDetail = document.getElementById('formGoalDetail');
        const goalDetailTypeInput = document.getElementById('goalDetailType');
        const goalDetailMinuteInput = document.getElementById('goalDetailMinute');
        const goalDetailScorerSection = document.getElementById('goalDetailScorerSection');
        const goalDetailJogadorInput = document.getElementById('goalDetailJogador');
        const goalDetailJogadorSuggestions = document.getElementById('goalDetailJogadorSuggestions');
        const goalZoneGridContainer = document.getElementById('goalZoneGridContainer');
        const selectedGoalZoneHidden = document.getElementById('selectedGoalZoneHidden');
        const goalDetailAssistenciaSection = document.getElementById('goalDetailAssistenciaSection');
        const goalDetailAssistenciaInput = document.getElementById('goalDetailAssistencia');
        const goalDetailAssistenciaSuggestions = document.getElementById('goalDetailAssistenciaSuggestions');
        const saveGoalDetailBtn = document.getElementById('saveGoalDetailBtn');
        const createJogo11InicialContainer = document.getElementById('jogo11InicialContainer');
        const createJogoSuplentesContainer = document.getElementById('jogoSuplentesContainer');
    
        // === DOM ELEMENTS (EDIT JOGO - specific) ===
        const editJogoTemporadaSelect = document.getElementById('editJogoTemporadaSelect');
        const editJogoSearchInput = document.getElementById('editJogoSearchInput');
        const editJogoSuggestionsContainer = document.getElementById('editJogoSuggestionsContainer');
        const editJogoFormContainer = document.getElementById('editJogoFormContainer');
        const formEditarJogo = document.getElementById('formEditarJogo');
        const editJogoDocIdInput = document.getElementById('editJogoDocId');
        const editJogoJornadaSelect = document.getElementById('editJogoJornada');
        const editJogoTemporadaDisplay = document.getElementById('editJogoTemporadaDisplay');
        const editJogoClubeCasaInput = document.getElementById('editJogoClubeCasa');
        const editClubeCasaSuggestions = document.getElementById('editClubeCasaSuggestions');
        const editJogoClubeForaInput = document.getElementById('editJogoClubeFora');
        const editClubeForaSuggestions = document.getElementById('editClubeForaSuggestions');
        const editJogoMinutoGoloMarcadoInput = document.getElementById('editJogoMinutoGoloMarcadoInput');
        const editAddMinutoGoloMarcadoBtn = document.getElementById('editAddMinutoGoloMarcadoBtn');
        const editListaMinutosGolosMarcados = document.getElementById('editListaMinutosGolosMarcados');
        const editJogoMinutoGoloSofridoInput = document.getElementById('editJogoMinutoGoloSofridoInput');
        const editAddMinutoGoloSofridoBtn = document.getElementById('editAddMinutoGoloSofridoBtn');
        const editListaMinutosGolosSofridos = document.getElementById('editListaMinutosGolosSofridos');
        const editJogoNomeJogo = document.getElementById('editJogoNomeJogo');
        const editJogoGMCasa = document.getElementById('editJogoGMCasa');
        const editJogoGMFora = document.getElementById('editJogoGMFora');
        const editJogoGSCasa = document.getElementById('editJogoGSCasa');
        const editJogoGSFora = document.getElementById('editJogoGSFora');
        const editJogoResultadoFinal = document.getElementById('editJogoResultadoFinal');
        const editJogoMarcados1P = document.getElementById('editJogoMarcados1P');
        const editJogoMarcados2P = document.getElementById('editJogoMarcados2P');
        const editJogoSofridos1P = document.getElementById('editJogoSofridos1P');
        const editJogoSofridos2P = document.getElementById('editJogoSofridos2P');
        const editJogoEstado = document.getElementById('editJogoEstado');
        const editJogoLiveCheckbox = document.getElementById('editJogoLive');
        const editJogoTerminadoCheckbox = document.getElementById('editJogoTerminado');
        const editJogoFuturoCheckbox = document.getElementById('editJogoFuturo');
        const editJogo11InicialContainer = document.getElementById('editJogo11InicialContainer');
        const editJogoSuplentesContainer = document.getElementById('editJogoSuplentesContainer');
        const editGoalDetailModal = document.getElementById('editGoalDetailModal');
        const editCloseGoalDetailModalBtn = document.getElementById('editCloseGoalDetailModalBtn');
        const editGoalDetailModalTitle = document.getElementById('editGoalDetailModalTitle');
        const editGoalDetailTypeInput = document.getElementById('editGoalDetailType');
        const editGoalDetailMinuteInput = document.getElementById('editGoalDetailMinute');
        const editGoalDetailScorerSection = document.getElementById('editGoalDetailScorerSection');
        const editGoalDetailJogadorInput = document.getElementById('editGoalDetailJogador');
        const editGoalDetailJogadorSuggestions = document.getElementById('editGoalDetailJogadorSuggestions');
        const editGoalZoneGridContainer = document.getElementById('editGoalZoneGridContainer');
        const editSelectedGoalZoneHidden = document.getElementById('editSelectedGoalZoneHidden');
        const editGoalDetailAssistenciaSection = document.getElementById('editGoalDetailAssistenciaSection');
        const editGoalDetailAssistenciaInput = document.getElementById('editGoalDetailAssistencia');
        const editGoalDetailAssistenciaSuggestions = document.getElementById('editGoalDetailAssistenciaSuggestions');
        const editSaveGoalDetailBtn = document.getElementById('editSaveGoalDetailBtn');
        const relevantGamesSection = document.getElementById('relevantGamesSection'); 
        const relevantGamesListDisplay = document.getElementById('relevantGamesListDisplay');
        
        // === UTILITY FUNCTIONS ===
        function showStatus(elementId, message, isSuccess) {
            const statusEl = document.getElementById(elementId);
            if (!statusEl) { console.warn("Status element not found:", elementId); return; }
            statusEl.textContent = message;
            statusEl.className = 'status-message ' + (isSuccess ? 'success' : 'error');
            setTimeout(() => { statusEl.textContent = ''; statusEl.className = 'status-message'; }, 5000);
        }
    
        function syncGameStatusCheckboxes(liveCb, termCb, futCb) {
            const source = this; 
            if (source === termCb && termCb.checked) {
                liveCb.checked = false;
                futCb.checked = false;
            } else if (source === liveCb && liveCb.checked) {
                termCb.checked = false;
                futCb.checked = false;
            } else if (source === futCb && futCb.checked) {
                liveCb.checked = false;
                termCb.checked = false;
            }
            if (termCb.checked) {
                liveCb.checked = false;
                futCb.checked = false;
            } else if (liveCb.checked) {
                futCb.checked = false; 
            } else if (!futCb.checked && !liveCb.checked && !termCb.checked) { 
                 futCb.checked = true;
            }
        }
        
        jogoLiveCheckbox.addEventListener('change', function() { syncGameStatusCheckboxes.call(this, jogoLiveCheckbox, jogoTerminadoCheckbox, jogoFuturoCheckbox); updateCalculatedScores('create'); });
        jogoTerminadoCheckbox.addEventListener('change', function() { syncGameStatusCheckboxes.call(this, jogoLiveCheckbox, jogoTerminadoCheckbox, jogoFuturoCheckbox); updateCalculatedScores('create'); });
        jogoFuturoCheckbox.addEventListener('change', function() { syncGameStatusCheckboxes.call(this, jogoLiveCheckbox, jogoTerminadoCheckbox, jogoFuturoCheckbox); updateCalculatedScores('create'); });
        
        editJogoLiveCheckbox.addEventListener('change', function() { syncGameStatusCheckboxes.call(this, editJogoLiveCheckbox, editJogoTerminadoCheckbox, editJogoFuturoCheckbox); updateCalculatedScores('edit'); });
        editJogoTerminadoCheckbox.addEventListener('change', function() { syncGameStatusCheckboxes.call(this, editJogoLiveCheckbox, editJogoTerminadoCheckbox, editJogoFuturoCheckbox); updateCalculatedScores('edit'); });
        editJogoFuturoCheckbox.addEventListener('change', function() { syncGameStatusCheckboxes.call(this, editJogoLiveCheckbox, editJogoTerminadoCheckbox, editJogoFuturoCheckbox); updateCalculatedScores('edit');});
    
        async function displayRelevantGames() {
            if (!relevantGamesSection || !relevantGamesListDisplay) {
                console.warn("Relevant games display elements not found. Check IDs in HTML and JS.");
                return;
            }
            relevantGamesListDisplay.innerHTML = ''; 
            relevantGamesSection.style.display = 'none'; 
            try {
                const liveGamesQuery = query(collection(db, "jogos"), where("jogoLive", "==", true));
                const liveGamesSnapshot = await getDocs(liveGamesQuery);
                const futureGamesQuery = query(collection(db, "jogos"), where("jogoFuturo", "==", true));
                const futureGamesSnapshot = await getDocs(futureGamesQuery);
                let allRelevantGames = [];
                const gameIds = new Set(); 
                liveGamesSnapshot.forEach(docSnap => {
                    if (!gameIds.has(docSnap.id)) {
                        allRelevantGames.push({ id: docSnap.id, ...docSnap.data(), statusIndicator: "LIVE" });
                        gameIds.add(docSnap.id);
                    }
                });
                futureGamesSnapshot.forEach(docSnap => {
                    if (!gameIds.has(docSnap.id)) { 
                        allRelevantGames.push({ id: docSnap.id, ...docSnap.data(), statusIndicator: "FUTURO" });
                        gameIds.add(docSnap.id);
                    }
                });
                if (allRelevantGames.length === 0) {
                    relevantGamesListDisplay.innerHTML = '<div class="no-live-games">Nenhum jogo em destaque (Ao Vivo ou Futuro) neste momento.</div>';
                    relevantGamesSection.style.display = 'block'; 
                    return;
                }
                allRelevantGames.sort((a, b) => {
                    const jornadaA = parseInt(a.jornada) || 0; 
                    const jornadaB = parseInt(b.jornada) || 0;
                    if (jornadaA !== jornadaB) {
                        return jornadaA - jornadaB; 
                    }
                    if (a.statusIndicator === "LIVE" && b.statusIndicator !== "LIVE") return -1;
                    if (a.statusIndicator !== "LIVE" && b.statusIndicator === "LIVE") return 1;
                    return (a.nomeJogo || "").localeCompare(b.nomeJogo || "");
                });
                let gameItemsHtml = '';
                allRelevantGames.forEach(jogo => {
                    const clubeCasa = allClubes.find(c => c.nome === jogo.clubeCasaNome);
                    const clubeFora = allClubes.find(c => c.nome === jogo.clubeForaNome);
                    const logoCasaSrc = clubeCasa?.logo || ''; 
                    const logoForaSrc = clubeFora?.logo || '';
                    const jornadaInfo = jogo.jornada ? `<span class="jornada-info">Jornada ${jogo.jornada}</span>` : '<span class="jornada-info">Jornada N/D</span>';
                    let gameCenterContent = `vs <span class="live-indicator">${jogo.statusIndicator}</span>`;
                    if (jogo.statusIndicator === "LIVE") { 
                         if (jogo.resultadoGMCasa !== undefined && jogo.resultadoGMFora !== undefined) { 
                           gameCenterContent = `<span class="score">${jogo.resultadoGMCasa} - ${jogo.resultadoGMFora}</span><span class="live-indicator">${jogo.statusIndicator}</span>`;
                        }
                    }
                    const gameCenterDetails = `${jornadaInfo}${gameCenterContent}`;
                    gameItemsHtml += `
                        <div class="live-game-item">
                            <div class="team-info home-team">
                                ${logoCasaSrc ? `<img src="${logoCasaSrc}" alt="${jogo.clubeCasaNome || 'Casa'}" onerror="this.style.display='none';">` : ''}
                                <span>${jogo.clubeCasaNome || 'Equipa da Casa'}</span>
                            </div>
                            <div class="game-details">
                                ${gameCenterDetails}
                            </div>
                            <div class="team-info away-team">
                                <span>${jogo.clubeForaNome || 'Equipa Visitante'}</span>
                                ${logoForaSrc ? `<img src="${logoForaSrc}" alt="${jogo.clubeForaNome || 'Fora'}" onerror="this.style.display='none';">` : ''}
                            </div>
                            <button class="edit-game-btn" data-game-id="${jogo.id}">Editar</button>
                        </div>
                    `;
                });
                relevantGamesListDisplay.innerHTML = gameItemsHtml;
                relevantGamesSection.style.display = 'block'; 
                relevantGamesListDisplay.querySelectorAll('.edit-game-btn').forEach(button => {
                    button.addEventListener('click', async (event) => {
                        const gameId = event.target.dataset.gameId;
                        if (gameId) {
                            const gameData = allRelevantGames.find(g => g.id === gameId);
                            if(gameData) {
                                editJogoTemporadaSelect.value = gameData.temporada;
                                editJogoSearchInput.value = gameData.nomeJogo || `Jogo ID: ${gameId}`;
                                editJogoSearchInput.disabled = false; 
                                editJogoSuggestionsContainer.style.display = 'none'; 
                            }
                            await loadGameForEditing(gameId);
                            const formElement = document.getElementById('editJogoFormContainer');
                            if (formElement) {
                                formElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                            }
                        }
                    });
                });
            } catch (error) {
                console.error("Erro ao buscar jogos em destaque:", error);
                relevantGamesListDisplay.innerHTML = '<div class="no-live-games">Erro ao carregar jogos em destaque.</div>';
                relevantGamesSection.style.display = 'block';
            }
        }
    
        window.openTab = async function(evt, tabName) {
            var i, tabcontent, tabbuttons;
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            tabbuttons = document.getElementsByClassName("tab-button");
            for (i = 0; i < tabbuttons.length; i++) {
                tabbuttons[i].className = tabbuttons[i].className.replace(" active", "");
            }
            const currentTabDiv = document.getElementById(tabName);
            if (currentTabDiv) currentTabDiv.style.display = "block";
            if (evt && evt.currentTarget) {
                 evt.currentTarget.className += " active";
            }
            if (!allClubes.length) { 
                await loadClubesParaJogo();
            }
            if (!allJogadores.length) {
                await loadJogadoresParaJogo();
            }
            if (tabName === 'tabJogador') {
                loadPosicoesParaDropdown();
                loadPaisesParaSugestoes();
            } else if (tabName === 'tabPais') {
                loadContinentesParaDropdown();
            } else if (tabName === 'tabJogo') {
                populateTemporadaDropdown(jogoTemporadaSelect);
                await setSuggestedJornada(jogoTemporadaSelect, jogoJornadaSelect, 'statusJogo', jogoTerminadoCheckbox, jogoLiveCheckbox, jogoFuturoCheckbox);
                if (createJogo11InicialContainer.children.length === 0) {
                     setupDynamicPlayerInputs('jogo11InicialContainer', 11, 'inicial', 'create');
                }
                if (createJogoSuplentesContainer.children.length === 0) {
                    setupDynamicPlayerInputs('jogoSuplentesContainer', 11, 'suplente', 'create');
                }
                if (goalZoneGridContainer.children.length === 0) {
                    populateGoalZoneGrid(goalZoneGridContainer, 'create');
                }
                 syncGameStatusCheckboxes.call(window, jogoLiveCheckbox, jogoTerminadoCheckbox, jogoFuturoCheckbox); 
                 updateCalculatedScores('create'); 
            } else if (tabName === 'tabEditarJogo') {
                populateTemporadaDropdown(editJogoTemporadaSelect);
                if (editJogoJornadaSelect.options.length <= 1 || (editJogoJornadaSelect.options.length > 0 && editJogoJornadaSelect.options[0].value === "")) {
                    editJogoJornadaSelect.innerHTML = '<option value="">Selecione a Jornada</option>';
                    for (let i = 1; i <= 40; i++) {
                        editJogoJornadaSelect.add(new Option(i.toString(), i.toString()));
                    }
                }
                editJogoSearchInput.value = '';
                editJogoSearchInput.disabled = true;
                editJogoSuggestionsContainer.style.display = 'none';
                editJogoFormContainer.style.display = 'none'; 
                currentEditingGameData = null;
                editJogoDocIdInput.value = '';
                if (editJogo11InicialContainer.children.length === 0) {
                     setupDynamicPlayerInputs('editJogo11InicialContainer', 11, 'edit_inicial', 'edit');
                }
                if (editJogoSuplentesContainer.children.length === 0) {
                    setupDynamicPlayerInputs('editJogoSuplentesContainer', 11, 'edit_suplente', 'edit');
                }
                if (editGoalZoneGridContainer.children.length === 0) { 
                    populateGoalZoneGrid(editGoalZoneGridContainer, 'edit');
                }
                editMinutosGolosMarcados = [];
                editMinutosGolosSofridos = [];
                renderMinuteList(editListaMinutosGolosMarcados, editMinutosGolosMarcados, 'marcado', 'edit');
                renderMinuteList(editListaMinutosGolosSofridos, editMinutosGolosSofridos, 'sofrido', 'edit');
                syncGameStatusCheckboxes.call(window, editJogoLiveCheckbox, editJogoTerminadoCheckbox, editJogoFuturoCheckbox);
                await displayRelevantGames(); 
            }
        }
    
        document.addEventListener('DOMContentLoaded', () => {
            const defaultTabButton = document.querySelector('.tab-button[onclick*="tabJogo"]');
            if (defaultTabButton) {
                 openTab({ currentTarget: defaultTabButton }, 'tabJogo');
            }
            const placarStatsLegend = document.getElementById('legendPlacarStats');
            const placarStatsContent = document.querySelector('#fieldsetPlacarStats .toggle-content');
            const placarStatsFieldset = document.getElementById('fieldsetPlacarStats');
            const placarStatsIndicator = placarStatsLegend ? placarStatsLegend.querySelector('.toggle-indicator') : null;
            if (placarStatsLegend && placarStatsContent && placarStatsIndicator && placarStatsFieldset) {
                placarStatsLegend.addEventListener('click', () => {
                    const isOpen = placarStatsContent.style.display === 'block';
                    placarStatsContent.style.display = isOpen ? 'none' : 'block';
                    placarStatsIndicator.textContent = isOpen ? '[+]' : '[-]';
                    placarStatsFieldset.classList.toggle('open', !isOpen);
                });
            }
            const editPlacarStatsLegend = document.getElementById('editLegendPlacarStats');
            const editPlacarStatsContent = document.querySelector('#editFieldsetPlacarStats .toggle-content');
            const editPlacarStatsFieldset = document.getElementById('editFieldsetPlacarStats');
            const editPlacarStatsIndicator = editPlacarStatsLegend ? editPlacarStatsLegend.querySelector('.toggle-indicator') : null;
            if (editPlacarStatsLegend && editPlacarStatsContent && editPlacarStatsIndicator && editPlacarStatsFieldset) {
                editPlacarStatsLegend.addEventListener('click', () => {
                    const isOpen = editPlacarStatsContent.style.display === 'block';
                    editPlacarStatsContent.style.display = isOpen ? 'none' : 'block';
                    editPlacarStatsIndicator.textContent = isOpen ? '[+]' : '[-]';
                    editPlacarStatsFieldset.classList.toggle('open', !isOpen);
                });
            }
            jogoTemporadaSelect.addEventListener('change', () => setSuggestedJornada(jogoTemporadaSelect, jogoJornadaSelect, 'statusJogo', jogoTerminadoCheckbox, jogoLiveCheckbox, jogoFuturoCheckbox));
            jogoClubeCasaInput.addEventListener('change', () => handleClubeChange('create', 'casa'));
            jogoClubeForaInput.addEventListener('change', () => handleClubeChange('create', 'fora'));
            jogoClubeCasaInput.addEventListener('input', () => updateCalculatedScores('create'));
            jogoClubeForaInput.addEventListener('input', () => updateCalculatedScores('create'));
            jogoLiveCheckbox.addEventListener('change', () => updateCalculatedScores('create'));
            jogoTerminadoCheckbox.addEventListener('change', () => updateCalculatedScores('create'));
            jogoFuturoCheckbox.addEventListener('change', () => updateCalculatedScores('create'));
            editJogoTemporadaSelect.addEventListener('change', handleEditTemporadaChange);
            editJogoSearchInput.addEventListener('input', handleEditJogoSearch);
            editJogoClubeCasaInput.addEventListener('change', () => handleClubeChange('edit', 'casa'));
            editJogoClubeForaInput.addEventListener('change', () => handleClubeChange('edit', 'fora'));
            editJogoClubeCasaInput.addEventListener('input', () => updateCalculatedScores('edit'));
            editJogoClubeForaInput.addEventListener('input', () => updateCalculatedScores('edit'));
            editJogoLiveCheckbox.addEventListener('change', () => updateCalculatedScores('edit'));
            editJogoTerminadoCheckbox.addEventListener('change', () => updateCalculatedScores('edit'));
            editJogoFuturoCheckbox.addEventListener('change', () => updateCalculatedScores('edit'));
        });
    
        document.getElementById('formClube').addEventListener('submit', async (e) => {
            e.preventDefault();
            const nome = document.getElementById('clubeNome').value.trim();
            const logo = document.getElementById('clubeLogo').value.trim();
            const regiao = document.getElementById('clubeRegiao').value.trim();
            const cidade = document.getElementById('clubeCidade').value.trim();
            if (!nome || !logo || !regiao || !cidade) { showStatus('statusClube', 'Todos os campos são obrigatórios.', false); return; }
            try {
                await setDoc(doc(db, "clubes", nome), { nome, logo, regiao, cidade });
                showStatus('statusClube', `Clube "${nome}" adicionado!`, true); e.target.reset();
                allClubes = []; 
                sportingClubeDetalhes = null; 
                if (document.getElementById('tabJogo').style.display === 'block' || document.getElementById('tabEditarJogo').style.display === 'block') {
                    await loadClubesParaJogo(); 
                }
            } catch (error) { showStatus('statusClube', `Erro: ${error.message}`, false); console.error(error); }
        });
    
        document.getElementById('formPosicao').addEventListener('submit', async (e) => {
            e.preventDefault();
            const abreviacao = document.getElementById('posicaoAbreviacao').value.trim().toUpperCase();
            const posicao_generica = document.getElementById('posicaoGenericaForm').value.trim();
            if (!abreviacao || !posicao_generica) { showStatus('statusPosicao', 'Todos os campos são obrigatórios.', false); return; }
            try {
                await setDoc(doc(db, "posicoes", abreviacao), { abreviacao, posicao_generica });
                showStatus('statusPosicao', `Posição "${abreviacao}" adicionada!`, true); e.target.reset();
                posicoesMap.clear(); 
                if (document.getElementById('tabJogador').style.display === 'block') loadPosicoesParaDropdown();
            } catch (error) { showStatus('statusPosicao', `Erro: ${error.message}`, false); console.error(error); }
        });
        
        const paisContinenteSelect = document.getElementById('paisContinenteSelect');
        async function loadContinentesParaDropdown() {
            if (allContinentesSet.size > 0 && paisContinenteSelect.options.length > 1 && paisContinenteSelect.options[0].value !== "") return;
            paisContinenteSelect.innerHTML = '<option value="">A carregar continentes...</option>';
            allContinentesSet.clear();
            try {
                const querySnapshot = await getDocs(collection(db, "paises"));
                querySnapshot.forEach((docSnap) => { if (docSnap.data().continente) allContinentesSet.add(docSnap.data().continente); });
                if (allContinentesSet.size === 0) {
                    paisContinenteSelect.innerHTML = '<option value="">Nenhum continente. Adicione um país com continente.</option>';
                } else {
                    paisContinenteSelect.innerHTML = '<option value="">Selecione um Continente</option>';
                    Array.from(allContinentesSet).sort().forEach(c => paisContinenteSelect.add(new Option(c,c)));
                }
            } catch (error) {
                console.error("Erro ao carregar continentes: ", error);
                paisContinenteSelect.innerHTML = '<option value="">Erro ao carregar</option>';
                showStatus('statusPais', 'Erro ao carregar continentes.', false);
            }
        }
        document.getElementById('formPais').addEventListener('submit', async (e) => {
            e.preventDefault();
            const nome = document.getElementById('paisNome').value.trim();
            const bandeira = document.getElementById('paisBandeira').value.trim();
            const continente = paisContinenteSelect.value;
            if (!nome || !bandeira || !continente) { showStatus('statusPais', 'Todos os campos são obrigatórios.', false); return; }
            try {
                await setDoc(doc(db, "paises", nome), { nome, bandeira, continente });
                showStatus('statusPais', `País "${nome}" adicionado!`, true); e.target.reset();
                paisContinenteSelect.value = ""; allPaises = []; allContinentesSet.clear(); 
                if (document.getElementById('tabJogador').style.display === 'block') loadPaisesParaSugestoes(); 
                loadContinentesParaDropdown(); 
            } catch (error) { showStatus('statusPais', `Erro: ${error.message}`, false); console.error(error); }
        });
    
        const posEspecificaDropdown = document.getElementById('jogadorPosEspecifica');
        const posGenericaInput = document.getElementById('jogadorPosGenerica');
        const jogadorPaisNomeInput = document.getElementById('jogadorPaisNome');
        const paisSuggestionsContainer = document.getElementById('paisSuggestions');
    
        async function loadPosicoesParaDropdown() {
            if (posicoesMap.size > 0 && posEspecificaDropdown.options.length > 1 && posEspecificaDropdown.options[0].value !== "") return;
            posEspecificaDropdown.innerHTML = '<option value="">A carregar posições...</option>';
            posGenericaInput.value = ''; posicoesMap.clear();
            try {
                const querySnapshot = await getDocs(collection(db, "posicoes"));
                if (querySnapshot.empty) { posEspecificaDropdown.innerHTML = '<option value="">Nenhuma posição. Crie na aba "Criar Posição".</option>'; return; }
                posEspecificaDropdown.innerHTML = '<option value="">Selecione uma Posição</option>';
                querySnapshot.forEach((docSnap) => {
                    const d = docSnap.data(); posicoesMap.set(d.abreviacao, d.posicao_generica);
                    posEspecificaDropdown.add(new Option(d.abreviacao, d.abreviacao));
                });
            } catch (error) {
                console.error("Erro ao carregar posições: ", error);
                posEspecificaDropdown.innerHTML = '<option value="">Erro ao carregar</option>';
                showStatus('statusJogador', 'Erro ao carregar posições.', false);
            }
        }
        posEspecificaDropdown.addEventListener('change', function() {
            posGenericaInput.value = this.value && posicoesMap.has(this.value) ? posicoesMap.get(this.value) : '';
        });
        async function loadPaisesParaSugestoes() {
            if (allPaises.length > 0) { 
                 if (!jogadorPaisNomeInput.getAttribute('data-suggestions-setup')) { 
                    setupSuggestionHandler(jogadorPaisNomeInput, paisSuggestionsContainer, () => allPaises, null, null, null, 'jogador');
                    jogadorPaisNomeInput.setAttribute('data-suggestions-setup', 'true');
                }
                return;
            }
            allPaises = []; 
            try {
                const querySnapshot = await getDocs(collection(db, "paises"));
                querySnapshot.forEach((docSnap) => allPaises.push(docSnap.data().nome));
                allPaises.sort();
                 setupSuggestionHandler(jogadorPaisNomeInput, paisSuggestionsContainer, () => allPaises, null, null, null, 'jogador');
                 jogadorPaisNomeInput.setAttribute('data-suggestions-setup', 'true');
            } catch (error) { console.error("Erro ao carregar países: ", error); showStatus('statusJogador', 'Erro ao carregar países.', false); }
        }
        
        document.getElementById('formJogador').addEventListener('submit', async (e) => {
            e.preventDefault();
            const nome_jogador = document.getElementById('jogadorNome').value.trim();
            const imagem_link = document.getElementById('jogadorImagem').value.trim();
            const posEspecifica = posEspecificaDropdown.value;
            const posGenerica = posGenericaInput.value;
            const paisNomeForm = jogadorPaisNomeInput.value.trim();
            if (!nome_jogador || !imagem_link || !posEspecifica || !paisNomeForm) { showStatus('statusJogador', 'Todos os campos são obrigatórios.', false); return; }
            if (!posGenerica) { showStatus('statusJogador', 'Posição genérica não definida.', false); return; }
            try {
                await setDoc(doc(db, "jogadores", nome_jogador), {
                    nome_jogador, imagem_link, posicao_especifica_id: posEspecifica, posicao_especifica_nome: posEspecifica,
                    posicao_generica_id: posGenerica, posicao_generica_nome: posGenerica,
                    pais_id: paisNomeForm, pais_nome: paisNomeForm
                });
                showStatus('statusJogador', `Jogador "${nome_jogador}" adicionado!`, true);
                e.target.reset(); posGenericaInput.value = ''; paisSuggestionsContainer.style.display = 'none';
                jogadorPaisNomeInput.style.backgroundImage = 'none'; 
                jogadorPaisNomeInput.classList.remove('has-image-bg');
                allJogadores = []; 
                 if (document.getElementById('tabJogo').style.display === 'block' || document.getElementById('tabEditarJogo').style.display === 'block') {
                    await loadJogadoresParaJogo(); 
                }
            } catch (error) { showStatus('statusJogador', `Erro: ${error.message}`, false); console.error(error); }
        });
    
        function setupSuggestionHandler(inputElement, suggestionsContainer, dataProvider, displayField, imageField = null, clearBtnElement = null, context = 'default') {
            inputElement.addEventListener('input', async function() {
                const currentDataArray = typeof dataProvider === 'function' ? await dataProvider() : dataProvider;
                const inputText = this.value.toLowerCase();
                suggestionsContainer.innerHTML = '';
                const isClubInput = inputElement.id.toLowerCase().includes('clube');
                const isPlayerInput = inputElement.id.toLowerCase().includes('jogador') || inputElement.id.toLowerCase().includes('assistencia') || inputElement.classList.contains('player-input-grid') || (inputElement.parentElement && inputElement.parentElement.classList.contains('player-input-wrapper'));
                if (!inputText.trim()) {
                    suggestionsContainer.style.display = 'none';
                    if ( (isClubInput || isPlayerInput) && (clearBtnElement || inputElement.classList.contains('has-image-bg'))) {
                        inputElement.style.backgroundImage = 'none';
                        inputElement.classList.remove('has-image-bg');
                    }
                    if (clearBtnElement) {
                        clearBtnElement.style.display = 'none';
                        inputElement.classList.remove('has-clear-btn');
                    }
                    return;
                }
                const filteredData = currentDataArray.filter(item => {
                    const itemText = (typeof item === 'string' ? item : item[displayField]);
                    return itemText ? itemText.toLowerCase().includes(inputText) : false;
                });
                if (filteredData.length > 0 && inputElement.matches(':focus')) { 
                    filteredData.slice(0, 10).forEach(item => {
                        const suggestionItemDiv = document.createElement('div');
                        suggestionItemDiv.classList.add('suggestion-item');
                        const itemText = (typeof item === 'string' ? item : item[displayField]);
                        if (typeof item === 'object') {
                            suggestionItemDiv.dataset.itemData = JSON.stringify(item);
                        }
                        if (imageField && typeof item === 'object' && item[imageField]) {
                            const img = document.createElement('img'); img.src = item[imageField]; img.alt = itemText;
                            img.onerror = function() { this.style.display='none'; };
                            suggestionItemDiv.appendChild(img);
                        }
                        const textSpan = document.createElement('span'); textSpan.textContent = itemText;
                        suggestionItemDiv.appendChild(textSpan);
                        suggestionItemDiv.addEventListener('click', async function() {
                            inputElement.value = itemText;
                            suggestionsContainer.style.display = 'none';
                            if (context === 'edit-game-search') {
                                const gameId = item.id; 
                                document.getElementById('editJogoDocId').value = gameId;
                                await loadGameForEditing(gameId);
                                return; 
                            }
                            if ( (isClubInput || isPlayerInput) && imageField && typeof item === 'object' && item[imageField]) {
                                inputElement.style.backgroundImage = `url('${item[imageField]}')`;
                                inputElement.classList.add('has-image-bg');
                            } else if (isClubInput || isPlayerInput) { 
                                inputElement.style.backgroundImage = 'none';
                                inputElement.classList.remove('has-image-bg');
                            }
                            if (clearBtnElement) {
                                clearBtnElement.style.display = 'block';
                                inputElement.classList.add('has-clear-btn');
                            }
                            inputElement.dispatchEvent(new Event('change', { bubbles: true })); 
                        });
                        suggestionsContainer.appendChild(suggestionItemDiv);
                    });
                    suggestionsContainer.style.display = 'block';
                } else {
                    suggestionsContainer.style.display = 'none';
                }
            });
            document.addEventListener('click', (e) => {
                if (suggestionsContainer && !inputElement.contains(e.target) && !suggestionsContainer.contains(e.target)) {
                    suggestionsContainer.style.display = 'none';
                }
            });
        }
    
        function populateTemporadaDropdown(selectElement) {
            if (selectElement.options.length > 1 && selectElement.options[0].value !== "") return; 
            const previouslySelected = selectElement.value; 
            selectElement.innerHTML = '<option value="">Selecione a Temporada</option>';
            const currentYear = new Date().getFullYear();
            for (let year = currentYear + 1; year >= 2000; year--) {
                const displayTemporada = `${year-1}/${year}`;
                selectElement.add(new Option(displayTemporada, displayTemporada));
            }
            if (previouslySelected) { 
                 selectElement.value = previouslySelected;
            }
             if (selectElement.value === "" && selectElement.options[0].value === "") { 
                selectElement.options[0].textContent = "Selecione a Temporada";
            }
        }
    
        async function setSuggestedJornada(temporadaSelect, jornadaSelect, statusElementId, termCb, liveCb, futCb) {
            const selectedTemporadaValue = temporadaSelect.value;
            if (!selectedTemporadaValue) {
                termCb.checked = false; 
            } else {
                const options = Array.from(temporadaSelect.options);
                const firstSelectableOption = options.find(opt => opt.value !== ""); 
                if (firstSelectableOption) {
                    const mostRecentSeasonInDropdown = firstSelectableOption.value;
                    termCb.checked = (selectedTemporadaValue < mostRecentSeasonInDropdown);
                } else {
                     termCb.checked = false;
                }
            }
            syncGameStatusCheckboxes.call(termCb, liveCb, termCb, futCb); 
            if (jornadaSelect.options.length <= 1 || (jornadaSelect.options.length > 0 && jornadaSelect.options[0].value === "")) {
                const currentJornadaVal = jornadaSelect.value; 
                jornadaSelect.innerHTML = '<option value="">A carregar jornadas...</option>';
                for (let i = 1; i <= 40; i++) { 
                    jornadaSelect.add(new Option(i.toString(), i.toString()));
                }
                if (currentJornadaVal && !isNaN(parseInt(currentJornadaVal)) && parseInt(currentJornadaVal) >=1 && parseInt(currentJornadaVal) <=40) {
                    jornadaSelect.value = currentJornadaVal;
                } else {
                     jornadaSelect.value = ""; 
                }
                if (jornadaSelect.value === "" && jornadaSelect.options[0].value === "") {
                    jornadaSelect.options[0].textContent = "Selecione a Jornada";
                } else if (jornadaSelect.options[0].value === "") { 
                     jornadaSelect.options[0].textContent = "Selecione a Jornada";
                }
            }
            if (!selectedTemporadaValue) { 
                 if (jornadaSelect.value === "" && jornadaSelect.options.length > 0 && jornadaSelect.options[0].value === "") {
                     jornadaSelect.options[0].textContent = "Selecione a Jornada";
                }
                return;
            }
            const originalJornadaPlaceholder = jornadaSelect.options[0].value === "" ? jornadaSelect.options[0].textContent : null;
            if (jornadaSelect.options[0].value === "") { 
                 jornadaSelect.options[0].textContent = "A calcular...";
            }
            try {
                const q = query(collection(db, "jogos"), where("temporada", "==", selectedTemporadaValue));
                const querySnapshot = await getDocs(q);
                let maxJornada = 0;
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    if (data.jornada != null && !isNaN(Number(data.jornada)) && Number(data.jornada) > maxJornada) {
                        maxJornada = Number(data.jornada);
                    }
                });
                const nextJornada = maxJornada + 1;
                const suggestedJornadaValue = Math.min(nextJornada, 40); 
                if (jornadaSelect.querySelector(`option[value="${suggestedJornadaValue.toString()}"]`)) {
                    jornadaSelect.value = suggestedJornadaValue.toString();
                } else if (jornadaSelect.options.length > 1) { 
                     jornadaSelect.value = jornadaSelect.options[1].value;
                } else { 
                    jornadaSelect.value = ""; 
                }
            } catch (error) {
                console.error("Erro ao sugerir próxima jornada:", error);
                showStatus(statusElementId, 'Erro ao calcular jornada. Selecione manualmente.', false);
            } finally {
                 if (jornadaSelect.options[0].value === "" && (jornadaSelect.options[0].textContent.includes("calcular") || jornadaSelect.options[0].textContent.includes("carregar")) ) {
                     if (jornadaSelect.value === "") { 
                        jornadaSelect.options[0].textContent = originalJornadaPlaceholder || "Selecione a Jornada";
                     } else { 
                        if (jornadaSelect.options[0].value === "") jornadaSelect.options[0].textContent = "Selecione a Jornada";
                     }
                }
            }
        }
    
        async function loadClubesParaJogo() {
            if (allClubes.length > 0 && sportingClubeDetalhes) {
                if (!jogoClubeCasaInput.getAttribute('data-suggestions-setup')) {
                    setupSuggestionHandler(jogoClubeCasaInput, clubeCasaSuggestions, () => allClubes, 'nome', 'logo', null, 'create_club_casa');
                    jogoClubeCasaInput.setAttribute('data-suggestions-setup', 'true');
                }
                if (!jogoClubeForaInput.getAttribute('data-suggestions-setup')) {
                    setupSuggestionHandler(jogoClubeForaInput, clubeForaSuggestions, () => allClubes, 'nome', 'logo', null, 'create_club_fora');
                    jogoClubeForaInput.setAttribute('data-suggestions-setup', 'true');
                }
                if (!editJogoClubeCasaInput.getAttribute('data-suggestions-setup')) {
                    setupSuggestionHandler(editJogoClubeCasaInput, editClubeCasaSuggestions, () => allClubes, 'nome', 'logo', null, 'edit_club_casa');
                    editJogoClubeCasaInput.setAttribute('data-suggestions-setup', 'true');
                }
                 if (!editJogoClubeForaInput.getAttribute('data-suggestions-setup')) {
                    setupSuggestionHandler(editJogoClubeForaInput, editClubeForaSuggestions, () => allClubes, 'nome', 'logo', null, 'edit_club_fora');
                    editJogoClubeForaInput.setAttribute('data-suggestions-setup', 'true');
                }
                return;
            }
            allClubes = [];
            sportingClubeDetalhes = null;
            try {
                const snap = await getDocs(collection(db, "clubes"));
                snap.forEach(s => allClubes.push({ id: s.id, nome: s.data().nome, logo: s.data().logo }));
                allClubes.sort((a, b) => a.nome.localeCompare(b.nome));
                sportingClubeDetalhes = allClubes.find(c => c.nome.toLowerCase() === SPORTING_CP_CANONICAL_NAME.toLowerCase());
                if (!sportingClubeDetalhes) {
                    sportingClubeDetalhes = allClubes.find(c => sportingCanonicoNomesInputCheck.includes(c.nome.toLowerCase()));
                }
                if (!sportingClubeDetalhes) {
                     console.warn("Detalhes do Sporting CP não foram encontrados na lista de clubes.");
                }
                setupSuggestionHandler(jogoClubeCasaInput, clubeCasaSuggestions, () => allClubes, 'nome', 'logo', null, 'create_club_casa');
                jogoClubeCasaInput.setAttribute('data-suggestions-setup', 'true');
                setupSuggestionHandler(jogoClubeForaInput, clubeForaSuggestions, () => allClubes, 'nome', 'logo', null, 'create_club_fora');
                jogoClubeForaInput.setAttribute('data-suggestions-setup', 'true');
                setupSuggestionHandler(editJogoClubeCasaInput, editClubeCasaSuggestions, () => allClubes, 'nome', 'logo', null, 'edit_club_casa');
                editJogoClubeCasaInput.setAttribute('data-suggestions-setup', 'true');
                setupSuggestionHandler(editJogoClubeForaInput, editClubeForaSuggestions, () => allClubes, 'nome', 'logo', null, 'edit_club_fora');
                editJogoClubeForaInput.setAttribute('data-suggestions-setup', 'true');
            } catch (e) { 
                console.error("Erro loadClubes: ", e); 
                showStatus('statusJogo', 'Erro lista de clubes.', false);
                showStatus('statusEditarJogo', 'Erro lista de clubes.', false);
            }
        }
    
        function handleClubeChange(context, side) { 
            if (!sportingClubeDetalhes) return;
            const casaInput = context === 'create' ? jogoClubeCasaInput : editJogoClubeCasaInput;
            const foraInput = context === 'create' ? jogoClubeForaInput : editJogoClubeForaInput;
            const casaNome = casaInput.value.trim();
            const foraNome = foraInput.value.trim();
            let changedInput = null; 
            if (side === 'casa') { 
                if (casaNome && !sportingCanonicoNomesInputCheck.includes(casaNome.toLowerCase())) {
                    if (foraInput.value !== sportingClubeDetalhes.nome) {
                        foraInput.value = sportingClubeDetalhes.nome;
                        changedInput = foraInput;
                    }
                } else if (casaNome && sportingCanonicoNomesInputCheck.includes(casaNome.toLowerCase())) {
                    if (foraNome && sportingCanonicoNomesInputCheck.includes(foraNome.toLowerCase())) {
                        foraInput.value = "";
                        changedInput = foraInput;
                    }
                }
            } else { 
                if (foraNome && !sportingCanonicoNomesInputCheck.includes(foraNome.toLowerCase())) {
                     if (casaInput.value !== sportingClubeDetalhes.nome) {
                        casaInput.value = sportingClubeDetalhes.nome;
                        changedInput = casaInput;
                    }
                } else if (foraNome && sportingCanonicoNomesInputCheck.includes(foraNome.toLowerCase())) {
                    if (casaNome && sportingCanonicoNomesInputCheck.includes(casaNome.toLowerCase())) {
                        casaInput.value = "";
                        changedInput = casaInput;
                    }
                }
            }
            if (changedInput) {
                if (changedInput.value === sportingClubeDetalhes.nome && sportingClubeDetalhes.logo) {
                    changedInput.style.backgroundImage = `url('${sportingClubeDetalhes.logo}')`;
                    changedInput.classList.add('has-image-bg');
                } else {
                    changedInput.style.backgroundImage = 'none';
                    changedInput.classList.remove('has-image-bg');
                }
                changedInput.dispatchEvent(new Event('input', { bubbles: true })); 
            }
            updateCalculatedScores(context);
        }
    
        async function loadJogadoresParaJogo() {
             if (allJogadores.length > 0) {
                if (!goalDetailJogadorInput.getAttribute('data-suggestions-setup')) {
                    setupSuggestionHandler(goalDetailJogadorInput, goalDetailJogadorSuggestions, () => allJogadores, 'nome', 'imagem_link', null, 'create_goal_scorer');
                    goalDetailJogadorInput.setAttribute('data-suggestions-setup', 'true');
                }
                if (!goalDetailAssistenciaInput.getAttribute('data-suggestions-setup')) {
                    setupSuggestionHandler(goalDetailAssistenciaInput, goalDetailAssistenciaSuggestions, () => allJogadores, 'nome', 'imagem_link', null, 'create_goal_assist');
                    goalDetailAssistenciaInput.setAttribute('data-suggestions-setup', 'true');
                }
                if (!editGoalDetailJogadorInput.getAttribute('data-suggestions-setup')) {
                    setupSuggestionHandler(editGoalDetailJogadorInput, editGoalDetailJogadorSuggestions, () => allJogadores, 'nome', 'imagem_link', null, 'edit_goal_scorer');
                    editGoalDetailJogadorInput.setAttribute('data-suggestions-setup', 'true');
                }
                if (!editGoalDetailAssistenciaInput.getAttribute('data-suggestions-setup')) {
                    setupSuggestionHandler(editGoalDetailAssistenciaInput, editGoalDetailAssistenciaSuggestions, () => allJogadores, 'nome', 'imagem_link', null, 'edit_goal_assist');
                    editGoalDetailAssistenciaInput.setAttribute('data-suggestions-setup', 'true');
                }
                document.querySelectorAll('#jogo11InicialContainer input[type="text"], #jogoSuplentesContainer input[type="text"], #editJogo11InicialContainer input[type="text"], #editJogoSuplentesContainer input[type="text"]').forEach(input => {
                    if (!input.getAttribute('data-suggestions-setup')) {
                        const suggContainer = input.parentElement.querySelector('.suggestions-container');
                        const clearBtn = input.parentElement.querySelector('.player-input-clear-btn');
                        const contextPrefix = input.id.startsWith('edit') ? 'edit_player_' : 'create_player_';
                        setupSuggestionHandler(input, suggContainer, () => allJogadores, 'nome', 'imagem_link', clearBtn, contextPrefix + input.id);
                        input.setAttribute('data-suggestions-setup', 'true');
                    }
                });
                return;
            }
            allJogadores = [];
            try {
                const snap = await getDocs(collection(db, "jogadores"));
                snap.forEach(s => allJogadores.push({ id: s.id, nome: s.data().nome_jogador, imagem_link: s.data().imagem_link }));
                allJogadores.sort((a, b) => a.nome.localeCompare(b.nome));
                setupSuggestionHandler(goalDetailJogadorInput, goalDetailJogadorSuggestions, () => allJogadores, 'nome', 'imagem_link', null, 'create_goal_scorer');
                goalDetailJogadorInput.setAttribute('data-suggestions-setup', 'true');
                setupSuggestionHandler(goalDetailAssistenciaInput, goalDetailAssistenciaSuggestions, () => allJogadores, 'nome', 'imagem_link', null, 'create_goal_assist');
                goalDetailAssistenciaInput.setAttribute('data-suggestions-setup', 'true');
                setupSuggestionHandler(editGoalDetailJogadorInput, editGoalDetailJogadorSuggestions, () => allJogadores, 'nome', 'imagem_link', null, 'edit_goal_scorer');
                editGoalDetailJogadorInput.setAttribute('data-suggestions-setup', 'true');
                setupSuggestionHandler(editGoalDetailAssistenciaInput, editGoalDetailAssistenciaSuggestions, () => allJogadores, 'nome', 'imagem_link', null, 'edit_goal_assist');
                editGoalDetailAssistenciaInput.setAttribute('data-suggestions-setup', 'true');
                document.querySelectorAll('#jogo11InicialContainer input[type="text"], #jogoSuplentesContainer input[type="text"], #editJogo11InicialContainer input[type="text"], #editJogoSuplentesContainer input[type="text"]').forEach(input => {
                    const suggContainer = input.parentElement.querySelector('.suggestions-container');
                    const clearBtn = input.parentElement.querySelector('.player-input-clear-btn');
                     const contextPrefix = input.id.startsWith('edit') ? 'edit_player_' : 'create_player_';
                    setupSuggestionHandler(input, suggContainer, () => allJogadores, 'nome', 'imagem_link', clearBtn, contextPrefix + input.id);
                    input.setAttribute('data-suggestions-setup', 'true');
                });
            } catch (e) { 
                console.error("Erro loadJogadores: ", e); 
                showStatus('statusJogo', 'Erro lista de jogadores.', false);
                showStatus('statusEditarJogo', 'Erro lista de jogadores.', false);
            }
        }
    
        function getGoalDetailStatus(details, type) { 
            if (!details || Object.keys(details).length === 0) return 'status-pending';
            
            const tipoGolo = details.tipoGolo || 'Normal';
            const hasZone = !!details.zona;
    
            if (type === 'marcado') {
                const hasScorer = !!details.jogadorNome;
                if (tipoGolo === 'AutoGolo') {
                    return hasZone ? 'status-complete' : 'status-incomplete';
                }
                if (tipoGolo === 'Penalty') {
                    return (hasScorer && hasZone) ? 'status-complete' : 'status-incomplete';
                }
                // Tipo Normal
                if (hasScorer && hasZone) return 'status-complete'; 
                if (hasScorer || hasZone) return 'status-incomplete'; 
            } else if (type === 'sofrido') {
                // Para golos sofridos, tipoGolo não afeta a lógica aqui, pois marcador/assistência não são relevantes
                if (hasZone) return 'status-complete'; 
            }
            return 'status-pending'; 
        }
    
        function renderMinuteList(listElement, minutesArray, type, context) { 
            listElement.innerHTML = '';
            minutesArray.forEach((entry, index) => {
                const listItem = document.createElement('li');
                listItem.classList.add('minute-list-item');
                const statusClass = getGoalDetailStatus(entry.details, type);
                listItem.classList.add(statusClass);
                const textAndScorerContainer = document.createElement('div');
                textAndScorerContainer.classList.add('minute-text-scorer-container');
                const minuteSpan = document.createElement('span');
                minuteSpan.classList.add('minute-value');
                minuteSpan.textContent = `Minuto ${entry.minute}`;
                minuteSpan.dataset.index = index;
                minuteSpan.dataset.type = type;
                minuteSpan.dataset.minute = entry.minute;
                minuteSpan.dataset.context = context; 
                minuteSpan.addEventListener('click', openGoalDetailModalHandler); 
                textAndScorerContainer.appendChild(minuteSpan);
                
                const tipoGoloDetalhe = entry.details?.tipoGolo || 'Normal';
    
                if (type === 'marcado' && entry.details && entry.details.jogadorNome && tipoGoloDetalhe !== 'AutoGolo') {
                    const separatorSpan = document.createElement('span');
                    separatorSpan.classList.add('minute-list-separator');
                    separatorSpan.textContent = " | ";
                    textAndScorerContainer.appendChild(separatorSpan);
                    const jogador = allJogadores.find(j => j.nome === entry.details.jogadorNome);
                    if (jogador && jogador.imagem_link) {
                        const imgJogador = document.createElement('img');
                        imgJogador.src = jogador.imagem_link;
                        imgJogador.alt = entry.details.jogadorNome;
                        imgJogador.classList.add('minute-list-player-image');
                        textAndScorerContainer.appendChild(imgJogador);
                    }
                    const scorerSpan = document.createElement('span');
                    scorerSpan.classList.add('scorer-name');
                    scorerSpan.textContent = entry.details.jogadorNome;
                    textAndScorerContainer.appendChild(scorerSpan);
                } else if (type === 'marcado' && tipoGoloDetalhe === 'AutoGolo') {
                     const separatorSpan = document.createElement('span');
                    separatorSpan.classList.add('minute-list-separator');
                    separatorSpan.textContent = " | ";
                    textAndScorerContainer.appendChild(separatorSpan);
                    const agSpan = document.createElement('span');
                    agSpan.classList.add('scorer-name');
                    agSpan.textContent = "AutoGolo";
                    agSpan.style.fontStyle = "italic";
                    textAndScorerContainer.appendChild(agSpan);
                }
                listItem.appendChild(textAndScorerContainer);
    
                const removeBtn = document.createElement('button');
                removeBtn.classList.add('remove-minute-btn');
                removeBtn.innerHTML = '×';
                removeBtn.addEventListener('click', async () => { 
                    const goloRemovido = minutesArray[index]; 
                    minutesArray.splice(index, 1);
                    renderMinuteList(listElement, minutesArray, type, context);
                    updateCalculatedScores(context);
    
                    if (context === 'edit' && goloRemovido.details && goloRemovido.details.goloFirestoreId) {
                        try {
                            await deleteDoc(doc(db, "golos", goloRemovido.details.goloFirestoreId));
                            showStatus('statusEditarJogo', `Golo do minuto ${goloRemovido.minute} removido também da coleção 'golos'.`, true);
                        } catch (error) {
                            console.error("Erro ao remover golo da coleção 'golos':", error);
                            showStatus('statusEditarJogo', `Erro ao remover da coleção 'golos': ${error.message}`, false);
                        }
                    } else if (context === 'create' && goloRemovido.details && goloRemovido.details.goloFirestoreId) {
                        // Se implementarmos a criação imediata em 'golos' para o modo 'create'
                        try {
                            await deleteDoc(doc(db, "golos", goloRemovido.details.goloFirestoreId));
                            showStatus('statusJogo', `Golo do minuto ${goloRemovido.minute} removido também da coleção 'golos'.`, true);
                        } catch (error) {
                            console.error("Erro ao remover golo da coleção 'golos' (modo criar):", error);
                            showStatus('statusJogo', `Erro ao remover da coleção 'golos': ${error.message}`, false);
                        }
                    }
                });
                listItem.appendChild(removeBtn);
                listElement.appendChild(listItem);
            });
        }
        
        function addMinuteEntry(type, listElement, minutesArray, minuteInputEl, context) { 
            const minute = parseInt(minuteInputEl.value);
            const statusElId = context === 'create' ? 'statusJogo' : 'statusEditarJogo';

            if (!minute || minute <= 0) { 
                showStatus(statusElId, 'Minuto inválido.', false); 
                return; 
            }

            // *** INÍCIO DA ALTERAÇÃO ***
            // Verifica se o minuto é especial (45 ou 90)
            const isSpecialMinute = minute === 45 || minute === 90;
            // Verifica se o minuto já existe na lista
            const minuteExists = minutesArray.some(entry => entry.minute === minute);

            // A nova condição: Bloqueia apenas se o minuto já existir E NÃO for um minuto especial.
            if (minuteExists && !isSpecialMinute) {
                showStatus(statusElId, `O minuto ${minute} já foi adicionado. Para adicionar múltiplos golos no mesmo minuto (descontos), use os minutos 45 ou 90.`, false);
                return;
            }
            // *** FIM DA ALTERAÇÃO ***

            minutesArray.push({ minute, details: { tipoGolo: 'Normal' } }); // Padrão tipoGolo: 'Normal'
            minutesArray.sort((a, b) => a.minute - b.minute);
            renderMinuteList(listElement, minutesArray, type, context);
            minuteInputEl.value = ''; 
            updateCalculatedScores(context);
        }
        
        addMinutoGoloMarcadoBtn.addEventListener('click', () => addMinuteEntry('marcado', listaMinutosGolosMarcados, createMinutosGolosMarcados, jogoMinutoGoloMarcadoInput, 'create'));
        addMinutoGoloSofridoBtn.addEventListener('click', () => addMinuteEntry('sofrido', listaMinutosGolosSofridos, createMinutosGolosSofridos, jogoMinutoGoloSofridoInput, 'create'));
        editAddMinutoGoloMarcadoBtn.addEventListener('click', () => addMinuteEntry('marcado', editListaMinutosGolosMarcados, editMinutosGolosMarcados, editJogoMinutoGoloMarcadoInput, 'edit'));
        editAddMinutoGoloSofridoBtn.addEventListener('click', () => addMinuteEntry('sofrido', editListaMinutosGolosSofridos, editMinutosGolosSofridos, editJogoMinutoGoloSofridoInput, 'edit'));
    
        function populateGoalZoneGrid(gridContainer, context) { 
            if (gridContainer.children.length > 0 && gridContainer.getAttribute('data-populated') === 'true') return;
            gridContainer.innerHTML = ''; 
            goalZoneNames.forEach(zoneName => {
                const cell = document.createElement('div'); cell.classList.add('goal-zone-cell');
                cell.textContent = zoneName; cell.dataset.zone = zoneName;
                cell.addEventListener('click', (event) => handleZoneSelection(event, context)); 
                gridContainer.appendChild(cell);
            });
            gridContainer.setAttribute('data-populated', 'true');
        }
    
        function handleZoneSelection(event, context) {
            const selectedCell = event.target;
            const currentGridContainer = context === 'create' ? goalZoneGridContainer : editGoalZoneGridContainer;
            const currentHiddenInput = context === 'create' ? selectedGoalZoneHidden : editSelectedGoalZoneHidden;
            currentGridContainer.querySelectorAll('.goal-zone-cell').forEach(cell => cell.classList.remove('selected'));
            selectedCell.classList.add('selected'); 
            currentHiddenInput.value = selectedCell.dataset.zone;
        }
    
        function openGoalDetailModalHandler(event) {
            const type = event.target.dataset.type; // 'marcado' ou 'sofrido'
            const index = parseInt(event.target.dataset.index);
            const context = event.target.dataset.context; // 'create' ou 'edit'
            const minutesArray = context === 'create' 
                ? (type === 'marcado' ? createMinutosGolosMarcados : createMinutosGolosSofridos)
                : (type === 'marcado' ? editMinutosGolosMarcados : editMinutosGolosSofridos);
            const minuteEntry = minutesArray[index];

            const currentModal = context === 'create' ? goalDetailModal : editGoalDetailModal;
            const currentTitle = context === 'create' ? goalDetailModalTitle : editGoalDetailModalTitle;
            const currentForm = context === 'create' ? formGoalDetail : document.getElementById('editFormGoalDetail'); 
            const currentTypeInput = context === 'create' ? goalDetailTypeInput : editGoalDetailTypeInput;
            const currentMinuteInput = context === 'create' ? goalDetailMinuteInput : editGoalDetailMinuteInput;
            // *** INÍCIO DA ALTERAÇÃO ***
            const currentIndexInput = context === 'create' ? document.getElementById('goalDetailIndex') : document.getElementById('editGoalDetailIndex');
            // *** FIM DA ALTERAÇÃO ***
            const currentScorerSection = context === 'create' ? goalDetailScorerSection : editGoalDetailScorerSection;
            const currentJogadorInput = context === 'create' ? goalDetailJogadorInput : editGoalDetailJogadorInput;
            const currentAssistenciaSection = context === 'create' ? goalDetailAssistenciaSection : editGoalDetailAssistenciaSection;
            const currentAssistenciaInput = context === 'create' ? goalDetailAssistenciaInput : editGoalDetailAssistenciaInput;
            const currentGrid = context === 'create' ? goalZoneGridContainer : editGoalZoneGridContainer;
            const currentHiddenZone = context === 'create' ? selectedGoalZoneHidden : editSelectedGoalZoneHidden;
            const currentTipoGoloSection = context === 'create' ? document.getElementById('goalDetailTipoGoloSection') : document.getElementById('editGoalDetailTipoGoloSection');

            currentTypeInput.value = type; 
            currentMinuteInput.value = minuteEntry.minute;
            // *** INÍCIO DA ALTERAÇÃO ***
            currentIndexInput.value = index; // Guarda o índice do golo no modal
            // *** FIM DA ALTERAÇÃO ***
            currentTitle.textContent = `Detalhes do Golo - Minuto ${minuteEntry.minute} (${type === 'marcado' ? 'Marcado' : 'Sofrido'}) ${context === 'edit' ? '(Editar)' : ''}`;
            
            // ... (o resto da função permanece exatamente igual)
            // ... (rest of the function remains exactly the same)
            currentForm.reset(); 
            currentHiddenZone.value = '';
            currentGrid.querySelectorAll('.goal-zone-cell').forEach(cell => cell.classList.remove('selected'));
            
            [currentJogadorInput, currentAssistenciaInput].forEach(input => {
                input.style.backgroundImage = 'none';
                input.classList.remove('has-image-bg', 'has-clear-btn');
                const clearBtn = input.parentElement.querySelector('.player-input-clear-btn');
                if(clearBtn) clearBtn.style.display = 'none';
            });

            currentJogadorInput.value = minuteEntry.details?.jogadorNome || '';
            if (minuteEntry.details?.jogadorNome && allJogadores.length > 0) {
                const scorerDetails = allJogadores.find(j => j.nome === minuteEntry.details.jogadorNome);
                if (scorerDetails && scorerDetails.imagem_link) {
                    currentJogadorInput.style.backgroundImage = `url('${scorerDetails.imagem_link}')`;
                    currentJogadorInput.classList.add('has-image-bg');
                }
                const jogadorClearBtn = currentJogadorInput.parentElement.querySelector('.player-input-clear-btn');
                if(jogadorClearBtn) { jogadorClearBtn.style.display = 'block'; currentJogadorInput.classList.add('has-clear-btn'); }
            }

            currentAssistenciaInput.value = minuteEntry.details?.assistenciaNome || '';
            if (minuteEntry.details?.assistenciaNome && allJogadores.length > 0) {
                const assisterDetails = allJogadores.find(j => j.nome === minuteEntry.details.assistenciaNome);
                if (assisterDetails && assisterDetails.imagem_link) {
                    currentAssistenciaInput.style.backgroundImage = `url('${assisterDetails.imagem_link}')`;
                    currentAssistenciaInput.classList.add('has-image-bg');
                }
                const assistClearBtn = currentAssistenciaInput.parentElement.querySelector('.player-input-clear-btn');
                if(assistClearBtn) { assistClearBtn.style.display = 'block'; currentAssistenciaInput.classList.add('has-clear-btn');}
            }

            if (minuteEntry.details?.zona) {
                currentHiddenZone.value = minuteEntry.details.zona;
                const preSelected = currentGrid.querySelector(`.goal-zone-cell[data-zone="${minuteEntry.details.zona}"]`);
                if (preSelected) preSelected.classList.add('selected');
            }

            const tipoGoloSelecionado = minuteEntry.details?.tipoGolo || 'Normal';
            const radioGroupName = context === 'create' ? 'tipoGoloCreate' : 'tipoGoloEdit';
            const radioButtonsTipoGolo = currentForm.querySelectorAll(`input[name="${radioGroupName}"]`);

            function handleTipoGoloChangeDisplay() {
                const modalGoalType = currentTypeInput.value; // 'marcado' ou 'sofrido'
                const selectedTipoGoloRadio = currentForm.querySelector(`input[name="${radioGroupName}"]:checked`);
                const tipoDeGoloEfetivo = selectedTipoGoloRadio ? selectedTipoGoloRadio.value : 'Normal';

                if (modalGoalType === 'marcado') {
                    const isAutoGolo = tipoDeGoloEfetivo === 'AutoGolo';
                    const isPenalty = tipoDeGoloEfetivo === 'Penalty';

                    currentScorerSection.style.display = isAutoGolo ? 'none' : 'flex';
                    currentAssistenciaSection.style.display = (isAutoGolo || isPenalty) ? 'none' : 'flex';
                    currentTipoGoloSection.style.display = 'flex';


                    if (isAutoGolo) {
                        currentJogadorInput.value = ''; 
                        currentJogadorInput.style.backgroundImage = 'none';
                        currentJogadorInput.classList.remove('has-image-bg', 'has-clear-btn');
                        const jogadorClearBtn = currentJogadorInput.parentElement.querySelector('.player-input-clear-btn');
                        if(jogadorClearBtn) jogadorClearBtn.style.display = 'none';
                    }
                    if (isAutoGolo || isPenalty) {
                        currentAssistenciaInput.value = ''; 
                        currentAssistenciaInput.style.backgroundImage = 'none';
                        currentAssistenciaInput.classList.remove('has-image-bg', 'has-clear-btn');
                        const assistClearBtn = currentAssistenciaInput.parentElement.querySelector('.player-input-clear-btn');
                        if(assistClearBtn) assistClearBtn.style.display = 'none';
                    }
                } else { // Golo sofrido
                    currentScorerSection.style.display = 'none';
                    currentAssistenciaSection.style.display = 'none';
                    currentTipoGoloSection.style.display = 'flex'; // Ou 'none' se não aplicável a sofridos
                }
            }
            
            radioButtonsTipoGolo.forEach(radio => {
                radio.checked = (radio.value === tipoGoloSelecionado);
                radio.removeEventListener('change', handleTipoGoloChangeDisplay);
                radio.addEventListener('change', handleTipoGoloChangeDisplay);
            });
            
            handleTipoGoloChangeDisplay(); 
            currentModal.style.display = 'block';
        }


        
        closeGoalDetailModalBtn.onclick = () => goalDetailModal.style.display = 'none';
        editCloseGoalDetailModalBtn.onclick = () => editGoalDetailModal.style.display = 'none';
    
        function saveGoalDetailHandler(context) {
            const type = (context === 'create' ? goalDetailTypeInput : editGoalDetailTypeInput).value;
            // Removido: const minute = ...
            let targetArray = context === 'create' 
                ? (type === 'marcado' ? createMinutosGolosMarcados : createMinutosGolosSofridos)
                : (type === 'marcado' ? editMinutosGolosMarcados : editMinutosGolosSofridos);
            const statusElId = context === 'create' ? 'statusJogo' : 'statusEditarJogo';

            // *** INÍCIO DA ALTERAÇÃO ***
            // Em vez de procurar pelo minuto, obtemos o índice guardado e acedemos diretamente ao elemento do array
            const indexToSave = parseInt((context === 'create' ? document.getElementById('goalDetailIndex') : document.getElementById('editGoalDetailIndex')).value);

            if (isNaN(indexToSave) || indexToSave < 0 || indexToSave >= targetArray.length) {
                showStatus(statusElId, 'Erro: referência do golo inválida.', false); 
                return;
            }
            const entry = targetArray[indexToSave];
            const minute = entry.minute; // Obtemos o minuto a partir do registo para a mensagem de status
            // *** FIM DA ALTERAÇÃO ***

            if (!entry) { 
                showStatus(statusElId, 'Erro ao encontrar golo para guardar detalhes.', false); 
                return; 
            }

            const currentForm = context === 'create' ? formGoalDetail : document.getElementById('editFormGoalDetail');
            const radioGroupName = context === 'create' ? 'tipoGoloCreate' : 'tipoGoloEdit';
            const selectedTipoGoloRadio = currentForm.querySelector(`input[name="${radioGroupName}"]:checked`);
            const tipoGoloValue = selectedTipoGoloRadio ? selectedTipoGoloRadio.value : 'Normal';

            entry.details = {
                jogadorNome: (context === 'create' ? goalDetailJogadorInput : editGoalDetailJogadorInput).value.trim() || null,
                zona: (context === 'create' ? selectedGoalZoneHidden : editSelectedGoalZoneHidden).value || null,
                assistenciaNome: (context === 'create' ? goalDetailAssistenciaInput : editGoalDetailAssistenciaInput).value.trim() || null,
                tipoGolo: tipoGoloValue
            };

            if (type === 'marcado') {
                if (tipoGoloValue === 'AutoGolo') {
                    entry.details.jogadorNome = null;
                    entry.details.assistenciaNome = null;
                } else if (tipoGoloValue === 'Penalty') {
                    entry.details.assistenciaNome = null;
                }
            }

            if (entry.details.jogadorNome) {
                const scorer = allJogadores.find(j => j.nome === entry.details.jogadorNome);
                if(scorer) entry.details.jogadorId = scorer.id; else entry.details.jogadorId = null; 
            } else { entry.details.jogadorId = null; }

            if (entry.details.assistenciaNome) {
                const assister = allJogadores.find(j => j.nome === entry.details.assistenciaNome);
                if(assister) entry.details.assistenciaId = assister.id; else entry.details.assistenciaId = null;
            } else { entry.details.assistenciaId = null; }

            showStatus(statusElId, `Detalhes para golo aos ${minute}' guardados.`, true);
            (context === 'create' ? goalDetailModal : editGoalDetailModal).style.display = 'none';
            const listEl = context === 'create' 
                ? (type === 'marcado' ? listaMinutosGolosMarcados : listaMinutosGolosSofridos)
                : (type === 'marcado' ? editListaMinutosGolosMarcados : editListaMinutosGolosSofridos);
            renderMinuteList(listEl, targetArray, type, context);
            updateCalculatedScores(context); 
        }
    
        saveGoalDetailBtn.addEventListener('click', () => saveGoalDetailHandler('create'));
        editSaveGoalDetailBtn.addEventListener('click', () => saveGoalDetailHandler('edit'));
    
        function updateCalculatedScores(context) { 
            const clubeCasaIn = context === 'create' ? jogoClubeCasaInput : editJogoClubeCasaInput;
            const clubeForaIn = context === 'create' ? jogoClubeForaInput : editJogoClubeForaInput;
            const minutosMarcadosArr = context === 'create' ? createMinutosGolosMarcados : editMinutosGolosMarcados;
            const minutosSofridosArr = context === 'create' ? createMinutosGolosSofridos : editMinutosGolosSofridos;
            const nomeJogoOut = context === 'create' ? jogoNomeJogo : editJogoNomeJogo;
            const gmCasaOut = context === 'create' ? jogoGMCasa : editJogoGMCasa;
            const gmForaOut = context === 'create' ? jogoGMFora : editJogoGMFora;
            const gsCasaOut = context === 'create' ? jogoGSCasa : editJogoGSCasa;
            const gsForaOut = context === 'create' ? jogoGSFora : editJogoGSFora;
            const resultadoFinalOut = context === 'create' ? jogoResultadoFinal : editJogoResultadoFinal;
            const marcados1POut = context === 'create' ? jogoMarcados1P : editJogoMarcados1P;
            const marcados2POut = context === 'create' ? jogoMarcados2P : editJogoMarcados2P;
            const sofridos1POut = context === 'create' ? jogoSofridos1P : editJogoSofridos1P;
            const sofridos2POut = context === 'create' ? jogoSofridos2P : editJogoSofridos2P;
            const estadoOut = context === 'create' ? jogoEstado : editJogoEstado;
            const futuroCb = context === 'create' ? jogoFuturoCheckbox : editJogoFuturoCheckbox;
            const casaNomeInput = clubeCasaIn.value.trim();
            const foraNomeInput = clubeForaIn.value.trim();
            const casaNomeLower = casaNomeInput.toLowerCase();
            const foraNomeLower = foraNomeInput.toLowerCase();
            const isSportingCasa = sportingCanonicoNomesInputCheck.includes(casaNomeLower);
            const isSportingFora = sportingCanonicoNomesInputCheck.includes(foraNomeLower);
            const gMarcadosPeloSporting = minutosMarcadosArr.length;
            const gSofridosPeloSporting = minutosSofridosArr.length;
            let gmCasaFinal = 0, gmForaFinal = 0, gsCasaFinal = 0, gsForaFinal = 0;
            if (isSportingCasa) {
                gmCasaFinal = gMarcadosPeloSporting;
                gmForaFinal = gSofridosPeloSporting;
                gsCasaFinal = gSofridosPeloSporting; 
                gsForaFinal = gMarcadosPeloSporting; 
            } else if (isSportingFora) {
                gmCasaFinal = gSofridosPeloSporting;
                gmForaFinal = gMarcadosPeloSporting;
                gsCasaFinal = gMarcadosPeloSporting; 
                gsForaFinal = gSofridosPeloSporting; 
            } 
            gmCasaOut.value = gmCasaFinal;
            gmForaOut.value = gmForaFinal;
            gsCasaOut.value = gsCasaFinal; 
            gsForaOut.value = gsForaFinal; 
            resultadoFinalOut.value = `${gmCasaFinal}-${gmForaFinal}`;
            if (futuroCb.checked) {
                if (casaNomeInput && foraNomeInput) {
                    nomeJogoOut.value = `${casaNomeInput} vs ${foraNomeInput}`;
                } else if (casaNomeInput) {
                    nomeJogoOut.value = `${casaNomeInput} vs ?`;
                } else if (foraNomeInput) {
                    nomeJogoOut.value = `? vs ${foraNomeInput}`;
                } else {
                    nomeJogoOut.value = "";
                }
            } else { 
                 nomeJogoOut.value = (casaNomeInput && foraNomeInput) 
                    ? `${casaNomeInput} ${gmCasaFinal}-${gmForaFinal} ${foraNomeInput}` 
                    : (casaNomeInput ? `${casaNomeInput} vs ?` : (foraNomeInput ? `? vs ${foraNomeInput}`: ""));
            }
            marcados1POut.value = minutosMarcadosArr.filter(g => g.minute <= 45).length;
            marcados2POut.value = minutosMarcadosArr.filter(g => g.minute > 45).length;
            sofridos1POut.value = minutosSofridosArr.filter(g => g.minute <= 45).length;
            sofridos2POut.value = minutosSofridosArr.filter(g => g.minute > 45).length;
            if (!isSportingCasa && !isSportingFora && (casaNomeInput || foraNomeInput)) {
                 estadoOut.value = "N/A (Sporting não joga)";
            } else if (gMarcadosPeloSporting > gSofridosPeloSporting) {
                estadoOut.value = "V (Vitória)";
            } else if (gMarcadosPeloSporting < gSofridosPeloSporting) {
                estadoOut.value = "D (Derrota)";
            } else if (gMarcadosPeloSporting === 0 && gSofridosPeloSporting === 0 && !(casaNomeInput && foraNomeInput)) {
                estadoOut.value = "";
            }
            else {
                estadoOut.value = "E (Empate)";
            }
        }
    
        function setupDynamicPlayerInputs(containerId, numPlayers, rolePrefix, context) { 
            const container = document.getElementById(containerId);
            container.innerHTML = ''; 
            for (let i = 1; i <= numPlayers; i++) {
                const wrapperDiv = document.createElement('div');
                wrapperDiv.classList.add('player-input-wrapper');
                const inputId = `${rolePrefix}_${i}`; 
                const input = document.createElement('input');
                input.type = 'text'; input.id = inputId;
                input.placeholder = `Jogador ${i}`; input.autocomplete = 'off'; 
                input.dataset.playerType = rolePrefix; 
                input.dataset.playerIndex = i;
                const suggId = `sugg_${inputId}`;
                const suggDiv = document.createElement('div');
                suggDiv.id = suggId; suggDiv.classList.add('suggestions-container'); suggDiv.style.display = 'none';
                const clearBtn = document.createElement('span');
                clearBtn.classList.add('player-input-clear-btn'); clearBtn.innerHTML = '×'; clearBtn.style.display = 'none';
                clearBtn.addEventListener('click', function() {
                    input.value = ''; input.style.backgroundImage = 'none';
                    input.classList.remove('has-image-bg', 'has-clear-btn');
                    this.style.display = 'none';
                    input.dispatchEvent(new Event('input', { bubbles: true })); 
                });
                input.addEventListener('input', function() { 
                    if (this.value.trim() !== '') {
                        clearBtn.style.display = 'block'; input.classList.add('has-clear-btn');
                    } else {
                        clearBtn.style.display = 'none'; input.classList.remove('has-clear-btn');
                        input.style.backgroundImage = 'none'; input.classList.remove('has-image-bg');
                    }
                });
                wrapperDiv.appendChild(input); wrapperDiv.appendChild(clearBtn);
                wrapperDiv.appendChild(suggDiv);
                container.appendChild(wrapperDiv);
                if (allJogadores.length > 0) { 
                    const suggestionContext = `${context}_player_${rolePrefix}_${i}`;
                    setupSuggestionHandler(input, suggDiv, () => allJogadores, 'nome', 'imagem_link', clearBtn, suggestionContext);
                    input.setAttribute('data-suggestions-setup', 'true');
                }
            }
        }
        
        document.getElementById('formJogo').addEventListener('submit', async (e) => {
            e.preventDefault(); const statusElId = 'statusJogo';
            const temporada = jogoTemporadaSelect.value;
            const jornada = jogoJornadaSelect.value;
            const clubeCasaNomeForm = jogoClubeCasaInput.value.trim();
            const clubeForaNomeForm = jogoClubeForaInput.value.trim();
            const isSportingCasa = sportingCanonicoNomesInputCheck.includes(clubeCasaNomeForm.toLowerCase());
            const isSportingFora = sportingCanonicoNomesInputCheck.includes(clubeForaNomeForm.toLowerCase());
            if (!temporada || !jornada || !clubeCasaNomeForm || !clubeForaNomeForm) { showStatus(statusElId, 'Temp., Jornada, Clubes obrigatórios.', false); return; }
            if (!isSportingCasa && !isSportingFora) { showStatus(statusElId, `Um dos clubes deve ser '${SPORTING_CP_CANONICAL_NAME}' ou variante.`, false); return; }
            if (clubeCasaNomeForm.toLowerCase() === clubeForaNomeForm.toLowerCase()) { showStatus(statusElId, 'Clubes devem ser diferentes.', false); return; }
            
            const getPlantel = (containerSel) => Array.from(document.querySelectorAll(`${containerSel} input[type="text"]`))
                .map(inp => {
                    const nome = inp.value.trim();
                    if (!nome) return null; 
                    const jogador = allJogadores.find(j => j.nome === nome);
                    return { nome, id: jogador ? jogador.id : null }; 
                }).filter(p => p !== null); 
    
            const jogoData = {
                temporada, jornada: parseInt(jornada),
                nomeJogo: jogoNomeJogo.value, clubeCasaNome: clubeCasaNomeForm, clubeForaNome: clubeForaNomeForm,
                sportingCasa: isSportingCasa,
                golosMarcadosSportingMinutos: createMinutosGolosMarcados.map(g => ({ 
                    minute: g.minute, 
                    details: { ...g.details, goloIdLocal: g.details.goloIdLocal || generateUUID() } // Garante goloIdLocal
                })),
                golosSofridosSportingMinutos: createMinutosGolosSofridos.map(g => ({ 
                    minute: g.minute, 
                    details: { ...g.details, goloIdLocal: g.details.goloIdLocal || generateUUID() } // Garante goloIdLocal
                })),
                resultadoFinal: jogoResultadoFinal.value,
                resultadoGMCasa: parseInt(jogoGMCasa.value) || 0,
                resultadoGMFora: parseInt(jogoGMFora.value) || 0,
                resultadoGSCasa: parseInt(jogoGSCasa.value) || 0, 
                resultadoGSFora: parseInt(jogoGSFora.value) || 0,
                sportingGolosMarcados1P: parseInt(jogoMarcados1P.value) || 0,
                sportingGolosMarcados2P: parseInt(jogoMarcados2P.value) || 0,
                sportingGolosSofridos1P: parseInt(jogoSofridos1P.value) || 0,
                sportingGolosSofridos2P: parseInt(jogoSofridos2P.value) || 0,
                resultadoEstadoSporting: jogoEstado.value,
                onzeInicial: getPlantel('#jogo11InicialContainer'),
                suplentes: getPlantel('#jogoSuplentesContainer'),
                jogoLive: jogoLiveCheckbox.checked,
                jogoTerminado: jogoTerminadoCheckbox.checked,
                jogoFuturo: jogoFuturoCheckbox.checked,
                dataCriacao: serverTimestamp(),
                lastUpdated: serverTimestamp()
            };
            try {
                const docRef = await addDoc(collection(db, "jogos"), jogoData);
                const novoJogoId = docRef.id;
                showStatus(statusElId, `Jogo adicionado ID: ${novoJogoId}! A processar golos...`, true);
    
                // Processar golos marcados para a coleção 'golos'
                for (const golo of jogoData.golosMarcadosSportingMinutos) {
                    let clubeMarcadorNomeCriacao, clubeSofridoNomeCriacao;
                    clubeMarcadorNomeCriacao = SPORTING_CP_CANONICAL_NAME;
                    clubeSofridoNomeCriacao = isSportingCasa ? jogoData.clubeForaNome : jogoData.clubeCasaNome;
    
                    const goloParaFirestoreCriacao = {
                        jogoId: novoJogoId,
                        goloIdLocal: golo.details.goloIdLocal,
                        minuto: golo.minute,
                        tipoGoloEvento: "marcado",
                        clubeMarcadorNome: clubeMarcadorNomeCriacao,
                        clubeSofridoNome: clubeSofridoNomeCriacao,
                        temporada: jogoData.temporada,
                        jornada: jogoData.jornada,
                        detalhes: golo.details,
                        timestamp: serverTimestamp()
                    };
                    try {
                        const goloDocRef = await addDoc(collection(db, "golos"), goloParaFirestoreCriacao);
                        // Atualizar o golo no array local com o goloFirestoreId (opcional, mas bom para consistência)
                        const goloLocalOriginal = createMinutosGolosMarcados.find(gl => gl.details.goloIdLocal === golo.details.goloIdLocal);
                        if (goloLocalOriginal) {
                            goloLocalOriginal.details.goloFirestoreId = goloDocRef.id;
                        }
                    } catch (error) {
                        console.error("Erro ao criar registo de golo marcado em 'golos' para novo jogo:", error);
                    }
                }
    
                // Processar golos sofridos para a coleção 'golos'
                for (const golo of jogoData.golosSofridosSportingMinutos) {
                    let clubeMarcadorNomeCriacao, clubeSofridoNomeCriacao;
                    clubeMarcadorNomeCriacao = isSportingCasa ? jogoData.clubeForaNome : jogoData.clubeCasaNome;
                    clubeSofridoNomeCriacao = SPORTING_CP_CANONICAL_NAME;
                    
                    const goloParaFirestoreCriacao = {
                        jogoId: novoJogoId,
                        goloIdLocal: golo.details.goloIdLocal,
                        minuto: golo.minute,
                        tipoGoloEvento: "sofrido",
                        clubeMarcadorNome: clubeMarcadorNomeCriacao,
                        clubeSofridoNome: clubeSofridoNomeCriacao,
                        temporada: jogoData.temporada,
                        jornada: jogoData.jornada,
                        detalhes: golo.details,
                        timestamp: serverTimestamp()
                    };
                     try {
                        const goloDocRef = await addDoc(collection(db, "golos"), goloParaFirestoreCriacao);
                        const goloLocalOriginal = createMinutosGolosSofridos.find(gl => gl.details.goloIdLocal === golo.details.goloIdLocal);
                        if (goloLocalOriginal) {
                            goloLocalOriginal.details.goloFirestoreId = goloDocRef.id;
                        }
                    } catch (error) {
                        console.error("Erro ao criar registo de golo sofrido em 'golos' para novo jogo:", error);
                    }
                }
                showStatus(statusElId, `Jogo ID: ${novoJogoId} e golos associados criados!`, true);
    
    
                const currentTemporada = jogoTemporadaSelect.value; 
                e.target.reset(); 
                jogoClubeCasaInput.style.backgroundImage = 'none';
                jogoClubeCasaInput.classList.remove('has-image-bg', 'has-clear-btn');
                jogoClubeForaInput.style.backgroundImage = 'none';
                jogoClubeForaInput.classList.remove('has-image-bg', 'has-clear-btn');
                document.querySelectorAll('#jogo11InicialContainer .player-input-wrapper input, #jogoSuplentesContainer .player-input-wrapper input')
                    .forEach(input => {
                        input.style.backgroundImage = 'none';
                        input.classList.remove('has-image-bg', 'has-clear-btn');
                        const clearBtn = input.parentElement.querySelector('.player-input-clear-btn');
                        if(clearBtn) clearBtn.style.display = 'none';
                    });
                createMinutosGolosMarcados = []; createMinutosGolosSofridos = [];
                renderMinuteList(listaMinutosGolosMarcados, createMinutosGolosMarcados, 'marcado', 'create');
                renderMinuteList(listaMinutosGolosSofridos, createMinutosGolosSofridos, 'sofrido', 'create');
                syncGameStatusCheckboxes.call(window, jogoLiveCheckbox, jogoTerminadoCheckbox, jogoFuturoCheckbox); 
                updateCalculatedScores('create'); 
                if (currentTemporada) jogoTemporadaSelect.value = currentTemporada; 
                else jogoTemporadaSelect.value = "";
                await setSuggestedJornada(jogoTemporadaSelect, jogoJornadaSelect, statusElId, jogoTerminadoCheckbox, jogoLiveCheckbox, jogoFuturoCheckbox); 
            } catch (error) { showStatus(statusElId, `Erro ao criar jogo: ${error.message}`, false); console.error(error); }
        });
    
        async function handleEditTemporadaChange() {
            const selectedTemporada = editJogoTemporadaSelect.value;
            editJogoSearchInput.value = '';
            editJogoSuggestionsContainer.innerHTML = '';
            editJogoSuggestionsContainer.style.display = 'none';
            editJogoFormContainer.style.display = 'none'; 
            currentEditingGameData = null;
            editJogoDocIdInput.value = '';
            if (!selectedTemporada) {
                editJogoSearchInput.disabled = true;
                loadedGamesForSeason = [];
                return;
            }
            editJogoSearchInput.disabled = false;
            editJogoSearchInput.placeholder = "A carregar jogos da temporada...";
            try {
                const q = query(collection(db, "jogos"), where("temporada", "==", selectedTemporada));
                const querySnapshot = await getDocs(q);
                loadedGamesForSeason = [];
                querySnapshot.forEach(doc => {
                    loadedGamesForSeason.push({ id: doc.id, ...doc.data() });
                });
                loadedGamesForSeason.sort((a,b) => (a.nomeJogo || "").localeCompare(b.nomeJogo || "")); 
                editJogoSearchInput.placeholder = "Digite para pesquisar jogos...";
                 if (!editJogoSearchInput.getAttribute('data-suggestions-setup')) {
                    setupSuggestionHandler(editJogoSearchInput, editJogoSuggestionsContainer, () => loadedGamesForSeason, 'nomeJogo', null, null, 'edit-game-search');
                    editJogoSearchInput.setAttribute('data-suggestions-setup', 'true');
                } 
            } catch (error) {
                console.error("Erro ao carregar jogos para edição:", error);
                showStatus('statusEditarJogo', 'Erro ao carregar jogos da temporada.', false);
                editJogoSearchInput.placeholder = "Erro ao carregar. Tente outra temporada.";
                loadedGamesForSeason = [];
            }
        }
        
        function handleEditJogoSearch() { /* Handled by setupSuggestionHandler */ }
    
        async function loadGameForEditing(gameId) {
            showStatus('statusEditarJogo', 'A carregar dados do jogo...', true);
            editJogoFormContainer.style.display = 'none'; 
            try {
                const gameDocRef = doc(db, "jogos", gameId);
                const docSnap = await getDoc(gameDocRef);
                if (docSnap.exists()) {
                    currentEditingGameData = { id: docSnap.id, ...docSnap.data() };
                    
                    // Carregar golos da coleção 'golos' associados a este jogo
                    const golosQuery = query(collection(db, "golos"), where("jogoId", "==", gameId));
                    const golosSnapshot = await getDocs(golosQuery);
                    
                    // Limpar listas de golos atuais antes de popular com dados do jogo e da coleção 'golos'
                    editMinutosGolosMarcados = [];
                    editMinutosGolosSofridos = [];
    
                    // Popular com base nos dados da coleção 'golos' primeiro (mais autoritário)
                    golosSnapshot.forEach(goloDoc => {
                        const goloData = goloDoc.data();
                        const goloParaArray = {
                            minute: goloData.minuto,
                            details: {
                                ...goloData.detalhes,
                                goloFirestoreId: goloDoc.id, // Importante para saber que já existe
                                goloIdLocal: goloData.goloIdLocal || generateUUID() // Usa o local ou gera um novo
                            }
                        };
                        if (goloData.tipoGoloEvento === 'marcado') {
                            editMinutosGolosMarcados.push(goloParaArray);
                        } else if (goloData.tipoGoloEvento === 'sofrido') {
                            editMinutosGolosSofridos.push(goloParaArray);
                        }
                    });
    
                    // Se houver golos no documento do jogo que não estão na coleção 'golos' (migração/backup)
                    // Poderíamos adicionar uma lógica aqui para sincronizá-los, mas por agora focamos na coleção 'golos' como fonte principal
                    // quando os dados são carregados para edição.
    
                    // Ordenar
                    editMinutosGolosMarcados.sort((a,b) => a.minute - b.minute);
                    editMinutosGolosSofridos.sort((a,b) => a.minute - b.minute);
    
    
                    populateEditForm(currentEditingGameData); // populateEditForm usará as listas agora preenchidas
                    editJogoFormContainer.style.display = 'block'; 
                    showStatus('statusEditarJogo', `Jogo "${currentEditingGameData.nomeJogo || gameId}" carregado. Pode editar.`, true);
                } else {
                    showStatus('statusEditarJogo', 'Jogo não encontrado.', false);
                    currentEditingGameData = null;
                }
            } catch (error) {
                console.error("Erro ao carregar jogo para edição:", error);
                showStatus('statusEditarJogo', 'Erro ao carregar detalhes do jogo.', false);
                currentEditingGameData = null;
            }
        }
    
        function populateEditForm(gameData) {
            formEditarJogo.reset(); 
            editJogoDocIdInput.value = gameData.id;
            editJogoTemporadaDisplay.value = gameData.temporada;
            editJogoJornadaSelect.value = gameData.jornada ? gameData.jornada.toString() : "";
            editJogoClubeCasaInput.value = gameData.clubeCasaNome || "";
            const casaClub = allClubes.find(c => c.nome === gameData.clubeCasaNome);
            if (casaClub && casaClub.logo) {
                editJogoClubeCasaInput.style.backgroundImage = `url('${casaClub.logo}')`;
                editJogoClubeCasaInput.classList.add('has-image-bg');
            } else {
                editJogoClubeCasaInput.style.backgroundImage = 'none';
                editJogoClubeCasaInput.classList.remove('has-image-bg');
            }
            editJogoClubeCasaInput.dispatchEvent(new Event('input', {bubbles: true})); 
            editJogoClubeForaInput.value = gameData.clubeForaNome || "";
            const foraClub = allClubes.find(c => c.nome === gameData.clubeForaNome);
            if (foraClub && foraClub.logo) {
                editJogoClubeForaInput.style.backgroundImage = `url('${foraClub.logo}')`;
                editJogoClubeForaInput.classList.add('has-image-bg');
            } else {
                editJogoClubeForaInput.style.backgroundImage = 'none';
                editJogoClubeForaInput.classList.remove('has-image-bg');
            }
             editJogoClubeForaInput.dispatchEvent(new Event('input', {bubbles: true})); 
            
            // As listas editMinutosGolosMarcados/Sofridos já devem estar populadas por loadGameForEditing
            renderMinuteList(editListaMinutosGolosMarcados, editMinutosGolosMarcados, 'marcado', 'edit');
            renderMinuteList(editListaMinutosGolosSofridos, editMinutosGolosSofridos, 'sofrido', 'edit');
    
            editJogoLiveCheckbox.checked = gameData.jogoLive || false;
            editJogoTerminadoCheckbox.checked = gameData.jogoTerminado || false;
            editJogoFuturoCheckbox.checked = gameData.jogoFuturo || false;
            syncGameStatusCheckboxes.call(window, editJogoLiveCheckbox, editJogoTerminadoCheckbox, editJogoFuturoCheckbox);
            setupDynamicPlayerInputs('editJogo11InicialContainer', 11, 'edit_inicial', 'edit');
            setupDynamicPlayerInputs('editJogoSuplentesContainer', 11, 'edit_suplente', 'edit');
            populatePlayerListInputs('#editJogo11InicialContainer input', gameData.onzeInicial || []);
            populatePlayerListInputs('#editJogoSuplentesContainer input', gameData.suplentes || []);
            updateCalculatedScores('edit'); 
            const editPlacarStatsContent = document.querySelector('#editFieldsetPlacarStats .toggle-content');
            const editPlacarStatsIndicator = document.querySelector('#editLegendPlacarStats .toggle-indicator');
            const editPlacarStatsFieldset = document.getElementById('editFieldsetPlacarStats');
            if (editPlacarStatsContent && editPlacarStatsContent.style.display === 'none') {
                editPlacarStatsContent.style.display = 'block';
                if(editPlacarStatsIndicator) editPlacarStatsIndicator.textContent = '[-]';
                if(editPlacarStatsFieldset) editPlacarStatsFieldset.classList.add('open');
            }
        }
        
        function populatePlayerListInputs(selector, playersData) {
            const inputs = document.querySelectorAll(selector);
            inputs.forEach((input, index) => {
                const playerData = playersData[index];
                if (playerData && playerData.nome) {
                    input.value = playerData.nome;
                    const jogadorInfo = allJogadores.find(j => j.nome === playerData.nome || j.id === playerData.id);
                    if (jogadorInfo && jogadorInfo.imagem_link) {
                        input.style.backgroundImage = `url('${jogadorInfo.imagem_link}')`;
                        input.classList.add('has-image-bg');
                    }
                    input.dispatchEvent(new Event('input', { bubbles: true }));
                } else {
                    input.value = '';
                    input.style.backgroundImage = 'none';
                    input.classList.remove('has-image-bg');
                     input.dispatchEvent(new Event('input', { bubbles: true }));
                }
            });
        }
    
        formEditarJogo.addEventListener('submit', async (e) => {
            e.preventDefault();
            const statusElId = 'statusEditarJogo';
            const gameDocId = editJogoDocIdInput.value;
            if (!gameDocId) {
                showStatus(statusElId, 'Nenhum jogo selecionado para atualizar.', false);
                return;
            }
            const temporada = editJogoTemporadaDisplay.value; 
            const jornada = editJogoJornadaSelect.value;
            const clubeCasaNome = editJogoClubeCasaInput.value.trim();
            const clubeForaNome = editJogoClubeForaInput.value.trim();
            const isSportingCasa = sportingCanonicoNomesInputCheck.includes(clubeCasaNome.toLowerCase());
            const isSportingFora = sportingCanonicoNomesInputCheck.includes(clubeForaNome.toLowerCase());

            if (!temporada || !jornada || !clubeCasaNome || !clubeForaNome) { showStatus(statusElId, 'Temp., Jornada, Clubes obrigatórios.', false); return; }
            if (!isSportingCasa && !isSportingFora) { showStatus(statusElId, `Um dos clubes deve ser '${SPORTING_CP_CANONICAL_NAME}' ou variante.`, false); return; }
            if (clubeCasaNome.toLowerCase() === clubeForaNome.toLowerCase()) { showStatus(statusElId, 'Clubes devem ser diferentes.', false); return; }

            // *** INÍCIO DA ALTERAÇÃO ***
            // Função getPlantel mais robusta para evitar valores 'undefined'
            const getPlantel = (containerSel) => {
                return Array.from(document.querySelectorAll(`${containerSel} input[type="text"]`))
                    .map(inp => {
                        const nome = inp.value.trim();
                        if (!nome) return null;

                        let id = null;
                        const jogadorGlobal = allJogadores.find(j => j.nome === nome);

                        if (jogadorGlobal && jogadorGlobal.id) {
                            id = jogadorGlobal.id;
                        } else {
                            // Se não encontrar na lista global, tenta encontrar nos dados originais do jogo
                            const jogadorOriginal = (currentEditingGameData?.onzeInicial || []).find(p => p.nome === nome) || 
                                                  (currentEditingGameData?.suplentes || []).find(p => p.nome === nome);
                            if (jogadorOriginal && jogadorOriginal.id) {
                                id = jogadorOriginal.id;
                            }
                        }
                        // Garante que o ID é sempre uma string ou null
                        return { nome, id }; 
                    }).filter(p => p !== null);
            };
            // *** FIM DA ALTERAÇÃO ***

            const updatedJogoData = {
                temporada, jornada: parseInt(jornada),
                nomeJogo: editJogoNomeJogo.value, clubeCasaNome, clubeForaNome,
                sportingCasa: isSportingCasa,
                golosMarcadosSportingMinutos: editMinutosGolosMarcados.map(g => ({ minute: g.minute, details: g.details || {} })),
                golosSofridosSportingMinutos: editMinutosGolosSofridos.map(g => ({ minute: g.minute, details: g.details || {} })),
                resultadoFinal: editJogoResultadoFinal.value,
                resultadoGMCasa: parseInt(editJogoGMCasa.value) || 0,
                resultadoGMFora: parseInt(editJogoGMFora.value) || 0,
                resultadoGSCasa: parseInt(editJogoGSCasa.value) || 0,
                resultadoGSFora: parseInt(editJogoGSFora.value) || 0,
                sportingGolosMarcados1P: parseInt(editJogoMarcados1P.value) || 0,
                sportingGolosMarcados2P: parseInt(editJogoMarcados2P.value) || 0,
                sportingGolosSofridos1P: parseInt(editJogoSofridos1P.value) || 0,
                sportingGolosSofridos2P: parseInt(editJogoSofridos2P.value) || 0,
                resultadoEstadoSporting: editJogoEstado.value,
                onzeInicial: getPlantel('#editJogo11InicialContainer'),
                suplentes: getPlantel('#editJogoSuplentesContainer'),
                jogoLive: editJogoLiveCheckbox.checked,
                jogoTerminado: editJogoTerminadoCheckbox.checked,
                jogoFuturo: editJogoFuturoCheckbox.checked,
                lastUpdated: serverTimestamp()
            };

            try {
                const gameDocRef = doc(db, "jogos", gameDocId);
                await updateDoc(gameDocRef, updatedJogoData); 
                showStatus(statusElId, `Jogo "${updatedJogoData.nomeJogo}" atualizado com sucesso!`, true);
                const currentSelectedTemporada = editJogoTemporadaSelect.value;
                handleEditTemporadaChange(); 
                if (currentSelectedTemporada) { 
                    editJogoTemporadaSelect.value = currentSelectedTemporada; 
                    editJogoSearchInput.disabled = false; 
                    await displayRelevantGames(); 
                } else { 
                    editJogoSearchInput.value = '';
                    editJogoSearchInput.disabled = true;
                }
            } catch (error) { showStatus(statusElId, `Erro ao atualizar jogo: ${error.message}`, false); console.error(error); }
        });
    </script>
</body>
</html>
